<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title id="pageTitle">CRACKUZU</title>
  <style>
    :root {
      --bg0: #0b0e12;
      --bg1: #10151b;
      --glass: rgba(255,255,255,.065);
      --glass2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.11);
      --stroke2: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --outer: clamp(14px, 2.2vw, 26px);
      --gap: clamp(12px, 1.2vw, 18px);
      --pad: clamp(14px, 1.6vw, 20px);
      --r-xl: clamp(18px, 2vw, 26px);
      --r-md: clamp(14px, 1.5vw, 18px);
      --shadow: 0 28px 90px rgba(0,0,0,.58);
      --shadow2: 0 18px 46px rgba(0,0,0,.45);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1100px 700px at 15% 0%, rgba(255,255,255,.09), transparent 55%),
                  radial-gradient(950px 600px at 90% 20%, rgba(255,255,255,.07), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .glass {
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }
    @supports (-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px)) {
      .glass { -webkit-backdrop-filter: blur(14px); backdrop-filter: blur(14px); }
    }
    .page-container { height: 100vh; height: 100dvh; padding: var(--outer); overflow: hidden; }
    .detail-wrapper {
      height: calc(100dvh - 2 * var(--outer));
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .detail-header {
      padding: var(--pad);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--gap);
      min-height: clamp(70px, 8vh, 90px);
      z-index: 10;
    }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.085);
      color: var(--text);
      text-decoration: none;
      font-size: clamp(13px, 1.1vw, 14px);
      transition: all .2s ease;
      cursor: pointer;
    }
    .back-btn:hover {
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.25);
      transform: translateX(-2px);
    }
    /* ‚úÖ CORRIG√â : Titre centr√© */
    .game-title-header {
      font-size: clamp(20px, 2.5vw, 32px);
      font-weight: 300;
      letter-spacing: 1px;
      margin: 0;
      text-align: center;
      flex: 1;
    }
    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--pad);
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: clamp(24px, 3vw, 48px);
      align-items: start;
    }
    .cover-section { position: sticky; top: 0; }
    .game-cover {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: var(--r-md);
      overflow: hidden;
      border: 1px solid var(--stroke2);
      box-shadow: var(--shadow);
      margin-bottom: clamp(16px, 2vw, 24px);
      position: relative;
      background: linear-gradient(135deg, rgba(20,25,35,.8), rgba(10,15,25,.9));
    }
    .game-cover img { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      display: block;
      transition: opacity 0.3s ease;
    }
    .game-cover.loading img {
      opacity: 0.5;
      filter: blur(4px);
    }
    .game-cover::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 60%, rgba(0,0,0,.4));
      pointer-events: none;
    }
    .info-card {
      border-radius: var(--r-md);
      padding: clamp(16px, 2vw, 22px);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
    }
    .info-card h3 {
      margin: 0 0 12px;
      font-size: clamp(16px, 1.6vw, 20px);
      font-weight: 520;
      letter-spacing: .8px;
      color: rgba(255,255,255,.86);
    }
    .info-item {
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .info-item:last-child { border-bottom: none; }
    .info-label { color: var(--muted); font-size: clamp(12px, 1.05vw, 14px); letter-spacing: .5px; }
    .info-value { color: var(--text); font-size: clamp(13px, 1.1vw, 15px); font-weight: 500; }
    .content-section h2 {
      margin: 0 0 clamp(14px, 1.8vw, 20px);
      font-size: clamp(22px, 2.2vw, 28px);
      font-weight: 300;
      letter-spacing: 1.2px;
      color: rgba(255,255,255,.88);
      padding-bottom: 10px;
      border-bottom: 1px solid var(--stroke);
    }
    .description-box {
      border-radius: var(--r-md);
      padding: clamp(18px, 2.2vw, 26px);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      margin-bottom: clamp(24px, 3vw, 36px);
      line-height: 1.7;
      font-size: clamp(13px, 1.15vw, 15px);
      color: rgba(255,255,255,.82);
    }
    .description-box p { margin: 0 0 12px; }
    .description-box p:last-child { margin-bottom: 0; }
    .loading-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-style: italic;
    }
    .trailer-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      border-radius: var(--r-md);
      overflow: hidden;
      border: 1px solid var(--stroke2);
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.3);
    }
    .trailer-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
    .error-message {
      padding: 20px;
      border-radius: var(--r-md);
      background: rgba(255,100,100,.1);
      border: 1px solid rgba(255,100,100,.3);
      color: rgba(255,150,150,.9);
      text-align: center;
      font-size: clamp(13px, 1.1vw, 14px);
    }
    
    /* ‚úÖ Section t√©l√©chargement */
    .download-section {
      margin-top: 24px;
      text-align: center;
    }
    
    .big-download-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 18px 24px;
      border-radius: var(--r-md);
      border: 1px solid rgba(100,200,255,.3);
      background: linear-gradient(135deg, rgba(100,180,255,.15), rgba(150,100,255,.10));
      color: white;
      text-decoration: none;
      font-size: clamp(16px, 1.4vw, 18px);
      font-weight: 600;
      letter-spacing: .5px;
      transition: all 0.25s ease;
      box-shadow: 0 8px 32px rgba(0,0,0,.3);
    }
    
    .big-download-btn:hover {
      background: linear-gradient(135deg, rgba(100,180,255,.25), rgba(150,100,255,.20));
      border-color: rgba(100,200,255,.5);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(100,180,255,.4);
    }
    
    .big-download-btn svg {
      width: 24px;
      height: 24px;
    }
    
    .magnet-info {
      margin-top: 10px;
      color: rgba(255,255,255,.5);
      font-size: 12px;
      letter-spacing: .3px;
    }
    
    /* ‚úÖ Loading spinner pour cover */
    .cover-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,.1);
      border-top-color: rgba(100,180,255,.8);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    @media (max-width: 1200px) {
      .detail-content { grid-template-columns: 1fr; }
      .cover-section {
        position: static;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
      }
      .game-cover { margin-bottom: 0; }
    }
    @media (max-width: 768px) {
      .detail-header { 
        flex-wrap: wrap; 
        justify-content: center; 
      }
      .back-btn { order: 1; }
      .game-title-header { 
        width: 100%; 
        order: 2; 
        margin: 12px 0; 
      }
      .cover-section { grid-template-columns: 1fr; }
    }
    .detail-content::-webkit-scrollbar { width: 10px; }
    .detail-content::-webkit-scrollbar-track { background: rgba(255,255,255,.03); border-radius: 10px; }
    .detail-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 10px; }
    .detail-content::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,.22); }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="detail-wrapper glass">
      <div class="detail-header">
        <a href="index.html" class="back-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Retour
        </a>
        <h1 class="game-title-header" id="gameTitle">Chargement...</h1>
        <!-- Espace vide pour √©quilibrer -->
        <div style="width: 100px; visibility: hidden;"></div>
      </div>
      <div class="detail-content">
        <div class="cover-section">
          <div class="game-cover" id="gameCoverContainer">
            <div class="cover-loading" id="coverLoading"></div>
            <img id="gameCoverImg" src="" alt="Game Cover">
          </div>
          
          <div class="download-section">
            <a href="#" class="big-download-btn" id="gameDownloadBtn" style="display:none;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              <span>T√©l√©charger via Torrent</span>
            </a>
            <div class="magnet-info">
              <small>Format: Magnet Link ‚Ä¢ Utilise un client torrent</small>
            </div>
          </div>
          
          <div class="info-card">
            <h3>Informations</h3>
            <div class="info-item">
              <span class="info-label">Cat√©gorie</span>
              <span class="info-value" id="gameCategory">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Source</span>
              <span class="info-value">CRACKUZU</span>
            </div>
            <div class="info-item">
              <span class="info-label">Format</span>
              <span class="info-value">Torrent Magnet</span>
            </div>
          </div>
        </div>
        <div class="content-section">
          <h2>Description</h2>
          <div id="descriptionContent" class="loading-state">Chargement de la description...</div>
          <h2>Bande-annonce</h2>
          <div id="trailerContent" class="loading-state">Recherche du trailer...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‚ö†Ô∏è CONFIGURE TON WORKER ICI
    const WORKER_URL = 'https://crackuzu-api.crackuzu.workers.dev';

    const urlParams = new URLSearchParams(window.location.search);
    const gameName = urlParams.get('game');
    if (!gameName) window.location.href = 'index.html';

    let currentGame = null;

    // Traduction gratuite Google Translate
    async function translateText(text, targetLang = 'fr') {
      try {
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data && data[0]) return data[0].map(item => item[0]).join('');
        return text;
      } catch (error) {
        console.error('Translation error:', error);
        return text;
      }
    }

    // ‚úÖ NOUVELLE FONCTION : Fetch cover 16:9
    async function fetchGameCover(gameName) {
      const coverContainer = document.getElementById('gameCoverContainer');
      const coverImg = document.getElementById('gameCoverImg');
      const coverLoading = document.getElementById('coverLoading');
      
      // Afficher le loading
      coverContainer.classList.add('loading');
      coverLoading.style.display = 'block';
      
      try {
        // Essaie d'abord l'API worker pour une cover 16:9
        const response = await fetch(`${WORKER_URL}/api/cover?game=${encodeURIComponent(gameName)}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.coverUrl) {
            // Utilise la cover 16:9 de l'API
            coverImg.src = data.coverUrl;
            coverImg.onload = () => {
              coverContainer.classList.remove('loading');
              coverLoading.style.display = 'none';
            };
            coverImg.onerror = () => {
              // Fallback sur l'image de data.json si l'API √©choue
              loadFallbackCover();
            };
            return;
          }
        }
        
        // Fallback sur l'image de data.json
        loadFallbackCover();
        
      } catch (error) {
        console.error('Error fetching cover:', error);
        loadFallbackCover();
      }
      
      function loadFallbackCover() {
        if (currentGame && currentGame.cover) {
          coverImg.src = currentGame.cover;
          coverContainer.classList.remove('loading');
          coverLoading.style.display = 'none';
        }
      }
    }

    async function loadGameData() {
      try {
        const response = await fetch('data.json');
        const data = await response.json();
        currentGame = data.games.find(g => g.name.toLowerCase() === gameName.toLowerCase());
        if (!currentGame) throw new Error('Game not found');

        document.getElementById('pageTitle').textContent = `${currentGame.name} - CRACKUZU`;
        document.getElementById('gameTitle').textContent = currentGame.name;
        document.getElementById('gameCategory').textContent = currentGame.cat.toUpperCase();

        // ‚úÖ Fetch cover 16:9 via API
        fetchGameCover(currentGame.name);

        // Bouton t√©l√©chargement
        const downloadBtn = document.getElementById('gameDownloadBtn');
        downloadBtn.href = currentGame.magnet;
        downloadBtn.style.display = 'inline-flex';

        fetchSynopsis(currentGame.name);
        fetchTrailer(currentGame.name);
      } catch (error) {
        console.error('Error loading game data:', error);
        document.getElementById('gameTitle').textContent = 'Erreur';
        document.getElementById('descriptionContent').innerHTML = 
          '<div class="error-message">Impossible de charger les donn√©es du jeu.</div>';
      }
    }

    async function fetchSynopsis(gameName) {
      const descContainer = document.getElementById('descriptionContent');
      try {
        const response = await fetch(`${WORKER_URL}/api/synopsis?game=${encodeURIComponent(gameName)}`);
        if (!response.ok) throw new Error('Worker request failed');

        const data = await response.json();
        if (data.synopsis) {
          descContainer.innerHTML = '<div class="loading-state">Traduction en cours...</div>';
          const synopsisFR = await translateText(data.synopsis, 'fr');
          
          let extraInfo = '';
          if (data.rating || data.released || data.genres) {
            extraInfo = '<p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,.08);">';
            if (data.released) extraInfo += `<strong>üìÖ Sortie :</strong> ${data.released}<br>`;
            if (data.rating) extraInfo += `<strong>‚≠ê Note :</strong> ${data.rating}/5<br>`;
            if (data.genres) extraInfo += `<strong>üéÆ Genres :</strong> ${data.genres}`;
            extraInfo += '</p>';
          }

          descContainer.innerHTML = `
            <div class="description-box">
              <p>${synopsisFR}</p>
              ${extraInfo}
              <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,.08); font-size: 12px; opacity: 0.7;">
                <em>Source: <a href="${data.url}" target="_blank" style="color: rgba(100,180,255,.8); text-decoration: none;">${data.source}</a></em>
              </p>
            </div>
          `;
          return;
        }
        throw new Error('No synopsis found');
      } catch (error) {
        console.error('Error fetching synopsis:', error);
        descContainer.innerHTML = `
          <div class="description-box">
            <p><strong>${gameName}</strong> est disponible au t√©l√©chargement via CRACKUZU.</p>
            <p>Pour t√©l√©charger ce jeu, cliquez sur le bouton "T√©l√©charger via Torrent" ci-dessus.</p>
          </div>
        `;
      }
    }

    async function fetchTrailer(gameName) {
      const trailerContainer = document.getElementById('trailerContent');
      
      try {
        const searchQuery = `${gameName} game`;
        console.log('Fetching trailer for:', gameName);
        
        const response = await fetch(`${WORKER_URL}/api/youtube?q=${encodeURIComponent(searchQuery)}`);
        const responseText = await response.text();
        
        console.log('Trailer API response status:', response.status);
        console.log('Trailer API response:', responseText.substring(0, 200));
        
        if (!response.ok) {
          throw new Error(`Worker returned ${response.status}`);
        }

        const data = JSON.parse(responseText);
        
        if (data.videoId) {
          trailerContainer.innerHTML = `
            <div class="trailer-container">
              <iframe 
                src="https://www.youtube-nocookie.com/embed/${data.videoId}?rel=0&modestbranding=1&autoplay=0"
                title="Trailer ${gameName}"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                loading="lazy">
              </iframe>
            </div>
            <div style="margin-top: 12px; text-align: center; color: rgba(255,255,255,.6); font-size: 13px;">
              <a href="https://www.youtube.com/watch?v=${data.videoId}" target="_blank" 
                 style="color: rgba(100,180,255,.8); text-decoration: none;">
                üì∫ Ouvrir sur YouTube
              </a>
            </div>
          `;
          return;
        }
        
        // Si pas de videoId, afficher le fallback am√©lior√©
        showTrailerFallback(gameName);
        
      } catch (error) {
        console.error('Error fetching trailer:', error);
        showTrailerFallback(gameName);
      }
    }

    function showTrailerFallback(gameName) {
      const trailerContainer = document.getElementById('trailerContent');
      const searchQuery2 = encodeURIComponent(`${gameName} game trailer official`);
      
      trailerContainer.innerHTML = `
        <div style="padding: 40px 20px; text-align: center; border-radius: var(--r-md); border: 1px solid var(--stroke); background: rgba(255,255,255,.04);">
          <div style="margin-bottom: 20px;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <polygon points="10 8 16 12 10 16 10 8"></polygon>
            </svg>
          </div>
          <p style="color: var(--muted); margin-bottom: 16px; font-size: 15px;">
            Trailer non disponible directement
          </p>
          <p style="color: rgba(255,255,255,.5); margin-bottom: 24px; font-size: 13px;">
            Recherchez manuellement sur YouTube
          </p>
          <a href="https://www.youtube.com/results?search_query=${searchQuery2}" target="_blank" 
             class="big-download-btn" style="display: inline-flex; padding: 12px 24px; font-size: 14px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
              <circle cx="12" cy="12" r="10"></circle>
              <polygon points="10 8 16 12 10 16 10 8"></polygon>
            </svg>
            üîç Rechercher sur YouTube
          </a>
          <div style="margin-top: 16px; color: rgba(255,255,255,.4); font-size: 12px;">
            API YouTube limit√©e ‚Ä¢ Essayez manuellement
          </div>
        </div>
      `;
    }

    loadGameData();
  </script>
</body>
</html>