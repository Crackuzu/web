<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title id="pageTitle">CRACKUZU</title>
  <style>
    :root {
      --bg0: #0b0e12;
      --bg1: #10151b;
      --glass: rgba(255,255,255,.065);
      --glass2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.11);
      --stroke2: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --outer: clamp(14px, 2.2vw, 26px);
      --gap: clamp(12px, 1.2vw, 18px);
      --pad: clamp(14px, 1.6vw, 20px);
      --r-xl: clamp(18px, 2vw, 26px);
      --r-md: clamp(14px, 1.5vw, 18px);
      --shadow: 0 28px 90px rgba(0,0,0,.58);
      --shadow2: 0 18px 46px rgba(0,0,0,.45);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1100px 700px at 15% 0%, rgba(255,255,255,.09), transparent 55%),
                  radial-gradient(950px 600px at 90% 20%, rgba(255,255,255,.07), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .glass {
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }
    @supports (-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px)) {
      .glass { -webkit-backdrop-filter: blur(14px); backdrop-filter: blur(14px); }
    }
    .page-container { height: 100vh; height: 100dvh; padding: var(--outer); overflow: hidden; }
    .detail-wrapper {
      height: calc(100dvh - 2 * var(--outer));
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .detail-header {
      padding: var(--pad);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--gap);
      min-height: clamp(70px, 8vh, 90px);
      z-index: 10;
    }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.085);
      color: var(--text);
      text-decoration: none;
      font-size: clamp(13px, 1.1vw, 14px);
      transition: all .2s ease;
      cursor: pointer;
    }
    .back-btn:hover {
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.25);
      transform: translateX(-2px);
    }
    .game-title-header {
      font-size: clamp(20px, 2.5vw, 32px);
      font-weight: 300;
      letter-spacing: 1px;
      margin: 0;
      text-align: center;
      flex: 1;
    }
    
    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--pad);
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: clamp(24px, 3vw, 48px);
      align-items: start;
    }
    .cover-section { position: sticky; top: 0; }
    .game-cover {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: var(--r-md);
      overflow: hidden;
      border: 1px solid var(--stroke2);
      box-shadow: var(--shadow);
      margin-bottom: clamp(16px, 2vw, 24px);
      position: relative;
      background: linear-gradient(135deg, rgba(20,25,35,.8), rgba(10,15,25,.9));
    }
    .game-cover img { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      display: block;
      transition: opacity 0.3s ease;
    }
    .game-cover.loading img {
      opacity: 0.5;
      filter: blur(4px);
    }
    .game-cover::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 60%, rgba(0,0,0,.4));
      pointer-events: none;
    }
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: rgba(255,255,255,.6);
      font-size: 14px;
    }
    .info-card {
      border-radius: var(--r-md);
      padding: clamp(16px, 2vw, 22px);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
    }
    .info-card h3 {
      margin: 0 0 12px;
      font-size: clamp(16px, 1.6vw, 20px);
      font-weight: 520;
      letter-spacing: .8px;
      color: rgba(255,255,255,.86);
    }
    .info-item {
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .info-item:last-child { border-bottom: none; }
    .info-label { color: var(--muted); font-size: clamp(12px, 1.05vw, 14px); letter-spacing: .5px; }
    .info-value { 
      color: var(--text); 
      font-size: clamp(13px, 1.1vw, 15px); 
      font-weight: 500;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }
    
    /* ‚ú® Cat√©gories dans la section info */
    .game-cat-pill {
      font-size: clamp(10px, 0.9vw, 12px);
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.80);
      letter-spacing: .8px;
      display: inline-block;
    }
    
    .content-section h2 {
      margin: 0 0 clamp(14px, 1.8vw, 20px);
      font-size: clamp(22px, 2.2vw, 28px);
      font-weight: 300;
      letter-spacing: 1.2px;
      color: rgba(255,255,255,.88);
      padding-bottom: 10px;
      border-bottom: 1px solid var(--stroke);
    }
    .description-box {
      border-radius: var(--r-md);
      padding: clamp(18px, 2.2vw, 26px);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      margin-bottom: clamp(24px, 3vw, 36px);
      line-height: 1.7;
      font-size: clamp(13px, 1.15vw, 15px);
      color: rgba(255,255,255,.82);
    }
    .description-box p { margin: 0 0 12px; }
    .description-box p:last-child { margin-bottom: 0; }
    .loading-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-style: italic;
    }
    .trailer-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      border-radius: var(--r-md);
      overflow: hidden;
      border: 1px solid var(--stroke2);
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.3);
    }
    .trailer-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
    .error-message {
      padding: 20px;
      border-radius: var(--r-md);
      background: rgba(255,100,100,.1);
      border: 1px solid rgba(255,100,100,.3);
      color: rgba(255,150,150,.9);
      text-align: center;
      font-size: clamp(13px, 1.1vw, 14px);
    }
    .big-download-btn {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 14px 28px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(100,140,255,.22), rgba(80,120,240,.18));
      border: 1px solid rgba(100,140,255,.35);
      color: rgba(255,255,255,.95);
      font-size: clamp(14px, 1.2vw, 16px);
      font-weight: 600;
      letter-spacing: .6px;
      text-decoration: none;
      transition: all .25s ease;
      box-shadow: 0 8px 24px rgba(100,140,255,.2);
    }
    .big-download-btn:hover {
      background: linear-gradient(135deg, rgba(100,140,255,.3), rgba(80,120,240,.25));
      border-color: rgba(100,140,255,.5);
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(100,140,255,.3);
    }
    .big-download-btn svg {
      width: 20px;
      height: 20px;
    }
    @media (max-width: 1024px) {
      .detail-content {
        grid-template-columns: 1fr;
      }
      .cover-section {
        position: static;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="detail-wrapper glass">
      <div class="detail-header">
        <a href="index.html" class="back-btn">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Retour
        </a>
        <h1 class="game-title-header" id="gameTitle">Chargement...</h1>
        <div style="width: 100px;"></div>
      </div>

      <div class="detail-content">
        <div class="cover-section">
          <div class="game-cover" id="gameCoverContainer">
            <img id="gameCoverImg" src="" alt="Game Cover" />
            <div class="loading-indicator" id="coverLoading" style="display: none;">Chargement...</div>
          </div>

          <div class="info-card">
            <h3>üìã Informations</h3>
            
            <!-- ‚ú® Cat√©gories d√©plac√©es ici -->
            <div class="info-item">
              <span class="info-label">Cat√©gories</span>
              <div class="info-value" id="gameCategories"></div>
            </div>
            
            <div class="info-item">
              <span class="info-label">Statut</span>
              <span class="info-value">Disponible</span>
            </div>
            <div class="info-item">
              <span class="info-label">Source</span>
              <span class="info-value">CRACKUZU</span>
            </div>
          </div>

          <a href="#" id="gameDownloadBtn" class="big-download-btn" style="display: none; width: 100%; justify-content: center; margin-top: 16px;">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            T√©l√©charger via Torrent
          </a>
        </div>

        <div class="content-section">
          <section>
            <h2>üìù Description</h2>
            <div id="descriptionContent" class="loading-state">Chargement de la description...</div>
          </section>

          <section>
            <h2>üé¨ Trailer</h2>
            <div id="trailerContent" class="loading-state">Chargement du trailer...</div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const gameName = urlParams.get('name');
    const WORKER_URL = localStorage.getItem('worker_url') || 'https://crackuzu-api.crackuzu.workers.dev';
    let currentGame = null;

    if (!gameName) {
      document.getElementById('gameTitle').textContent = 'Erreur';
      document.getElementById('descriptionContent').innerHTML = 
        '<div class="error-message">Aucun jeu sp√©cifi√© dans l\'URL.</div>';
    }

    async function translateText(text, targetLang = 'fr') {
      if (!WORKER_URL) {
        return text;
      }

      try {
        const response = await fetch(`${WORKER_URL}/api/translate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, targetLang })
        });

        if (!response.ok) {
          console.error('Translation failed:', response.status);
          return text;
        }

        const data = await response.json();
        return data.translatedText || text;
      } catch (error) {
        console.error('Translation error:', error);
        return text;
      }
    }

    async function fetchGameCover(gameName) {
      const coverContainer = document.getElementById('gameCoverContainer');
      const coverImg = document.getElementById('gameCoverImg');
      const coverLoading = document.getElementById('coverLoading');
      
      coverContainer.classList.add('loading');
      coverLoading.style.display = 'block';
      
      try {
        // Try RAWG first for 16:9 HD cover
        const rawgResponse = await fetch(`${WORKER_URL}/api/rawg-cover?game=${encodeURIComponent(gameName)}`);
        
        if (rawgResponse.ok) {
          const data = await rawgResponse.json();
          
          if (data.coverUrl) {
            coverImg.src = data.coverUrl;
            coverImg.onload = () => {
              coverContainer.classList.remove('loading');
              coverLoading.style.display = 'none';
            };
            coverImg.onerror = () => {
              loadFallbackCover();
            };
            return;
          }
        }
        
        loadFallbackCover();
        
      } catch (error) {
        console.error('Error fetching cover:', error);
        loadFallbackCover();
      }
      
      function loadFallbackCover() {
        if (currentGame && currentGame.cover) {
          coverImg.src = currentGame.cover;
          coverContainer.classList.remove('loading');
          coverLoading.style.display = 'none';
        }
      }
    }

    function migrateGameData(game) {
      if (Array.isArray(game.categories)) {
        return game;
      }
      
      const migrated = { ...game };
      if (game.cat) {
        migrated.categories = [game.cat.toUpperCase()];
      } else {
        migrated.categories = ['ACTION'];
      }
      
      return migrated;
    }

    async function loadGameData() {
      try {
        const response = await fetch('data.json');
        const data = await response.json();
        
        let foundGame = data.games.find(g => g.name.toLowerCase() === gameName.toLowerCase());
        if (!foundGame) throw new Error('Game not found');

        currentGame = migrateGameData(foundGame);

        document.getElementById('pageTitle').textContent = `${currentGame.name} - CRACKUZU`;
        document.getElementById('gameTitle').textContent = currentGame.name;
        
        // ‚ú® Afficher toutes les cat√©gories dans la section info
        const categoriesContainer = document.getElementById('gameCategories');
        const categories = Array.isArray(currentGame.categories) ? currentGame.categories : [];
        
        categoriesContainer.innerHTML = categories.map(cat => 
          `<span class="game-cat-pill">${cat.toUpperCase()}</span>`
        ).join('');

        fetchGameCover(currentGame.name);

        const downloadBtn = document.getElementById('gameDownloadBtn');
        downloadBtn.href = currentGame.magnet;
        downloadBtn.style.display = 'inline-flex';

        fetchSynopsis(currentGame.name, currentGame.igdbId);
        fetchTrailer(currentGame.name, currentGame.videoId);
      } catch (error) {
        console.error('Error loading game data:', error);
        document.getElementById('gameTitle').textContent = 'Erreur';
        document.getElementById('descriptionContent').innerHTML = 
          '<div class="error-message">Impossible de charger les donn√©es du jeu.</div>';
      }
    }

    async function fetchSynopsis(gameName, igdbId) {
      const descContainer = document.getElementById('descriptionContent');
      
      try {
        console.log('üîç fetchSynopsis called:', { gameName, igdbId });
        let synopsis = null;
        let rating = null;
        let releaseDate = null;
        let source = null;
        
        // 1. Essayer IGDB si on a un ID
        if (igdbId) {
          console.log('üì° Trying IGDB with id:', igdbId);
          try {
            const response = await fetch(`${WORKER_URL}/api/game-details?id=${igdbId}`);
            console.log('üì° IGDB response status:', response.status);
            if (response.ok) {
              const data = await response.json();
              console.log('üì° IGDB data:', data);
              if (data.synopsis && data.synopsis !== "Pas de description disponible.") {
                synopsis = data.synopsis;
                rating = data.rating;
                releaseDate = data.releaseDate;
                source = 'IGDB';
              }
            }
          } catch (e) {
            console.log('ÔøΩ IGDB failed:', e.message);
          }
        }
        
        // 2. Fallback RAWG si pas de synopsis IGDB
        if (!synopsis) {
          console.log('üì° Trying RAWG for:', gameName);
          try {
            const response = await fetch(`${WORKER_URL}/api/rawg-synopsis?game=${encodeURIComponent(gameName)}`);
            console.log('üì° RAWG response status:', response.status);
            if (response.ok) {
              const data = await response.json();
              console.log('üì° RAWG data:', data);
              if (data.synopsis && data.synopsis !== "Pas de description disponible." && data.synopsis.length > 10) {
                synopsis = data.synopsis;
                rating = data.rating;
                releaseDate = data.released;
                source = 'RAWG';
              }
            }
          } catch (e) {
            console.log('üì° RAWG failed:', e.message);
          }
        }
        
        // 3. Afficher la description
        if (synopsis) {
          console.log('‚úÖ Found synopsis from:', source);
          descContainer.innerHTML = '<div class="loading-state">Traduction en cours...</div>';
          
          // Traduire
          const synopsisFR = await translateText(synopsis, 'fr');
          console.log('‚úÖ Translation done');
          
          let extraInfo = '';
          if (rating || releaseDate) {
            extraInfo = '<p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,.08);">';
            if (releaseDate) extraInfo += `<strong>üìÖ Sortie :</strong> ${releaseDate}<br>`;
            if (rating) extraInfo += `<strong>‚≠ê Note :</strong> ${rating}${source === 'IGDB' ? '/5' : '/10'}<br>`;
            extraInfo += '</p>';
          }

          descContainer.innerHTML = `
            <div class="description-box">
              <p>${synopsisFR}</p>
              ${extraInfo}
              <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,.08); font-size: 12px; opacity: 0.7;">
                <em>Source: ${source} | Traduit automatiquement</em>
              </p>
            </div>
          `;
          return;
        }
        
        // 4. Aucune description trouv√©e
        throw new Error('No synopsis found');
        
      } catch (error) {
        console.error('‚ùå Error fetching synopsis:', error);
        descContainer.innerHTML = `
          <div class="description-box">
            <p><strong>${gameName}</strong> est disponible au t√©l√©chargement via CRACKUZU.</p>
            <p>Pour t√©l√©charger ce jeu, cliquez sur le bouton "T√©l√©charger via Torrent" ci-dessus.</p>
          </div>
        `;
      }
    }

    async function fetchTrailer(gameName, videoId) {
      const trailerContainer = document.getElementById('trailerContent');
      console.log('üé¨ fetchTrailer called:', { gameName, videoId });
      
      // Si on a un videoId, utiliser directement YouTube No-Cookie Embed
      if (videoId) {
        console.log('‚úÖ Using stored videoId:', videoId);
        trailerContainer.innerHTML = `
          <div class="trailer-container">
            <iframe 
              src="https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&autoplay=0"
              title="Trailer ${gameName}"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              loading="lazy">
            </iframe>
          </div>
          <div style="margin-top: 12px; text-align: center; color: rgba(255,255,255,.6); font-size: 13px;">
            <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" 
               style="color: rgba(100,180,255,.8); text-decoration: none;">
              üì∫ Ouvrir sur YouTube
            </a>
          </div>
        `;
        return;
      }
      
      // Fallback: recherche via le worker
      console.log('üîç No videoId, searching via worker...');
      try {
        const searchQuery = `${gameName} game trailer`;
        console.log('üì° Fetching:', `${WORKER_URL}/api/youtube?q=${encodeURIComponent(searchQuery)}`);
        
        const response = await fetch(`${WORKER_URL}/api/youtube?q=${encodeURIComponent(searchQuery)}`);
        console.log('üì° Worker response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.log('üì° Worker error response:', errorText);
          throw new Error(`Worker returned ${response.status}`);
        }

        const data = await response.json();
        console.log('üì° Worker data:', data);
        
        if (data.videoId) {
          console.log('‚úÖ Found trailer via search:', data.videoId);
          trailerContainer.innerHTML = `
            <div class="trailer-container">
              <iframe 
                src="https://www.youtube-nocookie.com/embed/${data.videoId}?rel=0&modestbranding=1&autoplay=0"
                title="Trailer ${gameName}"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                loading="lazy">
              </iframe>
            </div>
            <div style="margin-top: 12px; text-align: center; color: rgba(255,255,255,.6); font-size: 13px;">
              <a href="https://www.youtube.com/watch?v=${data.videoId}" target="_blank" 
                 style="color: rgba(100,180,255,.8); text-decoration: none;">
                üì∫ Ouvrir sur YouTube
              </a>
            </div>
          `;
          return;
        }
        
        if (data.searchUrl) {
          showTrailerFallbackWithLink(gameName, data.searchUrl);
        } else {
          showTrailerFallback(gameName);
        }
        
      } catch (error) {
        console.error('‚ùå Error fetching trailer:', error);
        showTrailerFallback(gameName);
      }
    }

    function showTrailerFallbackWithLink(gameName, searchUrl) {
      const trailerContainer = document.getElementById('trailerContent');
      
      trailerContainer.innerHTML = `
        <div style="padding: 40px 20px; text-align: center; border-radius: var(--r-md); border: 1px solid var(--stroke); background: rgba(255,255,255,.04);">
          <div style="margin-bottom: 20px;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <polygon points="10 8 16 12 10 16 10 8"></polygon>
            </svg>
          </div>
          <p style="color: var(--muted); margin-bottom: 16px; font-size: 15px;">
            Recherchez le trailer sur YouTube
          </p>
          <a href="${searchUrl}" target="_blank" 
             class="big-download-btn" style="display: inline-flex; padding: 12px 24px; font-size: 14px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
              <circle cx="12" cy="12" r="10"></circle>
              <polygon points="10 8 16 12 10 16 10 8"></polygon>
            </svg>
            üîç Rechercher "${gameName}" sur YouTube
          </a>
          <div style="margin-top: 16px; color: rgba(255,255,255,.4); font-size: 12px;">
            Cliquez pour rechercher manuellement
          </div>
        </div>
      `;
    }

    function showTrailerFallback(gameName) {
      const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(gameName + " official game trailer")}`;
      showTrailerFallbackWithLink(gameName, searchUrl);
    }

    loadGameData();
  </script>
</body>
</html>
