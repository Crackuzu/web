<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRACKUZU - ADMIN PANEL</title>

  <style>
    :root{
      --bg0:#0b0e12; --bg1:#10151b;
      --glass: rgba(255,255,255,.065); --glass2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.11); --stroke2: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92); --muted: rgba(255,255,255,.62);
      --outer: clamp(14px, 2.2vw, 26px); --gap: clamp(12px, 1.2vw, 18px);
      --pad: clamp(14px, 1.6vw, 20px); --r-xl: clamp(18px, 2vw, 26px);
      --r-md: clamp(14px, 1.5vw, 18px); --accent: #3b82f6;
      --shadow: 0 28px 90px rgba(0,0,0,.58); --side: clamp(250px, 20vw, 330px);
      --cardW: clamp(140px, 10.5vw, 185px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; font-family: system-ui, -apple-system, sans-serif; color: var(--text); background: var(--bg0); overflow-x:hidden; }

    /* STRUCTURE PRINCIPALE */
    .app{ padding: var(--outer); width: 100%; min-height: 100vh; }
    .shell{ width: min(1800px, 100%); margin: 0 auto; display:flex; flex-direction:column; gap: var(--gap); }
    
    .glass{ background: linear-gradient(180deg, var(--glass), var(--glass2)); border: 1px solid var(--stroke); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: var(--r-xl); padding: var(--pad); }

    header{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap: var(--gap); }
    .brand .big{ font-weight: 300; letter-spacing: 2px; font-size: clamp(28px, 3.2vw, 46px); }
    .brand .small{ color: var(--muted); cursor: pointer; font-size: 14px; }

    .search-top{ width: clamp(220px, 26vw, 360px); height: 40px; border-radius: 999px; display:flex; align-items:center; padding: 0 14px; background: rgba(255,255,255,.08); border: 1px solid var(--stroke); }
    .search-top input{ background: transparent; border: none; color: white; width: 100%; outline: none; }

    .main{ display:grid; grid-template-columns: var(--side) 1fr; gap: var(--gap); flex: 1; }
    .catbtn{ width:100%; padding: 14px; border-radius: 12px; border: 1px solid var(--stroke); background: var(--glass); color: var(--muted); cursor:pointer; margin-bottom: 8px; text-align: left; }
    .catbtn.active{ background: var(--accent); color: white; }

    .grid{ display:grid; gap: var(--gap); grid-template-columns: repeat(auto-fill, minmax(var(--cardW), 1fr)); }
    .card{ position: relative; border-radius: var(--r-md); overflow:hidden; border: 1px solid var(--stroke); aspect-ratio: 3/4; cursor:pointer; }
    .card img{ width:100%; height:100%; object-fit:cover; transition: .3s; }
    .card:hover img{ transform: scale(1.1); }
    .card-overlay{ position:absolute; inset:0; background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 60%); display:flex; flex-direction:column; justify-content: flex-end; padding: 12px; opacity:0; transition: .3s; }
    .card:hover .card-overlay{ opacity:1; }

    /* ADMIN PANEL MODAL */
    .modal{ display:none; position:fixed; inset:0; z-index:9999; background: rgba(0,0,0,.8); backdrop-filter: blur(6px); align-items:center; justify-content:center; }
    .modal.open{ display:flex; }
    .adminBox{ background: var(--bg1); border-radius: var(--r-xl); width: min(1200px, 95vw); max-height: 90vh; display: grid; grid-template-columns: 260px 1fr; overflow: hidden; border: 1px solid var(--stroke2); }
    
    .adminSidebar{ background: rgba(0,0,0,.2); padding: 24px; border-right: 1px solid var(--stroke); }
    .adminNavBtn{ width:100%; padding: 12px; border-radius: 8px; background: transparent; border: none; color: var(--muted); text-align: left; cursor:pointer; margin-bottom: 4px; }
    .adminNavBtn.active{ background: rgba(255,255,255,0.05); color: white; }

    .adminContent{ padding: 32px; overflow-y: auto; }
    .adminSection{ display:none; }
    .adminSection.active{ display:block; }

    /* NOUVELLES CLASSES : SEARCH & SCROLL LIST */
    .admin-search-wrapper { margin-bottom: 15px; }
    .admin-list-scroll { max-height: 500px; overflow-y: auto; border: 1px solid var(--stroke); border-radius: 12px; background: rgba(0,0,0,0.1); padding: 5px; }
    
    input[type=text], textarea{ width:100%; padding: 12px; border-radius: 8px; border: 1px solid var(--stroke2); background: rgba(255,255,255,0.05); color: white; margin-bottom: 12px; }
    button.primary{ background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; }
    button.danger{ background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }

    .gameRow{ display:flex; align-items:center; gap: 12px; padding: 10px; border-bottom: 1px solid var(--stroke); }
    .gameRow img{ width: 40px; height: 50px; object-fit: cover; border-radius: 4px; }
    .gameRow .name{ flex: 1; font-weight: 500; }

    .closeBtn{ position:absolute; top:20px; right:20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
  </style>
</head>
<body>

<div class="app">
  <div class="shell">
    <header class="glass">
      <div class="brand">
        <div class="big">CRACKUZU</div>
        <div class="small" onclick="openAdmin()">BIBLIOTH√àQUE <span style="font-size: 10px; opacity: 0.5;">‚ñº</span></div>
      </div>
      <div class="search-top">
        <input type="text" placeholder="Rechercher un jeu..." id="q" oninput="state.query = this.value; renderGames();" />
      </div>
    </header>

    <div class="main">
      <aside class="glass">
        <h3 style="margin-top:0">Cat√©gories</h3>
        <div id="catList"></div>
      </aside>
      <section class="glass">
        <div class="grid" id="gameGrid"></div>
      </section>
    </div>
  </div>
</div>

<div class="modal" id="adminModal">
  <div class="adminBox">
    <button class="closeBtn" onclick="closeAdmin()">‚úï</button>
    
    <div class="adminSidebar">
      <h2>üîß Admin</h2>
      <div class="adminNav">
        <button class="adminNavBtn active" onclick="showSection('add')">‚ûï Ajouter un jeu</button>
        <button class="adminNavBtn" onclick="showSection('list')">üìã Liste des jeux</button>
        <button class="adminNavBtn" onclick="showSection('settings')">‚öôÔ∏è Param√®tres</button>
      </div>
    </div>

    <div class="adminContent">
      <div class="adminSection active" id="sec-add">
        <h2 id="formTitle">Ajouter un nouveau jeu</h2>
        <label>Nom du jeu</label>
        <input type="text" id="gameName" placeholder="Ex: Elden Ring">
        
        <label>URL de la Cover (Collez une image ici Ctrl+V)</label>
        <input type="text" id="gameCover" placeholder="https://...">
        
        <label>Lien Magnet</label>
        <textarea id="gameMagnet" placeholder="magnet:?xt=..."></textarea>
        
        <button class="primary" onclick="saveGame()">Enregistrer le jeu</button>
      </div>

      <div class="adminSection" id="sec-list">
        <h2>Ma Biblioth√®que</h2>
        <div class="admin-search-wrapper">
          <input type="text" id="adminSearchInput" placeholder="üîç Rechercher un jeu dans la liste..." oninput="renderAdminLists()">
        </div>
        <div class="admin-list-scroll" id="adminGamesList">
          </div>
      </div>

      <div class="adminSection" id="sec-settings">
        <h2>Param√®tres</h2>
        <p>Toutes les modifications sont sauvegard√©es localement. Pour les mettre en ligne sur votre site GitHub, utilisez le bouton ci-dessous.</p>
        <button class="primary" style="background: #2ea44f; width: 100%; font-size: 16px;" onclick="publishToGithub()">
          üöÄ PUBLIER LES MODIFICATIONS SUR GITHUB
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let state = {
    data: { games: [], categories: [] },
    activeCat: "ALL",
    query: "",
    editIndex: null
  };

  // INITIALISATION
  async function init() {
    try {
      const r = await fetch('data.json');
      state.data = await r.json();
      renderCategories();
      renderGames();
    } catch(e) { console.error("Erreur chargement data", e); }
  }

  // --- RENDU FRONT-END ---
  function renderCategories() {
    const cont = document.getElementById('catList');
    let cats = ["ALL", ...new Set(state.data.games.flatMap(g => g.categories || []))];
    cont.innerHTML = cats.map(c => `
      <button class="catbtn ${state.activeCat === c ? 'active' : ''}" onclick="filterCat('${c}')">${c}</button>
    `).join('');
  }

  function filterCat(c) { state.activeCat = c; renderCategories(); renderGames(); }

  function renderGames() {
    const grid = document.getElementById('gameGrid');
    const filtered = state.data.games.filter(g => {
      const matchCat = state.activeCat === "ALL" || g.categories.includes(state.activeCat);
      const matchSearch = g.name.toLowerCase().includes(state.query.toLowerCase());
      return matchCat && matchSearch;
    });

    grid.innerHTML = filtered.map(g => `
      <div class="card" onclick="window.location.href='game.html?name=${encodeURIComponent(g.name)}'">
        <img src="${g.cover}" loading="lazy">
        <div class="card-overlay">
          <div style="font-weight:600">${g.name}</div>
        </div>
      </div>
    `).join('');
  }

  // --- LOGIQUE ADMIN ---
  function openAdmin() { document.getElementById('adminModal').classList.add('open'); renderAdminLists(); }
  function closeAdmin() { document.getElementById('adminModal').classList.remove('open'); }

  function showSection(id) {
    document.querySelectorAll('.adminSection').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.adminNavBtn').forEach(b => b.classList.remove('active'));
    document.getElementById('sec-' + id).classList.add('active');
    event.target.classList.add('active');
    if(id === 'list') renderAdminLists();
  }

  // RENDU DE LA LISTE ADMIN (AVEC SCROLL ET RECHERCHE)
  function renderAdminLists() {
    const container = document.getElementById('adminGamesList');
    const searchVal = document.getElementById('adminSearchInput').value.toLowerCase();
    
    const filtered = state.data.games.filter(g => g.name.toLowerCase().includes(searchVal));

    container.innerHTML = filtered.map((g, i) => {
      const realIndex = state.data.games.indexOf(g);
      return `
        <div class="gameRow">
          <img src="${g.cover}">
          <div class="name">${g.name}</div>
          <button onclick="editGame(${realIndex})">Modifier</button>
          <button class="danger" onclick="deleteGame(${realIndex})">‚úï</button>
        </div>
      `;
    }).join('');
  }

  // GESTION DU PASTE (CTRL+V) SUR L'INPUT COVER
  document.getElementById('gameCover').addEventListener('paste', async (e) => {
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    for (let item of items) {
      if (item.type.indexOf("image") !== -1) {
        e.preventDefault();
        const file = item.getAsFile();
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'ml_default'); // Ton preset Cloudinary

        try {
          const res = await fetch('https://api.cloudinary.com/v1_1/dkcui82mx/image/upload', {
            method: 'POST',
            body: formData
          });
          const imgData = await res.json();
          document.getElementById('gameCover').value = imgData.secure_url;
          alert("‚úÖ Image convertie et h√©berg√©e sur Cloudinary !");
        } catch(err) { alert("Erreur lors de l'envoi vers Cloudinary"); }
      }
    }
  });

  function saveGame() {
    const newGame = {
      name: document.getElementById('gameName').value,
      cover: document.getElementById('gameCover').value,
      magnet: document.getElementById('gameMagnet').value,
      categories: ["ACTION"] // Par d√©faut
    };

    if(state.editIndex !== null) state.data.games[state.editIndex] = newGame;
    else state.data.games.push(newGame);

    state.editIndex = null;
    document.getElementById('formTitle').innerText = "Ajouter un nouveau jeu";
    renderGames();
    alert("Enregistr√© localement !");
  }

  function editGame(index) {
    state.editIndex = index;
    const g = state.data.games[index];
    document.getElementById('gameName').value = g.name;
    document.getElementById('gameCover').value = g.cover;
    document.getElementById('gameMagnet').value = g.magnet;
    document.getElementById('formTitle').innerText = "Modifier " + g.name;
    showSection('add');
  }

  function deleteGame(index) {
    if(confirm("Supprimer ce jeu ?")) {
      state.data.games.splice(index, 1);
      renderAdminLists();
      renderGames();
    }
  }

  // PUBLICATION SUR GITHUB VIA LE WORKER
  async function publishToGithub() {
    if(!confirm("Voulez-vous vraiment mettre √† jour votre site en ligne ?")) return;
    
    try {
      const resp = await fetch('https://crackuzu-api.crackuzu.workers.dev/api/github-save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(state.data)
      });
      const res = await resp.json();
      if(res.success) alert("‚úÖ GitHub mis √† jour avec succ√®s ! Le site sera √† jour dans 1 minute.");
      else alert("‚ùå Erreur : " + res.error);
    } catch(e) { alert("‚ùå Impossible de contacter le serveur de mise √† jour."); }
  }

  init();
</script>

</body>
</html>
