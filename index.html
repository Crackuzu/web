<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRACKUZU</title>
  <style>
    /* TON DESIGN ORIGINAL RÉTABLI */
    :root{
      --bg0:#0b0e12; --bg1:#10151b; --glass: rgba(255,255,255,.065);
      --stroke: rgba(255,255,255,.11); --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62); --accent: #3b82f6; --r-xl: 24px; --r-md: 16px;
    }
    body { background: var(--bg0); color: var(--text); font-family: system-ui, sans-serif; margin: 0; padding: 20px; }
    .shell { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
    .glass { background: var(--bg1); border: 1px solid var(--stroke); border-radius: var(--r-xl); padding: 20px; }
    
    /* GRID JEUX */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
    .card { background: var(--glass); border-radius: var(--r-md); overflow: hidden; border: 1px solid var(--stroke); cursor: pointer; transition: 0.3s; }
    .card:hover { transform: translateY(-5px); border-color: var(--accent); }
    .card img { width: 100%; aspect-ratio: 3/4; object-fit: cover; }
    .card-info { padding: 12px; font-size: 14px; font-weight: 500; }

    /* ADMIN PANEL DANS TON STYLE */
    .admin-trigger { position: fixed; bottom: 20px; left: 20px; opacity: 0.3; cursor: pointer; font-size: 12px; }
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
    .modal.open { display:flex; }
    .admin-box { background: var(--bg1); width: 90%; max-width: 1000px; height: 80vh; border-radius: var(--r-xl); display: flex; overflow: hidden; border: 1px solid var(--stroke); }
    
    .admin-nav { width: 200px; background: rgba(0,0,0,0.2); padding: 20px; border-right: 1px solid var(--stroke); }
    .admin-content { flex: 1; padding: 30px; overflow-y: auto; }
    
    /* LISTE SCROLLABLE & RECHERCHE */
    .admin-scroll-list { max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 10px; }
    .game-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--stroke); gap: 10px; }
    
    input, textarea, select { width: 100%; padding: 12px; background: var(--glass); border: 1px solid var(--stroke); border-radius: 8px; color: white; margin-bottom: 10px; }
    button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-publish { background: #2ea44f; color: white; width: 100%; margin-top: 10px; }
  </style>
</head>
<body>

<div class="shell">
  <aside class="glass">
    <h1 style="letter-spacing: 2px;">CRACKUZU</h1>
    <div id="catList"></div>
  </aside>

  <main>
    <div class="glass" style="margin-bottom: 20px; display: flex; gap: 10px;">
      <input type="text" id="mainSearch" placeholder="Rechercher un titre..." oninput="state.query = this.value; renderGames();">
    </div>
    <div class="grid" id="gameGrid"></div>
  </main>
</div>

<div class="admin-trigger" onclick="promptAdmin()">ADMIN LOGIN</div>

<div class="modal" id="adminModal">
  <div class="admin-box">
    <div class="admin-nav">
      <button onclick="showSec('add')" style="width:100%; margin-bottom:10px;">Ajouter</button>
      <button onclick="showSec('list')" style="width:100%; margin-bottom:10px;">Liste</button>
      <button onclick="publishToGithub()" class="btn-publish">PUBLIER</button>
      <button onclick="closeAdmin()" style="margin-top:50px; background:none; color:gray;">Fermer</button>
    </div>

    <div class="admin-content">
      <div id="sec-add" class="section">
        <div style="display:flex; gap:10px;">
          <input type="text" id="igdbQuery" placeholder="Nom du jeu sur IGDB...">
          <button class="btn-primary" onclick="searchIGDB()">Rechercher IGDB</button>
        </div>
        <div id="igdbResults"></div>
        <hr>
        <input type="text" id="f-name" placeholder="Nom du jeu">
        <input type="text" id="f-cover" placeholder="URL Cover (Ctrl+V supporté)">
        <textarea id="f-magnet" placeholder="Lien Magnet"></textarea>
        <input type="text" id="f-cats" placeholder="Catégories (séparées par des virgules)">
        <button class="btn-primary" onclick="saveGame()">Enregistrer le jeu</button>
      </div>

      <div id="sec-list" class="section" style="display:none;">
        <input type="text" placeholder="Filtrer ma liste..." oninput="renderAdminList(this.value)">
        <div class="admin-scroll-list" id="adminList"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let state = { data: { games: [], categories: [] }, activeCat: "ALL", query: "", editIdx: null };

  async function init() {
    const r = await fetch('data.json');
    state.data = await r.json();
    renderCategories();
    renderGames();
  }

  function renderCategories() {
    const cats = ["ALL", ...state.data.categories];
    document.getElementById('catList').innerHTML = cats.map(c => 
      `<div onclick="state.activeCat='${c}'; renderGames();" style="padding:10px; cursor:pointer; color:${state.activeCat===c?'white':'gray'}">${c}</div>`
    ).join('');
  }

  function renderGames() {
    const grid = document.getElementById('gameGrid');
    const filtered = state.data.games.filter(g => (state.activeCat === "ALL" || g.categories.includes(state.activeCat)) && g.name.toLowerCase().includes(state.query.toLowerCase()));
    grid.innerHTML = filtered.map(g => `
      <div class="card" onclick="location.href='game.html?name=${encodeURIComponent(g.name)}'">
        <img src="${g.cover}">
        <div class="card-info">${g.name}</div>
      </div>
    `).join('');
  }

  // --- ADMIN LOGIC ---
  function promptAdmin() {
    const pw = prompt("Mot de passe :");
    if (pw === "ton_mdp") { // <--- CHANGE LE MDP ICI
      document.getElementById('adminModal').classList.add('open');
      renderAdminList();
    }
  }

  function closeAdmin() { document.getElementById('adminModal').classList.remove('open'); }

  function showSec(id) {
    document.getElementById('sec-add').style.display = id === 'add' ? 'block' : 'none';
    document.getElementById('sec-list').style.display = id === 'list' ? 'block' : 'none';
  }

  async function searchIGDB() {
    const q = document.getElementById('igdbQuery').value;
    const r = await fetch(`https://crackuzu-api.crackuzu.workers.dev/api/search-games?query=${encodeURIComponent(q)}`);
    const d = await r.json();
    document.getElementById('igdbResults').innerHTML = d.games.map(g => `
      <div onclick="fillForm('${g.name}', '${g.cover?.url?.replace('t_thumb','t_720p')}')" style="padding:5px; cursor:pointer; border-bottom:1px solid #333">${g.name}</div>
    `).join('');
  }

  function fillForm(name, cover) {
    document.getElementById('f-name').value = name;
    document.getElementById('f-cover').value = cover ? "https:" + cover : "";
  }

  function saveGame() {
    const g = {
      name: document.getElementById('f-name').value,
      cover: document.getElementById('f-cover').value,
      magnet: document.getElementById('f-magnet').value,
      categories: document.getElementById('f-cats').value.split(',').map(c => c.trim().toUpperCase())
    };
    if(state.editIdx !== null) state.data.games[state.editIdx] = g;
    else state.data.games.push(g);
    renderGames();
    alert("Enregistré localement !");
  }

  function renderAdminList(filter = "") {
    const list = document.getElementById('adminList');
    const filtered = state.data.games.filter(g => g.name.toLowerCase().includes(filter.toLowerCase()));
    list.innerHTML = filtered.map((g, i) => `
      <div class="game-row">
        <span style="flex:1">${g.name}</span>
        <button onclick="editG(${state.data.games.indexOf(g)})">Modifier</button>
        <button onclick="deleteG(${state.data.games.indexOf(g)})" style="color:red">X</button>
      </div>
    `).join('');
  }

  // --- CLOUDINARY CTRL+V ---
  document.getElementById('f-cover').addEventListener('paste', async (e) => {
    const item = e.clipboardData.items[0];
    if (item.type.includes("image")) {
      const blob = item.getAsFile();
      const formData = new FormData();
      formData.append('file', blob);
      formData.append('upload_preset', 'ml_default');
      const res = await fetch('https://api.cloudinary.com/v1_1/dkcui82mx/image/upload', { method: 'POST', body: formData });
      const data = await res.json();
      document.getElementById('f-cover').value = data.secure_url;
    }
  });

  async function publishToGithub() {
    const res = await fetch('https://crackuzu-api.crackuzu.workers.dev/api/github-save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(state.data)
    });
    if((await res.json()).success) alert("✅ Publié !");
  }

  init();
</script>
</body>
</html>
