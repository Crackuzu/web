<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRACKUZU</title>

  <style>
    :root{
      --bg0:#0b0e12;
      --bg1:#10151b;

      --glass: rgba(255,255,255,.065);
      --glass2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.11);
      --stroke2: rgba(255,255,255,.16);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --outer: clamp(14px, 2.2vw, 26px);
      --gap:   clamp(12px, 1.2vw, 18px);
      --pad:   clamp(14px, 1.6vw, 20px);

      --r-xl:  clamp(18px, 2vw, 26px);
      --r-md:  clamp(14px, 1.5vw, 18px);

      --shadow: 0 28px 90px rgba(0,0,0,.58);
      --shadow2: 0 18px 46px rgba(0,0,0,.45);

      --side: clamp(250px, 20vw, 330px);

      /* Cards: fixed-ish size -> more columns when window wider */
      --cardW: clamp(140px, 10.5vw, 185px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(255,255,255,.09), transparent 55%),
        radial-gradient(950px 600px at 90% 20%, rgba(255,255,255,.07), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .glass{
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }
    @supports ((-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px))){
      .glass{
        -webkit-backdrop-filter: blur(14px);
        backdrop-filter: blur(14px);
      }
    }

    .app{
      min-height: 100vh;
      min-height: 100dvh;
      padding: var(--outer);
      width: 100%;
    }

    .shell{
      width: min(1800px, calc(100dvw - (2 * var(--outer))));
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      min-height: calc(100dvh - (2 * var(--outer)));
    }

    header{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap: var(--gap);
      min-height: clamp(86px, 10vh, 120px);
    }

    .brand{
      text-align:center;
      user-select:none;
      line-height:1.05;
    }
    .brand .big{
      font-weight: 300;
      letter-spacing: clamp(1px, .25vw, 2.5px);
      font-size: clamp(28px, 3.2vw, 46px);
      opacity:.92;
    }
    .brand .small{
      margin-top: 4px;
      font-size: clamp(12px, 1.1vw, 14px);
      letter-spacing: clamp(2px, .35vw, 3.5px);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor: pointer;
    }
    .brand .small:hover{ color: rgba(255,255,255,.78); }

    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.70);
      letter-spacing: 1px;
    }

    .search{
      width: clamp(220px, 26vw, 360px);
      height: clamp(34px, 4.2vh, 40px);
      border-radius: 999px;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 14px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.085);
      justify-self:end;
    }
    .search svg{ width: 18px; height: 18px; opacity:.78; }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color: var(--text);
      font-size: clamp(13px, 1.1vw, 14px);
    }
    .search input::placeholder{ color: rgba(255,255,255,.55); }

    .main{
      flex: 1;
      min-height: 0;
      display:grid;
      grid-template-columns: var(--side) 1fr;
      gap: var(--gap);
    }

    aside{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    aside h2{
      margin: 6px 0 12px;
      text-align:center;
      font-weight: 300;
      letter-spacing: clamp(1px, .3vw, 2.2px);
      font-size: clamp(22px, 2.3vw, 28px);
      color: rgba(255,255,255,.86);
    }

    .catlist{
      display:flex;
      flex-direction:column;
      gap: clamp(10px, 1.2vw, 14px);
      margin-top: clamp(10px, 1.3vw, 18px);
    }

    .catbtn{
      height: clamp(46px, 5.8vh, 54px);
      border-radius: clamp(14px, 1.4vw, 16px);
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      font-weight: 520;
      letter-spacing: 1px;
      color: rgba(255,255,255,.70);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease, color .15s ease;
      user-select:none;
    }
    .catbtn:hover{
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.25);
      transform: translateY(-1px);
      color: rgba(255,255,255,.86);
    }
    .catbtn.active{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.28);
      color: rgba(255,255,255,.92);
    }

    .sidefoot{
      margin-top:auto;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: rgba(255,255,255,.55);
      font-size: clamp(12px, 1.05vw, 13px);
      letter-spacing: .8px;
    }
    .sidefoot .boondocks{ color: rgba(255,255,255,.55); text-decoration: none; }
    .sidefoot .boondocks:hover{ color: rgba(255,255,255,.80); text-decoration: underline; }

    section{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      min-height: 0;
      overflow:auto;
    }

    .grid{
      display:grid;
      gap: var(--gap);
      grid-template-columns: repeat(auto-fill, minmax(var(--cardW), 1fr));
      align-content: start;
    }

    /* Hover card */
    .card{
      position: relative;
      border-radius: var(--r-md);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      aspect-ratio: 3 / 4;

      transform: translateZ(0);
      transition: transform .22s ease, border-color .22s ease;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      background:
        radial-gradient(600px 260px at 30% 10%, rgba(170,140,255,.28), transparent 60%),
        radial-gradient(500px 240px at 80% 90%, rgba(0,210,255,.20), transparent 55%);
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-18px;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
    }

    .card img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
      transition: transform .28s ease, filter .28s ease;
      filter: saturate(1.05) contrast(1.05);
    }

    .card:hover{
      transform: scale(1.035);
      border-color: rgba(255,255,255,.20);
    }
    .card:hover::before{ opacity: 1; }
    .card:hover::after{ opacity: 1; }
    .card:hover img{
      transform: scale(1.10);
      filter: none;
    }

    /* Download only on hover */
    .download{
      position:absolute;
      left: 50%;
      bottom: clamp(10px, 1.2vw, 12px);
      transform: translateX(-50%) translateY(10px);
      height: clamp(32px, 3.6vh, 36px);
      width: min(84%, 210px);

      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      letter-spacing: .8px;
      font-size: clamp(11px, 1vw, 12px);
      font-weight: 800;

      color: #fff;
      text-shadow: 0 1px 0 rgba(0,0,0,.55);

      background: rgba(20,20,24,.52);
      border: 1px solid rgba(255,255,255,.20);

      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);

      box-shadow: 0 14px 28px rgba(0,0,0,.40);

      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease, background .18s ease, border-color .18s ease;
    }
    .card:hover .download{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    .download:hover{
      background: rgba(20,20,24,.62);
      border-color: rgba(255,255,255,.30);
    }

    @media (hover: none){
      .download{ opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
    }

    .state{
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.75);
      font-size: 13px;
      letter-spacing: .2px;
      margin-bottom: var(--gap);
    }

    /* ADMIN MODAL */
    .modalWrap{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: var(--outer);
      background: rgba(0,0,0,.55);
      z-index: 9999;
    }
    .modalWrap.open{ display:flex; }

    .modal{
      width: min(980px, 100%);
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }

    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .modalHead h3{
      margin:0;
      font-weight: 420;
      letter-spacing: 1px;
      font-size: clamp(16px, 1.4vw, 18px);
      color: rgba(255,255,255,.88);
    }

    .btnRow{ display:flex; gap: 10px; flex-wrap: wrap; justify-content:flex-end; }
    .btn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.85);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-weight: 650;
      letter-spacing: .5px;
      font-size: 13px;
    }
    .btn:hover{ background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.25); transform: translateY(-1px); }
    .btn.danger{ background: rgba(255,80,80,.12); border-color: rgba(255,80,80,.30); }
    .btn.primary{ background: rgba(255,255,255,.16); border-color: rgba(255,255,255,.28); }

    .adminGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      margin-top: 12px;
    }

    .panel{
      border-radius: var(--r-xl);
      padding: var(--pad);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    .panel h4{
      margin:0 0 10px;
      font-weight: 520;
      letter-spacing: .8px;
      color: rgba(255,255,255,.86);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin: 10px 0;
    }
    .field label{
      font-size: 12px;
      letter-spacing: .8px;
      color: rgba(255,255,255,.65);
    }
    .field input, .field select, .field textarea{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.90);
      border-radius: 14px;
      padding: 10px 12px;
      outline: none;
      font-size: 13px;
    }
    .field input[readonly]{ opacity: .9; }
    .field textarea{ min-height: 120px; resize: vertical; }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.55);
      margin-top: 6px;
      line-height: 1.35;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 10px;
      max-height: 260px;
      overflow:auto;
      padding-right: 6px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .row .left{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .row .name{
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 13px;
      color: rgba(255,255,255,.88);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 46ch;
    }
    .row .meta{
      font-size: 12px;
      color: rgba(255,255,255,.60);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 52ch;
    }
    .iconBtn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.86);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      white-space: nowrap;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.25); }
    .iconBtn.danger{ background: rgba(255,80,80,.12); border-color: rgba(255,80,80,.30); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(20,20,20,.55);
      color: rgba(255,255,255,.85);
      box-shadow: 0 16px 38px rgba(0,0,0,.45);
      display:none;
      z-index: 10000;
    }
    .toast.show{ display:block; }

    @media (max-width: 980px){
      header{ grid-template-columns: 1fr; }
      .search{ width: 100%; justify-self:stretch; }
      .main{ grid-template-columns: 1fr; }
      :root{ --cardW: clamp(150px, 26vw, 210px); }
      .shell{ width: 100%; min-height:auto; }
      .adminGrid{ grid-template-columns: 1fr; }
      .list{ max-height: 220px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="shell">
      <header class="glass">
        <div class="brand">
          <div class="big">CRACKUZU</div>
          <div class="small" id="adminEntry" title="Admin">
            BY CHARUZU <span class="pill" id="adminPill" style="display:none;">ADMIN</span>
          </div>
        </div>

        <label class="search" aria-label="Search">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
            <path d="M16.3 16.3 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="q" type="search" placeholder="search games" autocomplete="off" />
        </label>
      </header>

      <div class="main">
        <aside class="glass">
          <h2>CATEGORY</h2>
          <div class="catlist" id="catlist"></div>

          <div class="sidefoot">
            <a class="boondocks" href="https://discord.gg/ktx5Cb2we3" target="_blank" rel="noopener noreferrer">@THE_BOONDOCKS</a>
            <span class="pill" id="countPill">0</span>
          </div>
        </aside>

        <section class="glass">
          <div id="state" class="state" style="display:none;"></div>
          <div class="grid" id="grid"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="modalWrap" id="adminModal" aria-hidden="true">
    <div class="modal glass" role="dialog" aria-modal="true" aria-label="Admin">
      <div class="modalHead">
        <h3>ADMIN PANEL</h3>
        <div class="btnRow">
          <button class="btn" id="importBtn" type="button">Importer data.json</button>
          <button class="btn primary" id="publishBtn" type="button">Download data.json</button>
          <button class="btn danger" id="resetBtn" type="button">Reset local</button>
          <button class="btn primary" id="closeAdmin" type="button">Fermer</button>
        </div>
      </div>

      <div class="adminGrid">
        <div class="panel">
          <h4>Ajouter une catégorie</h4>
          <div class="field">
            <label for="catName">Nom catégorie</label>
            <input id="catName" placeholder="ex: ONLINE" />
          </div>
          <button class="btn primary" id="addCatBtn" type="button">Ajouter catégorie</button>

          <div class="hint">
            Les catégories sont stockées dans data.json. Après “Download data.json”, remplace le fichier dans ton repo GitHub.
          </div>

          <h4 style="margin-top:16px;">Catégories</h4>
          <div class="list" id="catListAdmin"></div>
        </div>

        <div class="panel">
          <h4 id="gameFormTitle">Ajouter un jeu</h4>

          <div class="field">
            <label for="gameName">Nom du jeu</label>
            <input id="gameName" placeholder="ex: Spider-Man 2" />
          </div>

          <div class="field">
            <label for="gameCat">Catégorie</label>
            <select id="gameCat"></select>
          </div>

          <div class="field">
            <label for="gameMagnet">Lien magnet</label>
            <input id="gameMagnet" placeholder="magnet:?xt=urn:btih:..." />
          </div>

          <div class="field">
            <label for="coverMode">Cover (mode)</label>
            <select id="coverMode">
              <option value="upload" selected>Upload → data URL</option>
              <option value="link">Lien/chemin</option>
            </select>
          </div>

          <div class="field" id="coverUploadWrap">
            <label for="gameCoverFile">Cover (fichier)</label>
            <input id="gameCoverFile" type="file" accept="image/*" />
          </div>

          <div class="field" id="coverLinkWrap" style="display:none;">
            <label for="gameCoverLink">Cover (lien/chemin)</label>
            <input id="gameCoverLink" placeholder="images/cover.jpg ou https://..." />
          </div>

          <div class="field">
            <label for="gameCover">Cover (valeur finale)</label>
            <input id="gameCover" placeholder="Rempli automatiquement..." readonly />
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="addGameBtn" type="button">Ajouter jeu</button>
            <button class="btn primary" id="saveEditBtn" type="button" style="display:none;">Sauvegarder modif</button>
            <button class="btn" id="cancelEditBtn" type="button" style="display:none;">Annuler</button>
          </div>

          <h4 style="margin-top:16px;">Jeux</h4>
          <div class="list" id="gameListAdmin"></div>

          <div class="hint">
            Upload = cover en data URL (base64) dans data.json, lien = tu gères toi-même images/ ou une URL.
          </div>
        </div>

        <div class="panel" style="grid-column: 1 / -1;">
          <h4>Preview JSON (lecture)</h4>
          <div class="field">
            <label for="jsonPreview">data.json généré</label>
            <textarea id="jsonPreview" readonly></textarea>
          </div>
        </div>
      </div>

      <input id="filePick" type="file" accept="application/json" style="display:none" />
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
    const ADMIN_PASSWORD = "141592";
    const LOCAL_KEY = "crackuzu:localDraft:v1";

    const DEFAULT_DATA = {
      categories: ["ALL", "ONLINE", "HORROR", "ACTION", "CAR RACE"],
      games: []
    };

    // ===== GITHUB CONFIG (DANGEREUX) =====
    const GITHUB_CONFIG = {
      token: "TON_TOKEN_GITHUB_ICI",
      owner: "TON_USERNAME",
      repo: "TON_REPO",
      branch: "main",
      path: "data.json"
    };


    const el = (id) => document.getElementById(id);
    const grid = el("grid");
    const catlist = el("catlist");
    const q = el("q");
    const stateBox = el("state");
    const countPill = el("countPill");

    const adminEntry = el("adminEntry");
    const adminPill = el("adminPill");
    const adminModal = el("adminModal");
    const closeAdmin = el("closeAdmin");

    const catName = el("catName");
    const addCatBtn = el("addCatBtn");
    const catListAdmin = el("catListAdmin");

    const gameFormTitle = el("gameFormTitle");
    const gameName = el("gameName");
    const gameCat = el("gameCat");
    const gameMagnet = el("gameMagnet");

    const coverMode = el("coverMode");
    const coverUploadWrap = el("coverUploadWrap");
    const coverLinkWrap = el("coverLinkWrap");
    const gameCoverFile = el("gameCoverFile");
    const gameCoverLink = el("gameCoverLink");
    const gameCover = el("gameCover");

    const addGameBtn = el("addGameBtn");
    const saveEditBtn = el("saveEditBtn");
    const cancelEditBtn = el("cancelEditBtn");

    const gameListAdmin = el("gameListAdmin");

    const jsonPreview = el("jsonPreview");
    const publishBtn = el("publishBtn");
    const resetBtn = el("resetBtn");
    const toast = el("toast");

    const importBtn = el("importBtn");
    const filePick = el("filePick");

    const state = {
      data: structuredClone(DEFAULT_DATA),
      activeCat: "ALL",
      query: "",
      adminUnlocked: false
    };

    let editIndex = null;

    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toast.classList.remove("show"), 1200);
    }

    function norm(s){ return (s || "").trim(); }
    function upper(s){ return norm(s).toUpperCase(); }

    function sanitizeData(d){
      const out = { categories: [], games: [] };
      const cats = Array.isArray(d?.categories) ? d.categories : [];
      const games = Array.isArray(d?.games) ? d.games : [];

      const uniq = new Set();
      cats.forEach(c => {
        const v = upper(c);
        if(!v) return;
        if(uniq.has(v)) return;
        uniq.add(v);
        out.categories.push(v);
      });
      if(!out.categories.includes("ALL")) out.categories.unshift("ALL");

      out.games = games
        .map(g => ({
          name: norm(g?.name),
          cat: upper(g?.cat),
          magnet: norm(g?.magnet).replaceAll("&amp;", "&"),
          cover: norm(g?.cover)
        }))
        .filter(g => g.name && g.cat && g.magnet && g.cover);

      return out;
    }

    async function loadDataFromRepo(){
      try{
        const res = await fetch("./data.json", { cache: "no-store" }); // fetch JSON [web:168]
        if(!res.ok) throw new Error("no data.json");
        const json = await res.json(); // parse JSON [web:205]
        return sanitizeData(json);
      }catch{
        return null;
      }
    }

    function loadLocalDraft(){
      try{
        const raw = localStorage.getItem(LOCAL_KEY);
        if(!raw) return null;
        return sanitizeData(JSON.parse(raw));
      }catch{
        return null;
      }
    }

    function saveLocalDraft(){
      localStorage.setItem(LOCAL_KEY, JSON.stringify(state.data));
      refreshPreview();
    }

    function setStateMessage(msg){
      if(!msg){
        stateBox.style.display = "none";
        stateBox.textContent = "";
        return;
      }
      stateBox.style.display = "block";
      stateBox.textContent = msg;
    }

    function refreshPreview(){
      jsonPreview.value = JSON.stringify(state.data, null, 2);
    }

    function renderCategories(){
      catlist.innerHTML = "";
      const cats = state.data.categories;

      cats.forEach(cat => {
        const b = document.createElement("button");
        b.className = "catbtn" + (state.activeCat === cat ? " active" : "");
        b.type = "button";
        b.textContent = cat;
        b.addEventListener("click", () => {
          state.activeCat = cat;
          renderCategories();
          renderGames();
        });
        catlist.appendChild(b);
      });

      gameCat.innerHTML = "";
      cats.filter(c => c !== "ALL").forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        gameCat.appendChild(opt);
      });
    }

    function renderGames(){
      const query = (state.query || "").toLowerCase();
      const active = state.activeCat;

      grid.innerHTML = "";
      let shown = 0;

      state.data.games.forEach(g => {
        const title = (g.name || "").toLowerCase();
        const okCat = (active === "ALL") || (upper(g.cat) === active);
        const okText = !query || title.includes(query);
        if(!(okCat && okText)) return;

        const card = document.createElement("article");
        card.className = "card";

        const img = document.createElement("img");
        img.src = g.cover;
        img.alt = g.name;
        card.appendChild(img);

        const a = document.createElement("a");
        a.className = "download";
        a.href = g.magnet;
        a.textContent = "Download";
        card.appendChild(a);

        grid.appendChild(card);
        shown++;
      });

      countPill.textContent = String(shown);
      if(shown === 0) setStateMessage("Aucun jeu trouvé.");
      else setStateMessage("");
    }

    function setCoverMode(mode){
      if(mode === "link"){
        coverUploadWrap.style.display = "none";
        coverLinkWrap.style.display = "";
        gameCover.value = norm(gameCoverLink.value);
      }else{
        coverUploadWrap.style.display = "";
        coverLinkWrap.style.display = "none";
        // cover filled by upload; keep current if already set
        if(!gameCover.value) gameCover.value = "";
      }
    }

    coverMode.addEventListener("change", () => setCoverMode(coverMode.value));
    gameCoverLink.addEventListener("input", () => {
      if(coverMode.value === "link"){
        gameCover.value = norm(gameCoverLink.value);
      }
    });

    // File picker -> convert image to data URL base64 [web:308]
    gameCoverFile.addEventListener("change", () => {
      const file = gameCoverFile.files?.[0];
      if(!file) return;

      const reader = new FileReader();
      reader.addEventListener("load", () => {
        gameCover.value = String(reader.result || "");
        toastMsg("Cover convertie");
        coverMode.value = "upload";
        setCoverMode("upload");
      });
      reader.readAsDataURL(file);
    });

    function exitEditMode(){
      editIndex = null;
      gameFormTitle.textContent = "Ajouter un jeu";
      addGameBtn.style.display = "";
      saveEditBtn.style.display = "none";
      cancelEditBtn.style.display = "none";

      gameName.value = "";
      gameMagnet.value = "";
      gameCover.value = "";
      gameCoverLink.value = "";
      gameCoverFile.value = "";
      coverMode.value = "upload";
      setCoverMode("upload");
    }

    cancelEditBtn.addEventListener("click", () => {
      exitEditMode();
      toastMsg("Annulé");
    });

    function renderAdminLists(){
      catListAdmin.innerHTML = "";
      state.data.categories
        .filter(c => c !== "ALL")
        .forEach(c => {
          const row = document.createElement("div");
          row.className = "row";

          const left = document.createElement("div");
          left.className = "left";
          left.innerHTML = `<div class="name">${c}</div><div class="meta">Catégorie</div>`;

          const del = document.createElement("button");
          del.className = "iconBtn danger";
          del.type = "button";
          del.textContent = "Suppr";
          del.addEventListener("click", () => {
            const ok = confirm(`Supprimer la catégorie "${c}" et ses jeux ?`);
            if(!ok) return;
            state.data.categories = state.data.categories.filter(x => x !== c);
            state.data.games = state.data.games.filter(g => upper(g.cat) !== c);
            if(state.activeCat === c) state.activeCat = "ALL";
            saveLocalDraft();
            renderCategories();
            renderGames();
            renderAdminLists();
            toastMsg("Catégorie supprimée");
          });

          row.appendChild(left);
          row.appendChild(del);
          catListAdmin.appendChild(row);
        });

      gameListAdmin.innerHTML = "";
      state.data.games.forEach((g, idx) => {
        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "left";
        left.innerHTML = `<div class="name">${g.name}</div><div class="meta">${upper(g.cat)} • cover:${(g.cover || "").startsWith("data:") ? "data-url" : g.cover}</div>`;

        const edit = document.createElement("button");
        edit.className = "iconBtn";
        edit.type = "button";
        edit.textContent = "Modif";
        edit.addEventListener("click", () => {
          editIndex = idx;
          gameFormTitle.textContent = "Modifier un jeu";
          addGameBtn.style.display = "none";
          saveEditBtn.style.display = "";
          cancelEditBtn.style.display = "";

          // Pre-fill
          gameName.value = g.name;
          gameMagnet.value = g.magnet;

          // Ensure category exists
          const cat = upper(g.cat);
          if(!state.data.categories.includes(cat)) state.data.categories.push(cat);
          renderCategories();
          gameCat.value = cat;

          // Cover prefill
          if((g.cover || "").startsWith("data:")){
            coverMode.value = "upload";
            setCoverMode("upload");
            gameCover.value = g.cover;
            gameCoverFile.value = "";
            gameCoverLink.value = "";
          }else{
            coverMode.value = "link";
            gameCoverLink.value = g.cover;
            setCoverMode("link");
          }

          toastMsg("Mode modification");
        });

        const del = document.createElement("button");
        del.className = "iconBtn danger";
        del.type = "button";
        del.textContent = "Suppr";
        del.addEventListener("click", () => {
          const ok = confirm(`Supprimer "${g.name}" ?`);
          if(!ok) return;
          state.data.games.splice(idx, 1);
          saveLocalDraft();
          renderGames();
          renderAdminLists();
          if(editIndex === idx) exitEditMode();
          toastMsg("Jeu supprimé");
        });

        row.appendChild(left);
        row.appendChild(edit);
        row.appendChild(del);
        gameListAdmin.appendChild(row);
      });
    }

    function openAdmin(){
      adminModal.classList.add("open");
      adminModal.setAttribute("aria-hidden", "false");
      refreshPreview();
      renderAdminLists();
    }
    function closeAdminModal(){
      adminModal.classList.remove("open");
      adminModal.setAttribute("aria-hidden", "true");
    }

    adminEntry.addEventListener("click", () => {
      const pwd = prompt("Admin password:");
      if(pwd === ADMIN_PASSWORD){
        state.adminUnlocked = true;
        adminPill.style.display = "inline-flex";
        toastMsg("Admin unlocked");
        openAdmin();
      }else{
        toastMsg("Wrong password");
      }
    });

    closeAdmin.addEventListener("click", closeAdminModal);
    adminModal.addEventListener("click", (e) => { if(e.target === adminModal) closeAdminModal(); });
    window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeAdminModal(); });

    q.addEventListener("input", () => {
      state.query = q.value || "";
      renderGames();
    });

    addCatBtn.addEventListener("click", () => {
      const name = upper(catName.value);
      if(!name) return toastMsg("Catégorie vide");
      if(name === "ALL") return toastMsg("ALL est réservé");
      if(state.data.categories.includes(name)) return toastMsg("Déjà existe");

      state.data.categories.push(name);
      catName.value = "";
      saveLocalDraft();
      renderCategories();
      renderAdminLists();
      toastMsg("Catégorie ajoutée");
    });

    addGameBtn.addEventListener("click", () => {
      if(editIndex !== null) return toastMsg("Tu es en mode modif (annule ou sauvegarde).");

      const name = norm(gameName.value);
      const cat = upper(gameCat.value);
      const magnet = norm(gameMagnet.value).replaceAll("&amp;", "&");
      const cover = norm(gameCover.value);

      if(!name) return toastMsg("Nom manquant");
      if(!cat || cat === "ALL") return toastMsg("Catégorie invalide");
      if(!magnet.startsWith("magnet:")) return toastMsg("Magnet invalide");
      if(!cover) return toastMsg("Cover manquante");

      if(!state.data.categories.includes(cat)) state.data.categories.push(cat);

      state.data.games.unshift({ name, cat, magnet, cover });

      gameName.value = "";
      gameMagnet.value = "";
      gameCover.value = "";
      gameCoverFile.value = "";
      gameCoverLink.value = "";

      coverMode.value = "upload";
      setCoverMode("upload");

      saveLocalDraft();
      renderGames();
      renderCategories();
      renderAdminLists();
      toastMsg("Jeu ajouté");
    });

    saveEditBtn.addEventListener("click", () => {
      if(editIndex === null) return;

      const name = norm(gameName.value);
      const cat = upper(gameCat.value);
      const magnet = norm(gameMagnet.value).replaceAll("&amp;", "&");
      const cover = norm(gameCover.value);

      if(!name) return toastMsg("Nom manquant");
      if(!cat || cat === "ALL") return toastMsg("Catégorie invalide");
      if(!magnet.startsWith("magnet:")) return toastMsg("Magnet invalide");
      if(!cover) return toastMsg("Cover manquante");

      if(!state.data.categories.includes(cat)) state.data.categories.push(cat);

      state.data.games[editIndex] = { name, cat, magnet, cover };

      saveLocalDraft();
      renderGames();
      renderCategories();
      renderAdminLists();
      exitEditMode();
      toastMsg("Modif sauvegardée");
    });

    function downloadDataJson(){
      const json = JSON.stringify(state.data, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "data.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

	publishToGithub()


    resetBtn.addEventListener("click", () => {
      const ok = confirm("Reset local: revenir aux données du repo ?");
      if(!ok) return;
      localStorage.removeItem(LOCAL_KEY);
      toastMsg("Draft local supprimé");
      init();
      closeAdminModal();
    });

    importBtn.addEventListener("click", () => filePick.click());
    filePick.addEventListener("change", async () => {
      const f = filePick.files?.[0];
      filePick.value = "";
      if(!f) return;
      try{
        const text = await f.text();
        const json = sanitizeData(JSON.parse(text));
        state.data = json;
        saveLocalDraft();
        renderCategories();
        renderGames();
        renderAdminLists();
        exitEditMode();
        toastMsg("Import OK");
      }catch{
        toastMsg("Import invalide");
      }
    });

    async function init(){
      setStateMessage("Chargement…");

      const repoData = await loadDataFromRepo();
      const localDraft = loadLocalDraft();

      if(localDraft){
        state.data = localDraft;
        setStateMessage("");
      }else if(repoData){
        state.data = repoData;
        setStateMessage("");
      }else{
        state.data = structuredClone(DEFAULT_DATA);
        setStateMessage("data.json introuvable (mode local).");
      }

      state.activeCat = "ALL";
      state.query = "";
      q.value = "";

      editIndex = null;
      exitEditMode();

      refreshPreview();
      renderCategories();
      renderGames();
      renderAdminLists();
    }

    init();
  </script>
</body>
</html>
