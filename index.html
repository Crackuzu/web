<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRACKUZU</title>

  <style>
    :root{
      --bg0:#0b0e12;
      --bg1:#10151b;

      --glass: rgba(255,255,255,.065);
      --glass2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.11);
      --stroke2: rgba(255,255,255,.16);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --outer: clamp(14px, 2.2vw, 26px);
      --gap:   clamp(12px, 1.2vw, 18px);
      --pad:   clamp(14px, 1.6vw, 20px);

      --r-xl:  clamp(18px, 2vw, 26px);
      --r-md:  clamp(14px, 1.5vw, 18px);

      --shadow: 0 28px 90px rgba(0,0,0,.58);
      --shadow2: 0 18px 46px rgba(0,0,0,.45);

      --side: clamp(250px, 20vw, 330px);
      --cardW: clamp(140px, 10.5vw, 185px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(255,255,255,.09), transparent 55%),
        radial-gradient(950px 600px at 90% 20%, rgba(255,255,255,.07), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .glass{
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }
    @supports ((-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px))){
      .glass{
        -webkit-backdrop-filter: blur(14px);
        backdrop-filter: blur(14px);
      }
    }

    .app{
      min-height: 100vh;
      min-height: 100dvh;
      padding: var(--outer);
      width: 100%;
    }

    .shell{
      width: min(1800px, calc(100dvw - (2 * var(--outer))));
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      min-height: calc(100dvh - (2 * var(--outer)));
    }

    header{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap: var(--gap);
      min-height: clamp(86px, 10vh, 120px);
    }

    .brand{
      text-align:center;
      user-select:none;
      line-height:1.05;
    }
    .brand .big{
      font-weight: 300;
      letter-spacing: clamp(1px, .25vw, 2.5px);
      font-size: clamp(28px, 3.2vw, 46px);
      opacity:.92;
    }
    .brand .small{
      margin-top: 4px;
      font-size: clamp(12px, 1.1vw, 14px);
      letter-spacing: clamp(2px, .35vw, 3.5px);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor: pointer;
    }
    .brand .small:hover{ color: rgba(255,255,255,.78); }

    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.70);
      letter-spacing: 1px;
    }

    .search{
      width: clamp(220px, 26vw, 360px);
      height: clamp(34px, 4.2vh, 40px);
      border-radius: 999px;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 14px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.085);
      justify-self:end;
    }
    .search svg{ width: 18px; height: 18px; opacity:.78; }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color: var(--text);
      font-size: clamp(13px, 1.1vw, 14px);
    }
    .search input::placeholder{ color: rgba(255,255,255,.55); }

    .main{
      flex: 1;
      min-height: 0;
      display:grid;
      grid-template-columns: var(--side) 1fr;
      gap: var(--gap);
    }

    aside{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    aside h2{
      margin: 6px 0 12px;
      text-align:center;
      font-weight: 300;
      letter-spacing: clamp(1px, .3vw, 2.2px);
      font-size: clamp(22px, 2.3vw, 28px);
      color: rgba(255,255,255,.86);
    }

    .catlist{
      display:flex;
      flex-direction:column;
      gap: clamp(10px, 1.2vw, 14px);
      margin-top: clamp(10px, 1.3vw, 18px);
    }

    .catbtn{
      height: clamp(46px, 5.8vh, 54px);
      border-radius: clamp(14px, 1.4vw, 16px);
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      font-weight: 520;
      letter-spacing: 1px;
      color: rgba(255,255,255,.70);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease, color .15s ease;
      user-select:none;
    }
    .catbtn:hover{
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.25);
      transform: translateY(-1px);
      color: rgba(255,255,255,.86);
    }
    .catbtn.active{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.28);
      color: rgba(255,255,255,.92);
    }

    .sidefoot{
      margin-top:auto;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: rgba(255,255,255,.55);
      font-size: clamp(12px, 1.05vw, 13px);
      letter-spacing: .8px;
    }
    .sidefoot .boondocks{ color: rgba(255,255,255,.55); text-decoration: none; }
    .sidefoot .boondocks:hover{ color: rgba(255,255,255,.80); text-decoration: underline; }

    section{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      min-height: 0;
      overflow:auto;
    }

    .grid{
      display:grid;
      gap: var(--gap);
      grid-template-columns: repeat(auto-fill, minmax(var(--cardW), 1fr));
      align-content: start;
    }

    /* Hover card */
    .card{
      position: relative;
      border-radius: var(--r-md);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      aspect-ratio: 3 / 4;

      transform: translateZ(0);
      transition: transform .22s ease, border-color .22s ease;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      background:
        radial-gradient(600px 260px at 30% 10%, rgba(170,140,255,.28), transparent 60%),
        radial-gradient(500px 240px at 80% 90%, rgba(0,210,255,.20), transparent 55%);
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-18px;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.20),
          rgba(255,255,255,.10) 40%,
          transparent 70%);
    }
    .card:hover{
      transform: translateY(-6px) scale(1.015);
      border-color: rgba(255,255,255,.24);
    }
    .card:hover::before,
    .card:hover::after{
      opacity:1;
    }

    .card img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter: brightness(.86) saturate(1.05);
      transition: filter .22s ease;
    }
    .card:hover img{
      filter: brightness(1.05) saturate(1.12);
    }

    .cinfo{
      position:absolute;
      left:0; right:0; bottom:0;
      padding: clamp(12px, 1.4vw, 16px);
      background: linear-gradient(to top, rgba(0,0,0,.88), transparent);
      display:flex;
      flex-direction:column;
      gap: clamp(6px, .8vw, 8px);
      pointer-events:none;
      opacity:0;
      transform: translateY(8px);
      transition: opacity .22s ease, transform .22s ease;
    }
    .card:hover .cinfo{
      opacity:1;
      transform: translateY(0);
    }
    .cinfo .gname{
      font-weight: 600;
      letter-spacing: .6px;
      font-size: clamp(13px, 1.1vw, 14px);
      color: rgba(255,255,255,.95);
    }
    .cinfo .catpill{
      display:inline-flex;
      align-self:flex-start;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.30);
      padding: clamp(3px, .4vw, 4px) clamp(7px, .8vw, 9px);
      border-radius: 999px;
      font-size: clamp(10px, .92vw, 11px);
      color: rgba(255,255,255,.85);
      letter-spacing: .8px;
    }

    /* Multi-categories tags */
    .catTags{
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }
    .catTags .miniPill{
      background: rgba(100,180,255,.20);
      border: 1px solid rgba(100,180,255,.35);
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 9px;
      color: rgba(200,220,255,.90);
      letter-spacing: .5px;
    }

    /* Download button */
    .dlBtn{
      position:absolute;
      top: clamp(8px, 1vw, 12px);
      right: clamp(8px, 1vw, 12px);
      width: clamp(36px, 4vw, 42px);
      height: clamp(36px, 4vw, 42px);
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(100,180,255,.85), rgba(150,100,255,.75));
      border: 1.5px solid rgba(255,255,255,.35);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8) translateY(-4px);
      transition: all .22s ease;
      pointer-events: auto;
      z-index: 10;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
    }
    .card:hover .dlBtn{
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    .dlBtn:hover{
      background: linear-gradient(135deg, rgba(120,200,255,.95), rgba(170,120,255,.85));
      transform: scale(1.1) translateY(-2px);
      box-shadow: 0 6px 20px rgba(100,180,255,.5);
    }
    .dlBtn svg{
      width: clamp(18px, 2vw, 22px);
      height: clamp(18px, 2vw, 22px);
      color: #fff;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,.3));
    }

    .stateMsg{
      text-align:center;
      color: rgba(255,255,255,.65);
      font-size: clamp(13px, 1.1vw, 14px);
      letter-spacing: .8px;
      padding: clamp(20px, 3vw, 40px);
    }

    .modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index:999;
      align-items:center;
      justify-content:center;
      padding: clamp(20px, 3vw, 40px);
    }
    .modal.open{ display:flex; }

    .modalBox{
      background: linear-gradient(155deg, rgba(20,25,35,.92), rgba(14,18,26,.95));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: clamp(18px, 2.2vw, 28px);
      padding: clamp(24px, 3vw, 40px);
      width: min(900px, 100%);
      max-height: 90vh;
      overflow:auto;
      box-shadow: 0 40px 140px rgba(0,0,0,.75);
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: clamp(18px, 2.2vw, 28px);
    }
    .modalHeader h2{
      margin:0;
      font-size: clamp(22px, 2.4vw, 28px);
      font-weight: 300;
      letter-spacing: clamp(1px, .3vw, 2px);
      color: rgba(255,255,255,.88);
    }
    .closeBtn{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 50%;
      width: clamp(30px, 3.6vw, 38px);
      height: clamp(30px, 3.6vw, 38px);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: clamp(18px, 2vw, 22px);
      color: rgba(255,255,255,.75);
      transition: background .15s ease, border-color .15s ease;
    }
    .closeBtn:hover{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.28);
    }

    .adminSect{
      margin-bottom: clamp(22px, 2.6vw, 32px);
    }
    .adminSect h3{
      margin: 0 0 clamp(10px, 1.2vw, 14px);
      font-size: clamp(16px, 1.6vw, 18px);
      font-weight: 500;
      letter-spacing: 1px;
      color: rgba(255,255,255,.82);
    }

    .formRow{
      display:flex;
      gap: clamp(10px, 1.2vw, 14px);
      margin-bottom: clamp(12px, 1.4vw, 16px);
      align-items:flex-start;
    }
    .formRow input, .formRow select, .formRow textarea{
      flex:1;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: clamp(10px, 1.2vw, 12px);
      padding: clamp(9px, 1vw, 11px) clamp(12px, 1.3vw, 14px);
      color: var(--text);
      font-size: clamp(13px, 1.1vw, 14px);
      outline:0;
      transition: border-color .15s ease, background .15s ease;
    }
    .formRow input:focus, .formRow select:focus, .formRow textarea:focus{
      background: rgba(255,255,255,.11);
      border-color: rgba(255,255,255,.28);
    }

    .iconBtn, .bigBtn{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.20);
      border-radius: clamp(10px, 1.2vw, 12px);
      padding: clamp(9px, 1vw, 11px) clamp(14px, 1.6vw, 18px);
      color: rgba(255,255,255,.86);
      font-size: clamp(13px, 1.1vw, 14px);
      letter-spacing: .6px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .12s ease;
    }
    .iconBtn:hover, .bigBtn:hover{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.32);
      transform: translateY(-1px);
    }
    .iconBtn:active, .bigBtn:active{
      transform: translateY(0);
    }

    .iconBtn.danger{
      background: rgba(255,80,80,.14);
      border-color: rgba(255,80,80,.30);
      color: rgba(255,150,150,.92);
    }
    .iconBtn.danger:hover{
      background: rgba(255,80,80,.20);
      border-color: rgba(255,80,80,.42);
    }

    .bigBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      font-weight: 500;
    }

    .list{
      margin-top: clamp(10px, 1.2vw, 14px);
      display:flex;
      flex-direction:column;
      gap: clamp(8px, 1vw, 12px);
    }
    .list .row{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.11);
      border-radius: clamp(10px, 1.2vw, 12px);
      padding: clamp(10px, 1.2vw, 14px);
      display:flex;
      gap: clamp(8px, 1vw, 12px);
      align-items:center;
    }
    .list .row .left{
      flex:1;
      min-width:0;
    }
    .list .row .name{
      font-weight: 600;
      font-size: clamp(13px, 1.1vw, 14px);
      color: rgba(255,255,255,.90);
      letter-spacing: .5px;
      margin-bottom: 4px;
    }
    .list .row .meta{
      font-size: clamp(11px, .95vw, 12px);
      color: rgba(255,255,255,.55);
      letter-spacing: .4px;
    }

    .coverGroup{
      display:flex;
      flex-direction:column;
      gap: clamp(10px, 1.2vw, 14px);
    }
    .coverLine{
      display:flex;
      gap: clamp(10px, 1.2vw, 14px);
      align-items:center;
    }
    .coverLine label{
      flex-shrink:0;
      font-size: clamp(13px, 1.1vw, 14px);
      letter-spacing: .5px;
      color: rgba(255,255,255,.78);
    }
    .coverLine input[type="radio"]{
      transform: scale(1.2);
      cursor:pointer;
    }
    .coverInputWrap{
      display:none;
    }
    .coverInputWrap.active{ display:block; }

    .previewWrap{
      margin-top: clamp(12px, 1.4vw, 16px);
      background: rgba(0,0,0,.40);
      border-radius: clamp(10px, 1.2vw, 12px);
      padding: clamp(10px, 1.2vw, 14px);
      text-align:center;
    }
    .previewWrap img{
      max-width: 160px;
      max-height: 240px;
      border-radius: clamp(8px, 1vw, 10px);
      border: 1px solid rgba(255,255,255,.16);
    }

    .publishWrap{
      margin-top: clamp(14px, 1.6vw, 18px);
      display:flex;
      gap: clamp(10px, 1.2vw, 14px);
      flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      top: 50%; left:50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,.90);
      border: 1px solid rgba(255,255,255,.20);
      border-radius: clamp(12px, 1.4vw, 16px);
      padding: clamp(12px, 1.4vw, 16px) clamp(18px, 2vw, 24px);
      color: rgba(255,255,255,.92);
      font-size: clamp(13px, 1.1vw, 14px);
      letter-spacing: .6px;
      z-index:9999;
      box-shadow: 0 20px 60px rgba(0,0,0,.75);
      pointer-events:none;
      opacity:0;
      transition: opacity .2s ease;
    }
    .toast.show{ opacity:1; }

    /* Cat√©gories auto */
    .autoCatSection{
      margin-top: 16px;
      padding: 16px;
      background: rgba(100,180,255,.08);
      border: 1px solid rgba(100,180,255,.15);
      border-radius: 12px;
    }
    .autoCatTags{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .autoCatTag{
      background: rgba(100,180,255,.15);
      border: 1px solid rgba(100,180,255,.30);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: rgba(200,220,255,.95);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .autoCatTag.new{
      background: rgba(100,255,150,.15);
      border-color: rgba(100,255,150,.30);
    }

    @media(max-width: 900px){
      .main{ grid-template-columns: 1fr; }
      aside{ display:none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="shell">
      <header class="glass">
        <div class="brand">
          <div class="big">CRACKUZU</div>
          <div class="small">
            <span id="adminEntry">BY CHARUZU</span>
            <span class="pill" id="adminPill" style="display:none;">ADMIN</span>
          </div>
        </div>
        <div class="search">
          <svg fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="q" placeholder="Chercher un jeu‚Ä¶" />
        </div>
      </header>

      <div class="main">
        <aside class="glass">
          <h2>CAT√âGORIES</h2>
          <div class="catlist" id="catlist"></div>
          <div class="sidefoot">
            <a href="https://www.google.com" target="_blank" class="boondocks">LIEN</a>
            <span id="catCount">0 JEUX</span>
          </div>
        </aside>

        <section class="glass">
          <div id="stateMsg" class="stateMsg"></div>
          <div class="grid" id="grid"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- ADMIN MODAL -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <h2>ADMIN PANEL - Cat√©gories Automatiques</h2>
        <button class="closeBtn" id="closeAdmin" aria-label="Close">√ó</button>
      </div>

      <!-- ADD CATEGORY (manuel) -->
      <div class="adminSect">
        <h3>Configuration GitHub</h3>
        <div class="formRow">
          <input type="password" id="githubToken" placeholder="GitHub Token (ghp_...)" value="" />
          <button class="iconBtn" id="saveTokenBtn">üíæ Sauvegarder</button>
        </div>
        <div style="font-size: 12px; color: rgba(255,255,255,.55); margin-top: 8px;">
          Le token est stock√© localement dans ton navigateur (jamais dans le code).
        </div>
      </div>

      <!-- ADD CATEGORY (manuel) -->
      <div class="adminSect">
        <h3>Ajouter une cat√©gorie manuellement</h3>
        <div class="formRow">
          <input type="text" id="catName" placeholder="NOM EN MAJUSCULE" />
          <button class="iconBtn" id="addCatBtn">Ajouter</button>
        </div>
      </div>

      <!-- ADD GAME - NOUVELLE VERSION -->
      <div class="adminSect">
        <h3 id="gameFormTitle">Ajouter un jeu (Cat√©gories Automatiques)</h3>
        <div class="formRow">
          <input type="text" id="gameName" placeholder="Nom exact du jeu (ex: 'Dying Light')" />
          <button class="iconBtn" id="searchGameBtn">üîç Rechercher cat√©gories</button>
        </div>
        
        <!-- R√©sultat de recherche cat√©gories -->
        <div id="rawgResult" style="display:none;">
          <div class="autoCatSection">
            <h4 style="margin:0 0 8px; font-size:15px; color:rgba(255,255,255,.9);">Cat√©gories d√©tect√©es:</h4>
            
            <div id="rawgTitle" style="font-weight:600; color:rgba(255,255,255,.95); margin-bottom:8px;"></div>
            
            <h5 style="margin:12px 0 8px; font-size:14px; color:rgba(255,255,255,.9);">Cat√©gories qui seront ajout√©es:</h5>
            <div class="autoCatTags" id="autoCatTags"></div>
            
            <div style="margin-top:12px; font-size:12px; color:rgba(255,255,255,.6);">
              <em>Les cat√©gories en vert seront cr√©√©es automatiquement</em>
            </div>
          </div>
        </div>
        
        <div class="formRow">
          <textarea id="gameMagnet" rows="3" placeholder="magnet:?xt=... (obligatoire)"></textarea>
        </div>

        <div class="coverGroup">
          <div class="coverLine">
            <label>Cover URL (ou Ctrl+V pour coller une image)</label>
          </div>

          <div class="coverInputWrap active" id="linkWrap">
            <input type="text" id="gameCoverLink" placeholder="https://...image.jpg ou Ctrl+V pour uploader" />
          </div>
        </div>

        <div class="previewWrap" id="previewWrap" style="display:none;">
          <img id="previewImg" alt="Preview" />
        </div>

        <input type="hidden" id="gameCover" />

        <!-- Section pour cat√©gories manuelles additionnelles -->
        <div class="adminSect" style="margin-top:24px;">
          <h4>Ajouter des cat√©gories manuellement (optionnel)</h4>
          <div class="formRow" style="align-items:center;">
            <select id="additionalCatSelect" style="flex:1;">
              <option value="">S√©lectionner une cat√©gorie existante</option>
            </select>
            <button class="iconBtn" id="addAdditionalCatBtn">+ Ajouter</button>
          </div>
          <div id="manualCatTags" class="autoCatTags" style="margin-top:12px;"></div>
          <input type="hidden" id="additionalCategories" value="" />
        </div>

        <div class="formRow" style="margin-top:18px;">
          <button class="bigBtn" id="addGameBtn">Ajouter le jeu</button>
          <button class="bigBtn" id="saveEditBtn" style="display:none;">Sauvegarder modif</button>
          <button class="iconBtn" id="cancelEditBtn" style="display:none;">Annuler</button>
        </div>
      </div>

      <!-- PUBLISH & TOOLS -->
      <div class="adminSect">
        <h3>Publier & Outils</h3>
        <div class="publishWrap">
          <button class="bigBtn" id="publishBtn">üöÄ Upload to GitHub</button>
          <button class="bigBtn" id="downloadBtn">üíæ Download data.json</button>
          <button class="bigBtn" id="resetBtn">‚ôªÔ∏è Reset local</button>
          <button class="bigBtn" id="importBtn">üì• Import JSON</button>
        </div>
        <input type="file" id="filePick" accept=".json" style="display:none;" />
      </div>

      <!-- LISTS -->
      <div class="adminSect">
        <h3>Cat√©gories (clic = activer)</h3>
        <div class="list" id="catListAdmin"></div>
      </div>
      <div class="adminSect">
        <h3>Jeux</h3>
        <div class="list" id="gameListAdmin"></div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <script>
    // ========== CONFIGURATION ==========
    const CATEGORIES_WORKER_URL = 'https://crackuzu-categories.crackuzu.workers.dev';
    const WORKER_URL = 'https://crackuzu-api.crackuzu.workers.dev'; // Pour le reste
    
    const GITHUB_CONFIG = {
      token: "",
      owner: "Crackuzu",
      repo: "web",
      branch: "main",
      path: "data.json"
    };
    
    const ADMIN_PASSWORD = "141592";
    const LOCAL_KEY = "crackuzu_local_draft";

    // Structure par d√©faut AVEC multi-cat√©gories
    const DEFAULT_DATA = {
      categories: ["ONLINE", "HORROR", "ACTION", "CAR RACE", "RESIDENT EVIL", "SURVIVAL", "SOLO", "SIMULATOR"],
      games: []
    };

    const state = {
      data: structuredClone(DEFAULT_DATA),
      adminUnlocked: false,
      activeCat: "ALL",
      query: "",
      rawgGameData: null, // Stocke les donn√©es RAWG pendant l'ajout
      additionalCategories: [] // Cat√©gories manuelles additionnelles
    };

    let editIndex = null;

    // ========== √âL√âMENTS DOM ==========
    const q = document.getElementById("q");
    const catlist = document.getElementById("catlist");
    const catCount = document.getElementById("catCount");
    const grid = document.getElementById("grid");
    const stateMsg = document.getElementById("stateMsg");

    const adminModal = document.getElementById("adminModal");
    const closeAdmin = document.getElementById("closeAdmin");
    const adminPill = document.getElementById("adminPill");
    const adminEntry = document.getElementById("adminEntry");

    const githubToken = document.getElementById("githubToken");
    const saveTokenBtn = document.getElementById("saveTokenBtn");

    const catName = document.getElementById("catName");
    const addCatBtn = document.getElementById("addCatBtn");

    const gameFormTitle = document.getElementById("gameFormTitle");
    const gameName = document.getElementById("gameName");
    const gameMagnet = document.getElementById("gameMagnet");
    const gameCover = document.getElementById("gameCover");
    const gameCoverLink = document.getElementById("gameCoverLink");
    const searchGameBtn = document.getElementById("searchGameBtn");

    const rawgResult = document.getElementById("rawgResult");
    const rawgTitle = document.getElementById("rawgTitle");
    const autoCatTags = document.getElementById("autoCatTags");

    const additionalCatSelect = document.getElementById("additionalCatSelect");
    const addAdditionalCatBtn = document.getElementById("addAdditionalCatBtn");
    const manualCatTags = document.getElementById("manualCatTags");
    const additionalCategoriesInput = document.getElementById("additionalCategories");

    const previewWrap = document.getElementById("previewWrap");
    const previewImg = document.getElementById("previewImg");

    const addGameBtn = document.getElementById("addGameBtn");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    const publishBtn = document.getElementById("publishBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const resetBtn = document.getElementById("resetBtn");
    const importBtn = document.getElementById("importBtn");
    const filePick = document.getElementById("filePick");

    const catListAdmin = document.getElementById("catListAdmin");
    const gameListAdmin = document.getElementById("gameListAdmin");

    const toast = document.getElementById("toast");

    // ========== HELPERS ==========
    function norm(s){ return (s || "").trim(); }
    function upper(s){ return (s || "").toUpperCase().trim(); }
    
    // CORRECTION CRITIQUE: Fonction de sanitization qui g√®re l'ancien format 'cat' et le nouveau 'categories'
    function sanitizeData(obj){
      const result = {
        categories: Array.isArray(obj.categories) ? obj.categories.map(upper).filter(Boolean) : [],
        games: []
      };
      
      // Traiter chaque jeu
      if (Array.isArray(obj.games)) {
        result.games = obj.games.map(g => {
          // D√©terminer les cat√©gories (support ancien format 'cat' et nouveau 'categories')
          let categories = [];
          
          if (Array.isArray(g.categories)) {
            // Nouveau format: categories est un array
            categories = g.categories.map(upper).filter(Boolean);
          } else if (g.cat) {
            // Ancien format: cat est une string
            categories = [upper(g.cat)].filter(Boolean);
          }
          
          // S'assurer qu'il y a au moins une cat√©gorie
          if (categories.length === 0) {
            categories = ['ACTION']; // Cat√©gorie par d√©faut
          }
          
          return {
            name: norm(g.name) || "",
            categories: categories,
            magnet: norm(g.magnet) || "",
            cover: norm(g.cover) || ""
          };
        });
      }
      
      // S'assurer que toutes les cat√©gories des jeux sont dans la liste globale
      result.games.forEach(game => {
        game.categories.forEach(cat => {
          if (!result.categories.includes(cat)) {
            result.categories.push(cat);
          }
        });
      });
      
      // Trier et d√©dupliquer les cat√©gories
      result.categories = [...new Set(result.categories)].sort();
      
      return result;
    }

    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2200);
    }

    function setStateMessage(msg){
      stateMsg.textContent = msg;
      stateMsg.style.display = msg ? "block" : "none";
    }

    // ========== LOCAL STORAGE ==========
    function saveLocalDraft(){
      try{
        localStorage.setItem(LOCAL_KEY, JSON.stringify(state.data));
      }catch{}
    }
    function loadLocalDraft(){
      try{
        const raw = localStorage.getItem(LOCAL_KEY);
        return raw ? sanitizeData(JSON.parse(raw)) : null;
      }catch{ return null; }
    }

    // ========== GITHUB TOKEN ==========
    function loadGithubToken(){
      return localStorage.getItem("github_token") || "";
    }
    function saveGithubToken(token){
      localStorage.setItem("github_token", token);
      GITHUB_CONFIG.token = token;
    }
    GITHUB_CONFIG.token = loadGithubToken();

    // ========== RECHERCHE CAT√âGORIES ==========
    async function searchGameCategories(gameName){
      try {
        toastMsg("üîç Recherche des cat√©gories...");
        
        const response = await fetch(`${CATEGORIES_WORKER_URL}/api/categories?game=${encodeURIComponent(gameName)}`);
        
        if (!response.ok) {
          throw new Error(`API responded with ${response.status}`);
        }
        
        const data = await response.json();
        
        // Stocker les donn√©es de cat√©gories
        state.rawgGameData = data;
        
        // Afficher les r√©sultats
        rawgResult.style.display = "block";
        rawgTitle.textContent = data.rawgName || gameName;
        
        // Afficher les cat√©gories d√©tect√©es
        autoCatTags.innerHTML = "";
        if (data.categories && data.categories.length > 0) {
          data.categories.forEach(cat => {
            const isNew = !state.data.categories.includes(cat);
            const tag = document.createElement("div");
            tag.className = `autoCatTag ${isNew ? 'new' : ''}`;
            tag.innerHTML = `${cat} ${isNew ? '<span style="font-size:10px;">(NEW)</span>' : ''}`;
            autoCatTags.appendChild(tag);
          });
        } else {
          autoCatTags.innerHTML = '<div style="color:rgba(255,255,255,.6); font-style:italic;">Aucune cat√©gorie d√©tect√©e</div>';
        }
        
        toastMsg(`‚úÖ ${data.categories ? data.categories.length : 0} cat√©gorie(s) d√©tect√©e(s)!`);
        
      } catch (error) {
        console.error('Categories search error:', error);
        toastMsg(`‚ùå Erreur: ${error.message}`);
        state.rawgGameData = null;
        rawgResult.style.display = "none";
      }
    }

    // ========== GESTION CAT√âGORIES ADDITIONNELLES ==========
    function updateAdditionalCatSelect() {
      additionalCatSelect.innerHTML = '<option value="">S√©lectionner une cat√©gorie existante</option>';
      state.data.categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        additionalCatSelect.appendChild(opt);
      });
    }

    function addManualCategory(cat) {
      const catUpper = upper(cat);
      if (!catUpper || state.additionalCategories.includes(catUpper)) return;
      
      state.additionalCategories.push(catUpper);
      updateManualCatTags();
      additionalCategoriesInput.value = state.additionalCategories.join(',');
    }

    function removeManualCategory(cat) {
      state.additionalCategories = state.additionalCategories.filter(c => c !== cat);
      updateManualCatTags();
      additionalCategoriesInput.value = state.additionalCategories.join(',');
    }

    function updateManualCatTags() {
      manualCatTags.innerHTML = "";
      state.additionalCategories.forEach(cat => {
        const tag = document.createElement("div");
        tag.className = "autoCatTag";
        tag.innerHTML = `${cat} <span style="cursor:pointer; font-size:12px;" onclick="removeManualCategory('${cat}')">√ó</span>`;
        manualCatTags.appendChild(tag);
      });
    }

    // ========== COVER INPUT ==========
    gameCoverLink.addEventListener("input", () => {
      gameCover.value = norm(gameCoverLink.value);
      refreshPreview();
    });

    // ========== CTRL+V IMAGE UPLOAD ==========
    const CLOUDINARY_CLOUD_NAME = "dkcui82mx";
    const CLOUDINARY_UPLOAD_PRESET = "crackuzu";

    async function uploadImageToCloudinary(file) {
      try {
        toastMsg("üì§ Upload de l'image en cours...");
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
          { method: 'POST', body: formData }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || `HTTP ${response.status}`);
        }

        const result = await response.json();
        
        if (result && result.secure_url) {
          return result.secure_url;
        } else {
          throw new Error('URL non trouv√©e dans la r√©ponse');
        }
      } catch (error) {
        console.error('Erreur upload cloudinary:', error);
        toastMsg("‚ùå Erreur d'upload: " + error.message);
        return null;
      }
    }

    document.addEventListener('paste', async (e) => {
      if (!state.adminUnlocked || !adminModal.classList.contains('open')) return;
      
      const items = e.clipboardData?.items;
      if (!items) return;

      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          e.preventDefault();
          
          const file = items[i].getAsFile();
          if (!file) continue;

          const imageUrl = await uploadImageToCloudinary(file);
          
          if (imageUrl) {
            gameCoverLink.value = imageUrl;
            gameCover.value = imageUrl;
            refreshPreview();
            toastMsg("‚úÖ Image upload√©e avec succ√®s!");
          }
          
          break;
        }
      }
    });

    function refreshPreview(){
      const val = norm(gameCover.value);
      if(!val){
        previewWrap.style.display = "none";
        previewImg.src = "";
      }else{
        previewWrap.style.display = "block";
        previewImg.src = val;
      }
    }

    // ========== EDIT MODE ==========
    function exitEditMode(){
      editIndex = null;
      gameFormTitle.textContent = "Ajouter un jeu (Cat√©gories Automatiques)";
      addGameBtn.style.display = "";
      saveEditBtn.style.display = "none";
      cancelEditBtn.style.display = "none";

      gameName.value = "";
      gameMagnet.value = "";
      gameCover.value = "";
      gameCoverLink.value = "";
      
      state.rawgGameData = null;
      state.additionalCategories = [];
      rawgResult.style.display = "none";
      additionalCategoriesInput.value = "";
      updateManualCatTags();
      
      refreshPreview();
    }

    // ========== RENDER ==========
    function renderCategories(){
      catlist.innerHTML = "";
      
      // Bouton ALL
      const all = document.createElement("div");
      all.className = "catbtn" + (state.activeCat === "ALL" ? " active" : "");
      all.textContent = "ALL";
      all.addEventListener("click", () => {
        state.activeCat = "ALL";
        renderCategories();
        renderGames();
      });
      catlist.appendChild(all);

      // Cat√©gories existantes
      state.data.categories.forEach(c => {
        const btn = document.createElement("div");
        btn.className = "catbtn" + (state.activeCat === c ? " active" : "");
        btn.textContent = c;
        btn.addEventListener("click", () => {
          state.activeCat = c;
          renderCategories();
          renderGames();
        });
        catlist.appendChild(btn);
      });
      
      updateAdditionalCatSelect();
    }

    // CORRECTION CRITIQUE: Fonction renderGames qui fonctionne avec l'ancien et le nouveau format
    function renderGames(){
      const q = norm(state.query).toLowerCase();
      
      const filtered = state.data.games.filter(g => {
        // CORRECTION: V√©rifier si le jeu a la cat√©gorie active
        const hasCategory = state.activeCat === "ALL" || 
                           (g.categories && g.categories.includes(state.activeCat));
        
        // V√©rifier la recherche
        const searchMatch = !q || g.name.toLowerCase().includes(q);
        
        return hasCategory && searchMatch;
      });

      catCount.textContent = `${filtered.length} JEUX`;

      grid.innerHTML = "";
      
      if(filtered.length === 0){
        setStateMessage(state.activeCat === "ALL" ? "Aucun jeu trouv√©." : `Aucun jeu dans la cat√©gorie "${state.activeCat}".`);
        return;
      }
      
      setStateMessage("");

      filtered.forEach(g => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.cursor = "pointer";
        
        card.addEventListener("click", (e) => {
          if(e.target.closest('.dlBtn')) return;
          window.location.href = `game.html?game=${encodeURIComponent(g.name)}`;
        });

        const img = document.createElement("img");
        img.src = g.cover;
        img.alt = g.name;
        img.loading = "lazy";

        const info = document.createElement("div");
        info.className = "cinfo";
        
        // Nom du jeu
        const nameDiv = document.createElement("div");
        nameDiv.className = "gname";
        nameDiv.textContent = g.name;
        
        // Cat√©gories
        const categories = g.categories || [];
        if (categories.length > 0) {
          const mainCat = document.createElement("span");
          mainCat.className = "catpill";
          mainCat.textContent = categories[0];
          mainCat.style.marginTop = "6px";
          
          // Mini-tags pour les cat√©gories additionnelles
          const catTags = document.createElement("div");
          catTags.className = "catTags";
          if (categories.length > 1) {
            categories.slice(1).forEach(cat => {
              const mini = document.createElement("span");
              mini.className = "miniPill";
              mini.textContent = cat;
              catTags.appendChild(mini);
            });
          }
          
          info.appendChild(nameDiv);
          info.appendChild(mainCat);
          if (categories.length > 1) {
            info.appendChild(catTags);
          }
        } else {
          info.innerHTML = `<div class="gname">${g.name}</div>`;
        }

        // Bouton t√©l√©chargement
        const dlBtn = document.createElement("a");
        dlBtn.className = "dlBtn";
        dlBtn.href = g.magnet;
        dlBtn.setAttribute("aria-label", `T√©l√©charger ${g.name}`);
        dlBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        `;
        dlBtn.addEventListener("click", (e) => {
          e.stopPropagation();
        });

        card.appendChild(img);
        card.appendChild(info);
        card.appendChild(dlBtn);
        grid.appendChild(card);
      });
    }

    function renderAdminLists(){
      // Cat√©gories
      catListAdmin.innerHTML = "";
      state.data.categories.forEach(c => {
        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "left";
        left.innerHTML = `<div class="name">${c}</div>`;
        left.style.cursor = "pointer";
        left.addEventListener("click", () => {
          state.activeCat = c;
          renderCategories();
          renderGames();
          toastMsg(`Cat√©gorie "${c}" active`);
        });

        // Compter les jeux dans cette cat√©gorie
        const gameCount = state.data.games.filter(g => 
          g.categories && g.categories.includes(c)
        ).length;
        
        const count = document.createElement("div");
        count.className = "meta";
        count.textContent = `${gameCount} jeu${gameCount !== 1 ? 'x' : ''}`;

        const del = document.createElement("button");
        del.className = "iconBtn danger";
        del.type = "button";
        del.textContent = "Suppr";
        del.addEventListener("click", () => {
          const ok = confirm(`Supprimer la cat√©gorie "${c}" ?\n\nLes jeux ne seront PAS supprim√©s, seulement cette cat√©gorie sera retir√©e.`);
          if(!ok) return;
          
          // Retirer la cat√©gorie de la liste
          state.data.categories = state.data.categories.filter(x => x !== c);
          
          // Retirer la cat√©gorie de tous les jeux
          state.data.games.forEach(game => {
            if (game.categories) {
              game.categories = game.categories.filter(cat => cat !== c);
            }
          });
          
          if(state.activeCat === c) state.activeCat = "ALL";
          saveLocalDraft();
          renderCategories();
          renderGames();
          renderAdminLists();
          toastMsg("Cat√©gorie supprim√©e");
        });

        left.appendChild(count);
        row.appendChild(left);
        row.appendChild(del);
        catListAdmin.appendChild(row);
      });

      // Jeux
      gameListAdmin.innerHTML = "";
      state.data.games.forEach((g, idx) => {
        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "left";
        
        const categories = g.categories || [];
        const catText = categories.length > 0 ? categories.join(', ') : 'Aucune';
        left.innerHTML = `<div class="name">${g.name}</div><div class="meta">${catText} ‚Ä¢ ${g.cover ? 'avec cover' : 'sans cover'}</div>`;

        const edit = document.createElement("button");
        edit.className = "iconBtn";
        edit.type = "button";
        edit.textContent = "Modif";
        edit.addEventListener("click", () => {
          editIndex = idx;
          gameFormTitle.textContent = "Modifier un jeu";
          addGameBtn.style.display = "none";
          saveEditBtn.style.display = "";
          cancelEditBtn.style.display = "";

          // Pre-fill
          gameName.value = g.name;
          gameMagnet.value = g.magnet;
          gameCoverLink.value = g.cover || "";
          gameCover.value = g.cover || "";

          // Cat√©gories existantes
          state.additionalCategories = [...(g.categories || [])];
          additionalCategoriesInput.value = state.additionalCategories.join(',');
          updateManualCatTags();

          // Cacher la recherche RAWG pour l'√©dition
          state.rawgGameData = null;
          rawgResult.style.display = "none";

          refreshPreview();
          toastMsg("Mode modification");
        });

        const del = document.createElement("button");
        del.className = "iconBtn danger";
        del.type = "button";
        del.textContent = "Suppr";
        del.addEventListener("click", () => {
          const ok = confirm(`Supprimer "${g.name}" ?`);
          if(!ok) return;
          state.data.games.splice(idx, 1);
          saveLocalDraft();
          renderGames();
          renderAdminLists();
          if(editIndex === idx) exitEditMode();
          toastMsg("Jeu supprim√©");
        });

        row.appendChild(left);
        row.appendChild(edit);
        row.appendChild(del);
        gameListAdmin.appendChild(row);
      });
    }

    // ========== UPLOAD TO GITHUB ==========
    async function uploadToGithub(){
      const { token, owner, repo, branch, path } = GITHUB_CONFIG;

      if(!token){
        toastMsg("‚ö†Ô∏è Configure ton GitHub token d'abord!");
        return;
      }

      if(owner === "YOUR_USERNAME" || repo === "YOUR_REPO"){
        toastMsg("‚ö†Ô∏è Configure owner/repo dans GITHUB_CONFIG!");
        return;
      }

      try{
        toastMsg("üì§ Upload en cours...");
        
        const headers = {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json",
          "User-Agent": "CRACKUZU-App"
        };

        // 1) Get current file SHA
        const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        let sha = null;
        try{
          const getResp = await fetch(getUrl, { headers });
          if(getResp.ok){
            const getData = await getResp.json();
            sha = getData.sha;
          }
        }catch(e){}

        // 2) Prepare content
        const jsonContent = JSON.stringify(state.data, null, 2);
        const base64Content = btoa(unescape(encodeURIComponent(jsonContent)));

        // 3) Upload/update file
        const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const body = {
          message: `Update ${path} via admin panel - Cat√©gories Automatiques`,
          content: base64Content,
          branch: branch
        };
        if(sha) body.sha = sha;

        const putResp = await fetch(putUrl, {
          method: "PUT",
          headers: { ...headers, "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if(!putResp.ok){
          const errText = await putResp.text();
          let errData;
          try { errData = JSON.parse(errText); } catch { errData = { message: errText }; }
          throw new Error(`GitHub Error (${putResp.status}): ${errData.message || errText}`);
        }

        const successData = await putResp.json();
        console.log("Upload r√©ussi:", successData);
        toastMsg("‚úÖ Upload GitHub r√©ussi! (Attends 1-2min pour GitHub Pages)");
        
        localStorage.removeItem(LOCAL_KEY);
      }catch(err){
        console.error("Erreur compl√®te:", err);
        toastMsg(err.message || "‚ùå Erreur upload");
      }
    }

    function downloadDataJson(){
      const json = JSON.stringify(state.data, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "data.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toastMsg("üì• data.json t√©l√©charg√©");
    }

    // ========== EVENT LISTENERS ==========
    searchGameBtn.addEventListener("click", () => {
      const name = norm(gameName.value);
      if (!name) return toastMsg("Entrez un nom de jeu d'abord!");
      searchGameCategories(name);
    });

    addAdditionalCatBtn.addEventListener("click", () => {
      const cat = additionalCatSelect.value;
      if (!cat) return toastMsg("S√©lectionnez une cat√©gorie!");
      addManualCategory(cat);
      additionalCatSelect.value = "";
    });

    saveTokenBtn.addEventListener("click", () => {
      const token = githubToken.value.trim();
      if(!token){
        toastMsg("‚ö†Ô∏è Token vide");
        return;
      }
      if(!token.startsWith("ghp_") && !token.startsWith("github_pat_")){
        const confirm = window.confirm("Le token ne commence pas par ghp_ ou github_pat_. Continuer ?");
        if(!confirm) return;
      }
      saveGithubToken(token);
      toastMsg("‚úÖ Token sauvegard√© localement");
    });

    adminEntry.addEventListener("click", () => {
      const pwd = prompt("Admin password:");
      if(pwd === ADMIN_PASSWORD){
        state.adminUnlocked = true;
        adminPill.style.display = "inline-flex";
        toastMsg("Admin unlocked");
        openAdmin();
      }else{
        toastMsg("Wrong password");
      }
    });

    closeAdmin.addEventListener("click", closeAdminModal);
    adminModal.addEventListener("click", (e) => { if(e.target === adminModal) closeAdminModal(); });
    window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeAdminModal(); });

    q.addEventListener("input", () => {
      state.query = q.value || "";
      renderGames();
    });

    addCatBtn.addEventListener("click", () => {
      const name = upper(catName.value);
      if(!name) return toastMsg("Cat√©gorie vide");
      if(name === "ALL") return toastMsg("ALL est r√©serv√©");
      if(state.data.categories.includes(name)) return toastMsg("D√©j√† existe");

      state.data.categories.push(name);
      catName.value = "";
      saveLocalDraft();
      renderCategories();
      renderAdminLists();
      updateAdditionalCatSelect();
      toastMsg("Cat√©gorie ajout√©e");
    });

    addGameBtn.addEventListener("click", async () => {
      if(editIndex !== null) return toastMsg("Tu es en mode modif (annule ou sauvegarde).");

      const name = norm(gameName.value);
      const magnet = norm(gameMagnet.value).replaceAll("&amp;", "&");
      const cover = norm(gameCover.value);

      if(!name) return toastMsg("Nom manquant");
      if(!magnet.startsWith("magnet:")) return toastMsg("Magnet invalide");
      if(!cover) return toastMsg("Cover manquante");

      // D√©terminer les cat√©gories
      let categories = [];
      
      // 1. Cat√©gories de RAWG si disponibles
      if (state.rawgGameData && state.rawgGameData.categories) {
        categories = [...state.rawgGameData.categories];
      }
      
      // 2. Ajouter les cat√©gories manuelles
      state.additionalCategories.forEach(cat => {
        if (!categories.includes(cat)) {
          categories.push(cat);
        }
      });
      
      // 3. Ajouter des cat√©gories bas√©es sur le nom
      const nameUpper = name.toUpperCase();
      if (nameUpper.includes('RESIDENT EVIL') || nameUpper.includes('BIOHAZARD')) {
        if (!categories.includes('RESIDENT EVIL')) categories.push('RESIDENT EVIL');
        if (!categories.includes('HORROR')) categories.push('HORROR');
      }
      if (nameUpper.includes('FORZA') || nameUpper.includes('NFS') || nameUpper.includes('RACE') || nameUpper.includes('DRIVING')) {
        if (!categories.includes('CAR RACE')) categories.push('CAR RACE');
      }
      if (nameUpper.includes('FLIGHT') || nameUpper.includes('TRAIN') || nameUpper.includes('SIMULATOR')) {
        if (!categories.includes('SIMULATOR')) categories.push('SIMULATOR');
      }
      if (nameUpper.includes('ONLINE') || nameUpper.includes('MULTIPLAYER')) {
        if (!categories.includes('ONLINE')) categories.push('ONLINE');
      }
      if (nameUpper.includes('SURVIVAL')) {
        if (!categories.includes('SURVIVAL')) categories.push('SURVIVAL');
      }
      
      // 4. Assurer au moins une cat√©gorie
      if (categories.length === 0) {
        categories.push('ACTION');
      }
      
      // 5. Normaliser et d√©dupliquer
      categories = categories.map(upper).filter(cat => cat && cat !== 'ALL');
      categories = [...new Set(categories)];
      
      // 6. Ajouter les nouvelles cat√©gories √† la liste globale
      categories.forEach(cat => {
        if (!state.data.categories.includes(cat)) {
          state.data.categories.push(cat);
        }
      });

      // Cr√©er le jeu
      const newGame = {
        name,
        categories,
        magnet,
        cover
      };

      state.data.games.unshift(newGame);

      // R√©initialiser le formulaire
      gameName.value = "";
      gameMagnet.value = "";
      gameCover.value = "";
      gameCoverLink.value = "";
      state.rawgGameData = null;
      state.additionalCategories = [];
      rawgResult.style.display = "none";
      additionalCategoriesInput.value = "";
      updateManualCatTags();

      saveLocalDraft();
      renderGames();
      renderCategories();
      renderAdminLists();
      toastMsg("Jeu ajout√© avec " + categories.length + " cat√©gorie(s)!");
    });

    saveEditBtn.addEventListener("click", () => {
      if(editIndex === null) return;

      const name = norm(gameName.value);
      const magnet = norm(gameMagnet.value).replaceAll("&amp;", "&");
      const cover = norm(gameCover.value);

      if(!name) return toastMsg("Nom manquant");
      if(!magnet.startsWith("magnet:")) return toastMsg("Magnet invalide");
      if(!cover) return toastMsg("Cover manquante");

      // Utiliser les cat√©gories manuelles pour l'√©dition
      const categories = [...state.additionalCategories];
      
      // Normaliser
      const normalizedCats = categories.map(upper).filter(cat => cat && cat !== 'ALL');
      
      // Ajouter les nouvelles cat√©gories √† la liste globale
      normalizedCats.forEach(cat => {
        if (!state.data.categories.includes(cat)) {
          state.data.categories.push(cat);
        }
      });

      state.data.games[editIndex] = { 
        name, 
        categories: [...new Set(normalizedCats)], 
        magnet, 
        cover 
      };

      saveLocalDraft();
      renderGames();
      renderCategories();
      renderAdminLists();
      exitEditMode();
      toastMsg("Modif sauvegard√©e");
    });

    cancelEditBtn.addEventListener("click", () => {
      exitEditMode();
      toastMsg("Annul√©");
    });

    publishBtn.addEventListener("click", uploadToGithub);
    downloadBtn.addEventListener("click", downloadDataJson);

    resetBtn.addEventListener("click", () => {
      const ok = confirm("Reset local: revenir aux donn√©es du repo ?");
      if(!ok) return;
      localStorage.removeItem(LOCAL_KEY);
      toastMsg("Draft local supprim√©");
      init();
      closeAdminModal();
    });

    importBtn.addEventListener("click", () => filePick.click());
    filePick.addEventListener("change", async () => {
      const f = filePick.files?.[0];
      filePick.value = "";
      if(!f) return;
      try{
        const text = await f.text();
        const json = sanitizeData(JSON.parse(text));
        state.data = json;
        saveLocalDraft();
        renderCategories();
        renderGames();
        renderAdminLists();
        exitEditMode();
        toastMsg("Import OK");
      }catch{
        toastMsg("Import invalide");
      }
    });

    // ========== LOAD FROM REPO ==========
    async function loadDataFromRepo(){
      try{
        if(!GITHUB_CONFIG.owner || GITHUB_CONFIG.owner === "YOUR_USERNAME" || !GITHUB_CONFIG.repo || GITHUB_CONFIG.repo === "YOUR_REPO"){
          return null;
        }

        const timestamp = new Date().getTime();
        const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${timestamp}`;
        
        const resp = await fetch(url, { cache: 'no-store' });
        
        if(!resp.ok){
          return null;
        }
        
        const json = await resp.json();
        return sanitizeData(json);
      }catch(e){
        return null;
      }
    }

    // ========== INITIALISATION ==========
    async function init(){
      setStateMessage("Chargement‚Ä¶");

      const repoData = await loadDataFromRepo();
      const localDraft = loadLocalDraft();

      if(localDraft){
        state.data = localDraft;
        setStateMessage("üì¶ Donn√©es locales charg√©es (pas encore publi√©es)");
        setTimeout(() => setStateMessage(""), 3000);
      }else if(repoData){
        state.data = repoData;
        setStateMessage("‚òÅÔ∏è Donn√©es GitHub charg√©es");
        setTimeout(() => setStateMessage(""), 3000);
      }else{
        state.data = structuredClone(DEFAULT_DATA);
        setStateMessage("data.json introuvable (mode local).");
      }

      state.activeCat = "ALL";
      state.query = "";
      q.value = "";

      editIndex = null;
      exitEditMode();

      // Pr√©-remplir le token
      githubToken.value = loadGithubToken();

      refreshPreview();
      renderCategories();
      renderGames();
      renderAdminLists();
      
      console.log("Donn√©es charg√©es:", state.data);
    }

    // Exposer la fonction pour les mini-tags
    window.removeManualCategory = removeManualCategory;

    init();
  </script>
</body>
</html>