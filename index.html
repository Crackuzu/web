<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRACKUZU</title>

  <style>
    :root{
      --bg0:#0b0e12;
      --bg1:#10151b;

      --glass: rgba(255,255,255,.065);
      --glass2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.11);
      --stroke2: rgba(255,255,255,.16);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --outer: clamp(14px, 2.2vw, 26px);
      --gap:   clamp(12px, 1.2vw, 18px);
      --pad:   clamp(14px, 1.6vw, 20px);

      --r-xl:  clamp(18px, 2vw, 26px);
      --r-md:  clamp(14px, 1.5vw, 18px);

      --shadow: 0 28px 90px rgba(0,0,0,.58);
      --shadow2: 0 18px 46px rgba(0,0,0,.45);

      --side: clamp(250px, 20vw, 330px);

      /* Cards: fixed-ish size -> more columns when window wider */
      --cardW: clamp(140px, 10.5vw, 185px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(255,255,255,.09), transparent 55%),
        radial-gradient(950px 600px at 90% 20%, rgba(255,255,255,.07), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .glass{
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }
    @supports ((-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px))){
      .glass{
        -webkit-backdrop-filter: blur(14px);
        backdrop-filter: blur(14px);
      }
    }

    .app{
      min-height: 100vh;
      min-height: 100dvh;
      padding: var(--outer);
      width: 100%;
    }

    .shell{
      width: min(1800px, calc(100dvw - (2 * var(--outer))));
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      min-height: calc(100dvh - (2 * var(--outer)));
    }

    header{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap: var(--gap);
      min-height: clamp(86px, 10vh, 120px);
    }

    .brand{
      text-align:center;
      user-select:none;
      line-height:1.05;
    }
    .brand .big{
      font-weight: 300;
      letter-spacing: clamp(1px, .25vw, 2.5px);
      font-size: clamp(28px, 3.2vw, 46px);
      opacity:.92;
    }
    .brand .small{
      margin-top: 4px;
      font-size: clamp(12px, 1.1vw, 14px);
      letter-spacing: clamp(2px, .35vw, 3.5px);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor: pointer;
    }
    .brand .small:hover{ color: rgba(255,255,255,.78); }

    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.70);
      letter-spacing: 1px;
    }

    .search{
      width: clamp(220px, 26vw, 360px);
      height: clamp(34px, 4.2vh, 40px);
      border-radius: 999px;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 14px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.085);
      justify-self:end;
    }
    .search svg{ width: 18px; height: 18px; opacity:.78; }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color: var(--text);
      font-size: clamp(13px, 1.1vw, 14px);
    }
    .search input::placeholder{ color: rgba(255,255,255,.55); }

    .main{
      flex: 1;
      min-height: 0;
      display:grid;
      grid-template-columns: var(--side) 1fr;
      gap: var(--gap);
    }

    aside{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    aside h2{
      margin: 6px 0 12px;
      text-align:center;
      font-weight: 300;
      letter-spacing: clamp(1px, .3vw, 2.2px);
      font-size: clamp(22px, 2.3vw, 28px);
      color: rgba(255,255,255,.86);
    }

    .catlist{
      display:flex;
      flex-direction:column;
      gap: clamp(10px, 1.2vw, 14px);
      margin-top: clamp(10px, 1.3vw, 18px);
    }

    .catbtn{
      height: clamp(46px, 5.8vh, 54px);
      border-radius: clamp(14px, 1.4vw, 16px);
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      font-weight: 520;
      letter-spacing: 1px;
      color: rgba(255,255,255,.70);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease, color .15s ease;
      user-select:none;
    }
    .catbtn:hover{
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.25);
      transform: translateY(-1px);
      color: rgba(255,255,255,.86);
    }
    .catbtn.active{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.28);
      color: rgba(255,255,255,.92);
    }

    .sidefoot{
      margin-top:auto;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: rgba(255,255,255,.55);
      font-size: clamp(12px, 1.05vw, 13px);
      letter-spacing: .8px;
    }
    .sidefoot .boondocks{ color: rgba(255,255,255,.55); text-decoration: none; }
    .sidefoot .boondocks:hover{ color: rgba(255,255,255,.80); text-decoration: underline; }

    section{
      border-radius: var(--r-xl);
      padding: var(--pad);
      box-shadow: var(--shadow);
      min-height: 0;
      overflow:auto;
    }

    .grid{
      display:grid;
      gap: var(--gap);
      grid-template-columns: repeat(auto-fill, minmax(var(--cardW), 1fr));
      align-content: start;
    }

    /* ‚ú® CARTE AM√âLIOR√âE - Juste image avant hover */
    .card{
      position: relative;
      border-radius: var(--r-md);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      aspect-ratio: 3 / 4;
      cursor: pointer;
      transform: translateZ(0);
      transition: transform .22s ease, border-color .22s ease, box-shadow .22s ease;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      background:
        radial-gradient(600px 260px at 30% 10%, rgba(170,140,255,.28), transparent 60%),
        radial-gradient(500px 240px at 80% 90%, rgba(0,210,255,.20), transparent 55%);
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-18px;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.20),
          rgba(255,255,255,.12),
          transparent 60%);
      filter: blur(28px);
    }
    .card:hover{
      transform: translateY(-5px);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 28px 60px rgba(0,0,0,.6);
    }
    .card:hover::before{ opacity:1; }
    .card:hover::after{ opacity:1; }

    /* Image de fond */
    .card-bg{
      position:absolute;
      inset:0;
      overflow:hidden;
    }
    .card-bg img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      transition: transform .5s ease;
    }
    .card:hover .card-bg img{
      transform: scale(1.08);
    }

    /* Overlay au hover - contient nom + bouton */
    .card-overlay{
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, 
        rgba(0,0,0,0) 0%,
        rgba(0,0,0,.3) 40%,
        rgba(0,0,0,.85) 100%);
      opacity:0;
      transition: opacity .3s ease;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding: clamp(12px, 1.5vw, 18px);
      gap: clamp(8px, 1vw, 12px);
    }
    .card:hover .card-overlay{
      opacity:1;
    }

    /* Nom du jeu dans l'overlay */
    .card-title{
      font-size: clamp(13px, 1.15vw, 16px);
      font-weight: 600;
      letter-spacing: .6px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 8px rgba(0,0,0,.5);
      line-height: 1.3;
      margin: 0;
    }

    /* Mini bouton t√©l√©charger */
    .card-download{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.25);
      color: rgba(255,255,255,.95);
      font-size: clamp(11px, 1vw, 13px);
      font-weight: 500;
      letter-spacing: .5px;
      text-decoration: none;
      transition: all .2s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      align-self: flex-start;
    }
    .card-download:hover{
      background: rgba(255,255,255,.28);
      border-color: rgba(255,255,255,.4);
      transform: translateY(-1px);
    }
    .card-download svg{
      width: 14px;
      height: 14px;
    }

    .noGames{
      text-align:center;
      color: rgba(255,255,255,.55);
      padding: 40px 20px;
      font-style:italic;
      font-size: clamp(14px, 1.2vw, 16px);
    }

    .modal{
      display:flex;
      position:fixed;
      inset:0;
      z-index:9999;
      background: rgba(0,0,0,.75);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      align-items:center;
      justify-content:center;
      padding: var(--outer);
      opacity:0;
      pointer-events:none;
      transition: opacity .3s ease;
    }
    .modal.open{
      opacity:1;
      pointer-events:all;
    }

    .adminBox{
      background: var(--bg1);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      border: 1px solid var(--stroke2);
      width: min(1200px, 95vw);
      max-height: 90vh;
      overflow:auto;
      padding: clamp(20px, 3vw, 32px);
      position:relative;
    }

    .adminBox h1{
      margin:0 0 20px;
      font-size: clamp(24px, 2.8vw, 32px);
      font-weight:300;
      letter-spacing:1.2px;
      text-align:center;
      color: rgba(255,255,255,.9);
    }

    .adminBox section{
      border-radius: var(--r-md);
      padding: clamp(16px, 2vw, 22px);
      margin-bottom: clamp(18px, 2.2vw, 26px);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      box-shadow: none;
      overflow: visible;
    }
    .adminBox h2{
      margin:0 0 14px;
      font-size: clamp(18px, 1.8vw, 22px);
      font-weight:500;
      letter-spacing:.8px;
      color: rgba(255,255,255,.85);
    }

    .closeBtn{
      position:absolute;
      top: clamp(16px, 2vw, 24px);
      right: clamp(16px, 2vw, 24px);
      width: 36px;
      height: 36px;
      border-radius:50%;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.75);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all .2s ease;
    }
    .closeBtn:hover{
      background: rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      transform: rotate(90deg);
    }

    label{
      display:block;
      margin-bottom:6px;
      font-size: clamp(12px, 1.05vw, 14px);
      letter-spacing:.5px;
      color: rgba(255,255,255,.75);
      font-weight:500;
    }
    input[type=text], input[type=password], input[type=url], textarea{
      width:100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: clamp(13px, 1.1vw, 14px);
      outline:0;
      transition: border-color .2s ease, background .2s ease;
      font-family: inherit;
    }
    input[type=text]:focus, input[type=password]:focus, input[type=url]:focus, textarea:focus{
      border-color: rgba(255,255,255,.3);
      background: rgba(255,255,255,.08);
    }
    textarea{
      resize:vertical;
      min-height:80px;
    }

    .formRow{
      display:flex;
      gap: clamp(10px, 1.5vw, 18px);
      margin-bottom: clamp(12px, 1.5vw, 16px);
    }
    .formRow > div{
      flex:1;
    }

    button, .btn{
      padding: 10px 18px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.88);
      font-size: clamp(13px, 1.1vw, 14px);
      font-weight:500;
      letter-spacing:.6px;
      cursor:pointer;
      transition: all .2s ease;
      font-family:inherit;
    }
    button:hover, .btn:hover{
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.3);
      transform: translateY(-1px);
    }
    button.primary{
      background: linear-gradient(135deg, rgba(100,140,255,.22), rgba(80,120,240,.18));
      border-color: rgba(100,140,255,.35);
    }
    button.primary:hover{
      background: linear-gradient(135deg, rgba(100,140,255,.3), rgba(80,120,240,.25));
      border-color: rgba(100,140,255,.5);
    }

    button.danger{
      background: linear-gradient(135deg, rgba(255,80,100,.18), rgba(240,60,80,.14));
      border-color: rgba(255,80,100,.3);
    }
    button.danger:hover{
      background: linear-gradient(135deg, rgba(255,80,100,.25), rgba(240,60,80,.2));
      border-color: rgba(255,80,100,.45);
    }

    .btnGroup{
      display:flex;
      gap: 10px;
      margin-top:12px;
    }

    .stateMsg{
      padding:10px 16px;
      border-radius:8px;
      background: rgba(100,180,255,.15);
      border: 1px solid rgba(100,180,255,.3);
      color: rgba(150,200,255,.95);
      font-size: clamp(12px, 1.05vw, 13px);
      margin-bottom:14px;
      text-align:center;
    }

    .gameRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      border-radius:8px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      margin-bottom:8px;
      transition: background .2s ease;
    }
    .gameRow:hover{
      background: rgba(255,255,255,.07);
    }
    .gameRow .left{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .gameRow .thumb{
      width:40px;
      height:40px;
      border-radius:6px;
      object-fit:cover;
      flex-shrink:0;
    }
    .gameRow .name{
      font-size: clamp(13px, 1.1vw, 14px);
      font-weight:500;
      color: rgba(255,255,255,.88);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .gameRow .cat{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.7);
      letter-spacing:.5px;
    }
    .iconBtn{
      padding: 8px 14px;
      font-size:12px;
      flex-shrink:0;
    }

    .catRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:6px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      margin-bottom:6px;
    }
    .catRow .name{
      flex:1;
      font-size: clamp(13px, 1.1vw, 14px);
      color: rgba(255,255,255,.85);
      font-weight:500;
    }

    .toast{
      position:fixed;
      bottom:30px;
      left:50%;
      transform:translateX(-50%) translateY(100px);
      padding:12px 24px;
      border-radius:12px;
      background: rgba(20,25,35,.95);
      border: 1px solid rgba(255,255,255,.2);
      color: rgba(255,255,255,.92);
      box-shadow: 0 12px 40px rgba(0,0,0,.6);
      z-index:10000;
      font-size:14px;
      font-weight:500;
      letter-spacing:.5px;
      pointer-events:none;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      opacity:0;
      transition: all .3s cubic-bezier(.18,.89,.32,1.28);
    }
    .toast.show{
      transform:translateX(-50%) translateY(0);
      opacity:1;
    }

    .previewBox{
      margin-top:16px;
      padding:16px;
      border-radius:10px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
    }
    .previewBox h3{
      margin:0 0 12px;
      font-size:15px;
      font-weight:500;
      color: rgba(255,255,255,.8);
    }
    .previewBox img{
      width:100%;
      max-width:200px;
      border-radius:8px;
      border: 1px solid rgba(255,255,255,.12);
    }

    .categoryBadges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    .catBadge{
      padding:6px 12px;
      border-radius:6px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.75);
      font-size:12px;
      letter-spacing:.5px;
      cursor:pointer;
      transition: all .2s ease;
      user-select:none;
    }
    .catBadge:hover{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.25);
    }
    .catBadge.selected{
      background: rgba(100,140,255,.2);
      border-color: rgba(100,140,255,.4);
      color: rgba(200,220,255,.95);
    }

    /* ‚ú® NOUVEAU: Zone de drag & drop pour torrent */
    .torrent-drop-zone{
      margin-top:12px;
      padding:24px;
      border-radius:10px;
      border: 2px dashed rgba(255,255,255,.2);
      background: rgba(255,255,255,.03);
      text-align:center;
      transition: all .3s ease;
      cursor:pointer;
    }
    .torrent-drop-zone.dragover{
      border-color: rgba(100,180,255,.5);
      background: rgba(100,180,255,.1);
    }
    .torrent-drop-zone p{
      margin:0;
      color: rgba(255,255,255,.65);
      font-size:13px;
    }
    .torrent-drop-zone .icon{
      font-size:32px;
      margin-bottom:8px;
      opacity:.6;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="shell">

      <header class="glass">
        <div class="brand">
          <div class="big">CRACKUZU</div>
          <div class="small" id="adminEntry">
            GAME LIBRARY
            <span class="pill" id="adminPill" style="display:none;">ADMIN</span>
          </div>
        </div>

        <div class="search">
          <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" placeholder="Rechercher un jeu..." id="q" />
        </div>
      </header>

      <div class="main">
        <aside class="glass">
          <h2>Cat√©gories</h2>
          <div class="catlist" id="catList"></div>
          <div class="sidefoot">
            <span>¬© 2025</span>
            <a href="https://github.com/yourusername" class="boondocks" target="_blank">GitHub</a>
          </div>
        </aside>

        <section class="glass">
          <div id="stateMsg" class="stateMsg" style="display:none;"></div>
          <div class="grid" id="gameGrid"></div>
          <div class="noGames" id="noGames" style="display:none;">Aucun jeu trouv√©.</div>
        </section>
      </div>

    </div>
  </div>

  <!-- Admin Modal -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="adminBox">
      <button class="closeBtn" id="closeAdmin" aria-label="Fermer">‚úï</button>
      <h1>üîß Admin Panel</h1>

      <section>
        <h2>üîë Configuration</h2>
        <div class="formRow">
          <div>
            <label>GitHub Token</label>
            <input type="password" id="githubToken" placeholder="ghp_..." />
          </div>
          <div style="flex:0; display:flex; align-items:flex-end;">
            <button class="primary" id="saveTokenBtn">Sauvegarder Token</button>
          </div>
        </div>
        <div class="formRow">
          <div>
            <label>Worker URL</label>
            <input type="url" id="workerUrl" placeholder="https://..." />
          </div>
          <div style="flex:0; display:flex; align-items:flex-end;">
            <button class="primary" id="saveWorkerBtn">Sauvegarder Worker</button>
          </div>
        </div>
        <div class="btnGroup">
          <button id="publishBtn" class="primary">üì§ Publier sur GitHub</button>
          <button id="exportBtn">üíæ Exporter JSON</button>
          <button id="importBtn">üì• Importer JSON</button>
          <button id="resetBtn" class="danger">üîÑ Reset local</button>
        </div>
        <input type="file" id="filePick" accept=".json" style="display:none;" />
      </section>

      <section>
        <h2>‚ûï Ajouter / Modifier un jeu</h2>
        <div class="formRow">
          <div>
            <label>Nom du jeu</label>
            <input type="text" id="gameName" placeholder="Ex: Cyberpunk 2077" />
          </div>
        </div>
        
        <!-- ‚ú® Zone drag & drop pour torrent -->
        <div class="torrent-drop-zone" id="torrentDropZone">
          <div class="icon">üìé</div>
          <p><strong>Glissez un fichier .torrent ici</strong></p>
          <p style="font-size:11px; margin-top:4px; opacity:.7;">ou collez le lien magnet ci-dessous</p>
        </div>
        <input type="file" id="torrentFileInput" accept=".torrent" style="display:none;" />
        
        <div class="formRow" style="margin-top:12px;">
          <div>
            <label>Lien Magnet</label>
            <textarea id="gameMagnet" placeholder="magnet:?xt=urn:btih:..." rows="2"></textarea>
          </div>
        </div>
        <div class="formRow">
          <div>
            <label>URL de la cover (ou coller un lien ci-dessous)</label>
            <input type="url" id="gameCoverLink" placeholder="https://..." />
          </div>
        </div>
        <div class="formRow">
          <div>
            <label>Cover (base64 ou URL)</label>
            <input type="text" id="gameCover" placeholder="data:image... ou https://..." />
          </div>
        </div>

        <div>
          <label>Cat√©gories du jeu</label>
          <div class="categoryBadges" id="categoryBadges"></div>
          <button type="button" id="autoDetectBtn" style="margin-top:10px; font-size:12px;">ü§ñ Auto-d√©tecter cat√©gories</button>
        </div>

        <div class="previewBox" id="previewBox" style="display:none;">
          <h3>Aper√ßu de la cover :</h3>
          <img id="previewImg" alt="preview" />
        </div>

        <div class="btnGroup">
          <button id="addGameBtn" class="primary">‚ûï Ajouter</button>
          <button id="saveEditBtn" class="primary" style="display:none;">üíæ Sauvegarder modif</button>
          <button id="cancelEditBtn" style="display:none;">‚ùå Annuler modif</button>
        </div>
      </section>

      <section>
        <h2>üìã Liste des jeux</h2>
        <div id="gameListAdmin"></div>
      </section>

      <section>
        <h2>üè∑Ô∏è G√©rer les cat√©gories</h2>
        <div class="formRow">
          <div>
            <input type="text" id="catName" placeholder="Nom de la cat√©gorie (ex: ACTION)" />
          </div>
          <div style="flex:0;">
            <button id="addCatBtn" class="primary">Ajouter</button>
          </div>
        </div>
        <div id="catListAdmin"></div>
      </section>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const ADMIN_PASSWORD = "admin123";
    const REPO_OWNER = "yourusername";
    const REPO_NAME = "yourrepo";
    const REPO_BRANCH = "main";
    const REPO_PATH = "data.json";
    const LOCAL_KEY = "crackuzu_draft_v3";

    const DEFAULT_DATA = {
      categories: ["ACTION", "RPG", "STRATEGY", "SIMULATION", "SPORT"],
      games: []
    };

    let state = {
      data: structuredClone(DEFAULT_DATA),
      activeCat: "ALL",
      query: "",
      adminUnlocked: false,
      selectedCategories: []
    };

    let editIndex = null;

    const q = document.getElementById("q");
    const catList = document.getElementById("catList");
    const gameGrid = document.getElementById("gameGrid");
    const noGames = document.getElementById("noGames");
    const stateMsg = document.getElementById("stateMsg");

    const adminEntry = document.getElementById("adminEntry");
    const adminPill = document.getElementById("adminPill");
    const adminModal = document.getElementById("adminModal");
    const closeAdmin = document.getElementById("closeAdmin");

    const githubToken = document.getElementById("githubToken");
    const workerUrl = document.getElementById("workerUrl");
    const saveTokenBtn = document.getElementById("saveTokenBtn");
    const saveWorkerBtn = document.getElementById("saveWorkerBtn");
    const publishBtn = document.getElementById("publishBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const resetBtn = document.getElementById("resetBtn");
    const filePick = document.getElementById("filePick");

    const gameName = document.getElementById("gameName");
    const gameMagnet = document.getElementById("gameMagnet");
    const gameCover = document.getElementById("gameCover");
    const gameCoverLink = document.getElementById("gameCoverLink");
    const addGameBtn = document.getElementById("addGameBtn");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const autoDetectBtn = document.getElementById("autoDetectBtn");

    const categoryBadges = document.getElementById("categoryBadges");
    const previewBox = document.getElementById("previewBox");
    const previewImg = document.getElementById("previewImg");

    const gameListAdmin = document.getElementById("gameListAdmin");
    const catListAdmin = document.getElementById("catListAdmin");
    const catName = document.getElementById("catName");
    const addCatBtn = document.getElementById("addCatBtn");

    const toast = document.getElementById("toast");

    // ‚ú® NOUVEAU: Drag & Drop pour fichiers .torrent
    const torrentDropZone = document.getElementById("torrentDropZone");
    const torrentFileInput = document.getElementById("torrentFileInput");

    torrentDropZone.addEventListener("click", () => {
      torrentFileInput.click();
    });

    torrentDropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      torrentDropZone.classList.add("dragover");
    });

    torrentDropZone.addEventListener("dragleave", () => {
      torrentDropZone.classList.remove("dragover");
    });

    torrentDropZone.addEventListener("drop", async (e) => {
      e.preventDefault();
      torrentDropZone.classList.remove("dragover");
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        await handleTorrentFile(files[0]);
      }
    });

    torrentFileInput.addEventListener("change", async (e) => {
      if (e.target.files.length > 0) {
        await handleTorrentFile(e.target.files[0]);
      }
    });

    async function handleTorrentFile(file) {
      if (!file.name.endsWith(".torrent")) {
        toastMsg("‚ö†Ô∏è Veuillez s√©lectionner un fichier .torrent");
        return;
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const magnetLink = await torrentToMagnet(arrayBuffer);
        
        if (magnetLink) {
          gameMagnet.value = magnetLink;
          toastMsg("‚úÖ Fichier .torrent converti en magnet link");
        } else {
          toastMsg("‚ùå Erreur lors de la conversion");
        }
      } catch (error) {
        console.error("Error converting torrent:", error);
        toastMsg("‚ùå Erreur lors de la lecture du fichier");
      }
    }

    // ‚ú® Fonction pour convertir .torrent en magnet link
    async function torrentToMagnet(arrayBuffer) {
      try {
        // Parser le fichier torrent (format bencoded)
        const torrentData = parseBencode(new Uint8Array(arrayBuffer));
        
        if (!torrentData || !torrentData.info) {
          throw new Error("Invalid torrent file");
        }

        // Calculer le hash SHA-1 de la section info
        const infoHash = await calculateInfoHash(torrentData.info);
        
        // R√©cup√©rer le nom
        const name = torrentData.info.name ? 
          (typeof torrentData.info.name === 'string' ? torrentData.info.name : 
           new TextDecoder().decode(torrentData.info.name)) : 
          'unknown';

        // R√©cup√©rer les trackers
        let trackers = [];
        if (torrentData.announce) {
          const announceUrl = typeof torrentData.announce === 'string' ? 
            torrentData.announce : new TextDecoder().decode(torrentData.announce);
          trackers.push(announceUrl);
        }
        if (torrentData['announce-list']) {
          torrentData['announce-list'].forEach(tier => {
            if (Array.isArray(tier)) {
              tier.forEach(url => {
                const urlStr = typeof url === 'string' ? url : new TextDecoder().decode(url);
                if (!trackers.includes(urlStr)) {
                  trackers.push(urlStr);
                }
              });
            }
          });
        }

        // Construire le magnet link
        let magnetLink = `magnet:?xt=urn:btih:${infoHash}`;
        magnetLink += `&dn=${encodeURIComponent(name)}`;
        
        trackers.forEach(tracker => {
          magnetLink += `&tr=${encodeURIComponent(tracker)}`;
        });

        return magnetLink;
      } catch (error) {
        console.error("Error in torrentToMagnet:", error);
        return null;
      }
    }

    async function calculateInfoHash(info) {
      // Re-encoder la section info en bencode
      const encoded = bencode(info);
      
      // Calculer le SHA-1
      const hashBuffer = await crypto.subtle.digest('SHA-1', encoded);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      
      return hashHex;
    }

    // Parser bencode simplifi√©
    function parseBencode(data) {
      let index = 0;

      function parse() {
        const char = String.fromCharCode(data[index]);

        if (char === 'd') {
          return parseDict();
        } else if (char === 'l') {
          return parseList();
        } else if (char === 'i') {
          return parseInt();
        } else if (char >= '0' && char <= '9') {
          return parseString();
        }
      }

      function parseDict() {
        index++; // skip 'd'
        const dict = {};
        
        while (String.fromCharCode(data[index]) !== 'e') {
          const key = parseString();
          const keyStr = typeof key === 'string' ? key : new TextDecoder().decode(key);
          const value = parse();
          dict[keyStr] = value;
        }
        
        index++; // skip 'e'
        return dict;
      }

      function parseList() {
        index++; // skip 'l'
        const list = [];
        
        while (String.fromCharCode(data[index]) !== 'e') {
          list.push(parse());
        }
        
        index++; // skip 'e'
        return list;
      }

      function parseInt() {
        index++; // skip 'i'
        let numStr = '';
        
        while (String.fromCharCode(data[index]) !== 'e') {
          numStr += String.fromCharCode(data[index]);
          index++;
        }
        
        index++; // skip 'e'
        return Number(numStr);
      }

      function parseString() {
        let lenStr = '';
        
        while (String.fromCharCode(data[index]) !== ':') {
          lenStr += String.fromCharCode(data[index]);
          index++;
        }
        
        index++; // skip ':'
        const len = Number(lenStr);
        const bytes = data.slice(index, index + len);
        index += len;
        
        // Try to decode as UTF-8, if fails return raw bytes
        try {
          return new TextDecoder('utf-8', { fatal: true }).decode(bytes);
        } catch {
          return bytes;
        }
      }

      return parse();
    }

    // Encoder en bencode
    function bencode(obj) {
      const parts = [];

      function encode(value) {
        if (typeof value === 'number') {
          return `i${value}e`;
        } else if (typeof value === 'string') {
          const bytes = new TextEncoder().encode(value);
          return `${bytes.length}:${value}`;
        } else if (value instanceof Uint8Array) {
          return `${value.length}:` + Array.from(value).map(b => String.fromCharCode(b)).join('');
        } else if (Array.isArray(value)) {
          let result = 'l';
          value.forEach(item => {
            result += encode(item);
          });
          return result + 'e';
        } else if (typeof value === 'object') {
          let result = 'd';
          const keys = Object.keys(value).sort();
          keys.forEach(key => {
            result += encode(key);
            result += encode(value[key]);
          });
          return result + 'e';
        }
      }

      const encoded = encode(obj);
      return new TextEncoder().encode(encoded);
    }

    function norm(s){ return (s || "").trim(); }
    function upper(s){ return norm(s).toUpperCase(); }

    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    function setStateMessage(msg){
      if(!msg){
        stateMsg.style.display = "none";
        stateMsg.textContent = "";
      }else{
        stateMsg.style.display = "block";
        stateMsg.textContent = msg;
      }
    }

    function saveGithubToken(token){ localStorage.setItem("gh_token", token); }
    function loadGithubToken(){ return localStorage.getItem("gh_token") || ""; }
    function saveWorkerUrl(url){ localStorage.setItem("worker_url", url); }
    function loadWorkerUrl(){ return localStorage.getItem("worker_url") || ""; }

    function saveLocalDraft(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(state.data)); }
    function loadLocalDraft(){
      const raw = localStorage.getItem(LOCAL_KEY);
      if(!raw) return null;
      try{
        return sanitizeData(JSON.parse(raw));
      }catch{
        return null;
      }
    }

    function sanitizeData(obj){
      if(!obj.categories || !Array.isArray(obj.categories)) obj.categories = [];
      if(!obj.games || !Array.isArray(obj.games)) obj.games = [];
      
      obj.games = obj.games.map(g => {
        if(Array.isArray(g.categories)){
          return g;
        }
        const migrated = {...g};
        if(g.cat){
          migrated.categories = [g.cat.toUpperCase()];
        }else{
          migrated.categories = ['ACTION'];
        }
        return migrated;
      });
      
      return obj;
    }

    async function loadDataFromRepo(){
      const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/${REPO_PATH}`;
      try{
        const res = await fetch(url);
        if(!res.ok) return null;
        const json = await res.json();
        return sanitizeData(json);
      }catch{
        return null;
      }
    }

    exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "data.json";
      a.click();
      toastMsg("Export r√©ussi");
    });

    publishBtn.addEventListener("click", async () => {
      const token = loadGithubToken();
      if(!token){
        toastMsg("Token GitHub manquant");
        return;
      }

      const ok = confirm("Publier les donn√©es locales sur GitHub ?");
      if(!ok) return;

      setStateMessage("Publication en cours...");

      try{
        const shaUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${REPO_PATH}?ref=${REPO_BRANCH}`;
        const shaRes = await fetch(shaUrl, {
          headers:{ Authorization: `token ${token}` }
        });
        let sha = null;
        if(shaRes.ok){
          const shaData = await shaRes.json();
          sha = shaData.sha;
        }

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(state.data, null, 2))));

        const body = {
          message: "Update data.json from CRACKUZU admin",
          content,
          branch: REPO_BRANCH
        };
        if(sha) body.sha = sha;

        const putUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${REPO_PATH}`;
        const putRes = await fetch(putUrl, {
          method: "PUT",
          headers:{
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if(!putRes.ok){
          const errData = await putRes.json();
          throw new Error(errData.message || "GitHub API error");
        }

        localStorage.removeItem(LOCAL_KEY);
        setStateMessage("‚úÖ Publi√© sur GitHub. Draft local supprim√©.");
        toastMsg("Publi√© !");
        setTimeout(() => setStateMessage(""), 4000);
      }catch(err){
        console.error(err);
        setStateMessage("‚ùå Erreur publication: " + err.message);
        toastMsg("Erreur publication");
      }
    });

    gameCoverLink.addEventListener("input", () => {
      const url = gameCoverLink.value.trim();
      if(url && url.startsWith("http")){
        gameCover.value = url;
        refreshPreview();
      }
    });

    autoDetectBtn.addEventListener("click", () => {
      const name = norm(gameName.value);
      if(!name){
        toastMsg("Entre d'abord un nom de jeu");
        return;
      }

      const detected = [];
      const nameLower = name.toLowerCase();

      const keywords = {
        ACTION: ["action", "shooter", "combat", "fight", "warfare", "battlefield", "call of duty", "assassin"],
        RPG: ["rpg", "role", "fantasy", "witcher", "elder scrolls", "dragon", "quest"],
        STRATEGY: ["strategy", "civilization", "age of empires", "starcraft", "total war"],
        SIMULATION: ["simulator", "simulation", "farming", "truck", "flight"],
        SPORT: ["fifa", "nba", "nfl", "sport", "football", "basketball", "racing", "formula"]
      };

      for(const [cat, kws] of Object.entries(keywords)){
        if(kws.some(kw => nameLower.includes(kw))){
          detected.push(cat);
        }
      }

      if(detected.length === 0){
        detected.push("ACTION");
      }

      state.selectedCategories = detected;
      renderCategories();
      toastMsg(`Cat√©gories d√©tect√©es: ${detected.join(", ")}`);
    });

    function refreshPreview(){
      const url = gameCover.value.trim();
      if(url){
        previewBox.style.display = "block";
        previewImg.src = url;
      }else{
        previewBox.style.display = "none";
      }
    }

    gameCover.addEventListener("input", refreshPreview);

    function renderCategories(){
      const all = ["ALL", ...state.data.categories];
      catList.innerHTML = "";
      all.forEach(cat => {
        const btn = document.createElement("div");
        btn.className = "catbtn";
        if(cat === state.activeCat) btn.classList.add("active");
        btn.textContent = cat;
        btn.addEventListener("click", () => {
          state.activeCat = cat;
          renderCategories();
          renderGames();
        });
        catList.appendChild(btn);
      });

      categoryBadges.innerHTML = "";
      state.data.categories.forEach(cat => {
        const badge = document.createElement("div");
        badge.className = "catBadge";
        if(state.selectedCategories.includes(cat)){
          badge.classList.add("selected");
        }
        badge.textContent = cat;
        badge.addEventListener("click", () => {
          const idx = state.selectedCategories.indexOf(cat);
          if(idx >= 0){
            state.selectedCategories.splice(idx, 1);
          }else{
            state.selectedCategories.push(cat);
          }
          renderCategories();
        });
        categoryBadges.appendChild(badge);
      });
    }

    function renderGames(){
      let filtered = state.data.games;

      if(state.activeCat !== "ALL"){
        filtered = filtered.filter(g => {
          const cats = Array.isArray(g.categories) ? g.categories : [];
          return cats.includes(state.activeCat);
        });
      }

      if(state.query){
        const lq = state.query.toLowerCase();
        filtered = filtered.filter(g => g.name.toLowerCase().includes(lq));
      }

      gameGrid.innerHTML = "";
      if(filtered.length === 0){
        noGames.style.display = "block";
        return;
      }

      noGames.style.display = "none";
      filtered.forEach(g => {
        const card = document.createElement("div");
        card.className = "card";

        const bg = document.createElement("div");
        bg.className = "card-bg";
        const img = document.createElement("img");
        img.src = g.cover || "";
        img.alt = g.name;
        img.loading = "lazy";
        bg.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "card-overlay";

        const title = document.createElement("h3");
        title.className = "card-title";
        title.textContent = g.name;

        const downloadLink = document.createElement("a");
        downloadLink.className = "card-download";
        downloadLink.href = g.magnet;
        downloadLink.innerHTML = `
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
          </svg>
          T√©l√©charger
        `;
        downloadLink.addEventListener("click", (e) => e.stopPropagation());

        overlay.appendChild(title);
        overlay.appendChild(downloadLink);

        card.appendChild(bg);
        card.appendChild(overlay);

        card.addEventListener("click", () => {
          window.location.href = `game.html?name=${encodeURIComponent(g.name)}`;
        });

        gameGrid.appendChild(card);
      });
    }

    function renderAdminLists(){
      catListAdmin.innerHTML = "";
      state.data.categories.forEach((cat, idx) => {
        const row = document.createElement("div");
        row.className = "catRow";

        const name = document.createElement("span");
        name.className = "name";
        name.textContent = cat;

        const del = document.createElement("button");
        del.className = "iconBtn danger";
        del.textContent = "Suppr";
        del.addEventListener("click", () => {
          const ok = confirm(`Supprimer la cat√©gorie "${cat}" ?`);
          if(!ok) return;

          state.data.categories.splice(idx, 1);
          
          state.data.games.forEach(g => {
            if(Array.isArray(g.categories)){
              g.categories = g.categories.filter(c => c !== cat);
            }
          });

          saveLocalDraft();
          renderCategories();
          renderGames();
          renderAdminLists();
          toastMsg("Cat√©gorie supprim√©e");
        });

        row.appendChild(name);
        row.appendChild(del);
        catListAdmin.appendChild(row);
      });

      gameListAdmin.innerHTML = "";
      state.data.games.forEach((g, idx) => {
        const row = document.createElement("div");
        row.className = "gameRow";

        const left = document.createElement("div");
        left.className = "left";

        const thumb = document.createElement("img");
        thumb.className = "thumb";
        thumb.src = g.cover || "";
        thumb.alt = g.name;

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = g.name;

        const categories = Array.isArray(g.categories) ? g.categories : [];
        const catSpan = document.createElement("span");
        catSpan.className = "cat";
        catSpan.textContent = categories.join(", ") || "AUCUNE";

        left.appendChild(thumb);
        left.appendChild(nameSpan);
        left.appendChild(catSpan);

        const edit = document.createElement("button");
        edit.className = "iconBtn primary";
        edit.type = "button";
        edit.textContent = "Modif";
        edit.addEventListener("click", () => {
          editIndex = idx;
          addGameBtn.style.display = "none";
          saveEditBtn.style.display = "";
          cancelEditBtn.style.display = "";

          gameName.value = g.name;
          gameMagnet.value = g.magnet;
          gameCoverLink.value = g.cover || "";
          gameCover.value = g.cover || "";

          const gameCategories = Array.isArray(g.categories) ? g.categories : [];
          state.selectedCategories = [...gameCategories];
          
          gameCategories.forEach(cat => {
            if(!state.data.categories.includes(cat)){
              state.data.categories.push(cat);
            }
          });
          
          renderCategories();
          refreshPreview();
          toastMsg("Mode modification");
        });

        const del = document.createElement("button");
        del.className = "iconBtn danger";
        del.type = "button";
        del.textContent = "Suppr";
        del.addEventListener("click", () => {
          const ok = confirm(`Supprimer "${g.name}" ?`);
          if(!ok) return;
          state.data.games.splice(idx, 1);
          saveLocalDraft();
          renderGames();
          renderAdminLists();
          if(editIndex === idx) exitEditMode();
          toastMsg("Jeu supprim√©");
        });

        row.appendChild(left);
        row.appendChild(edit);
        row.appendChild(del);
        gameListAdmin.appendChild(row);
      });
    }

    function exitEditMode(){
      editIndex = null;
      addGameBtn.style.display = "";
      saveEditBtn.style.display = "none";
      cancelEditBtn.style.display = "none";
      gameName.value = "";
      gameMagnet.value = "";
      gameCover.value = "";
      gameCoverLink.value = "";
      state.selectedCategories = [];
      renderCategories();
      refreshPreview();
    }

    cancelEditBtn.addEventListener("click", exitEditMode);

    function openAdmin(){
      adminModal.classList.add("open");
      adminModal.setAttribute("aria-hidden", "false");
      refreshPreview();
      renderAdminLists();
      githubToken.value = loadGithubToken();
      workerUrl.value = loadWorkerUrl();
    }
    
    function closeAdminModal(){
      adminModal.classList.remove("open");
      adminModal.setAttribute("aria-hidden", "true");
    }

    saveTokenBtn.addEventListener("click", () => {
      const token = githubToken.value.trim();
      if(!token){
        toastMsg("‚ö†Ô∏è Token vide");
        return;
      }
      if(!token.startsWith("ghp_") && !token.startsWith("github_pat_")){
        const confirm = window.confirm("Le token ne commence pas par ghp_ ou github_pat_. Continuer ?");
        if(!confirm) return;
      }
      saveGithubToken(token);
      toastMsg("‚úÖ Token sauvegard√© localement");
    });

    saveWorkerBtn.addEventListener("click", () => {
      const url = workerUrl.value.trim();
      if(!url){
        toastMsg("‚ö†Ô∏è URL vide");
        return;
      }
      if(!url.startsWith("http")){
        toastMsg("‚ö†Ô∏è URL invalide (doit commencer par http)");
        return;
      }
      saveWorkerUrl(url);
      toastMsg("‚úÖ Worker URL sauvegard√©e");
    });

    adminEntry.addEventListener("click", () => {
      const pwd = prompt("Admin password:");
      if(pwd === ADMIN_PASSWORD){
        state.adminUnlocked = true;
        adminPill.style.display = "inline-flex";
        toastMsg("Admin unlocked");
        openAdmin();
      }else{
        toastMsg("Wrong password");
      }
    });

    closeAdmin.addEventListener("click", closeAdminModal);
    adminModal.addEventListener("click", (e) => { if(e.target === adminModal) closeAdminModal(); });
    window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeAdminModal(); });

    q.addEventListener("input", () => {
      state.query = q.value || "";
      renderGames();
    });

    addCatBtn.addEventListener("click", () => {
      const name = upper(catName.value);
      if(!name) return toastMsg("Cat√©gorie vide");
      if(name === "ALL") return toastMsg("ALL est r√©serv√©");
      if(state.data.categories.includes(name)) return toastMsg("D√©j√† existe");

      state.data.categories.push(name);
      catName.value = "";
      saveLocalDraft();
      renderCategories();
      renderAdminLists();
      toastMsg("Cat√©gorie ajout√©e");
    });

    addGameBtn.addEventListener("click", () => {
      if(editIndex !== null) return toastMsg("Tu es en mode modif (annule ou sauvegarde).");

      const name = norm(gameName.value);
      const magnet = norm(gameMagnet.value).replaceAll("&amp;", "&");
      const cover = norm(gameCover.value);

      if(!name) return toastMsg("Nom manquant");
      if(!magnet.startsWith("magnet:")) return toastMsg("Magnet invalide");
      if(!cover) return toastMsg("Cover manquante");
      
      if(state.selectedCategories.length === 0){
        return toastMsg("S√©lectionne au moins une cat√©gorie (ou utilise Auto-d√©tecter)");
      }

      state.selectedCategories.forEach(cat => {
        if(!state.data.categories.includes(cat)){
          state.data.categories.push(cat);
        }
      });

      state.data.games.unshift({ 
        name, 
        categories: [...state.selectedCategories], 
        magnet, 
        cover 
      });

      gameName.value = "";
      gameMagnet.value = "";
      gameCover.value = "";
      gameCoverLink.value = "";
      state.selectedCategories = [];

      saveLocalDraft();
      renderGames();
      renderCategories();
      renderAdminLists();
      toastMsg("Jeu ajout√©");
    });

    saveEditBtn.addEventListener("click", () => {
      if(editIndex === null) return;

      const name = norm(gameName.value);
      const magnet = norm(gameMagnet.value).replaceAll("&amp;", "&");
      const cover = norm(gameCover.value);

      if(!name) return toastMsg("Nom manquant");
      if(!magnet.startsWith("magnet:")) return toastMsg("Magnet invalide");
      if(!cover) return toastMsg("Cover manquante");
      
      if(state.selectedCategories.length === 0){
        return toastMsg("S√©lectionne au moins une cat√©gorie");
      }

      state.selectedCategories.forEach(cat => {
        if(!state.data.categories.includes(cat)){
          state.data.categories.push(cat);
        }
      });

      state.data.games[editIndex] = { 
        name, 
        categories: [...state.selectedCategories], 
        magnet, 
        cover 
      };

      saveLocalDraft();
      renderGames();
      renderCategories();
      renderAdminLists();
      exitEditMode();
      toastMsg("Modif sauvegard√©e");
    });

    resetBtn.addEventListener("click", () => {
      const ok = confirm("Reset local: revenir aux donn√©es du repo ?");
      if(!ok) return;
      localStorage.removeItem(LOCAL_KEY);
      toastMsg("Draft local supprim√©");
      init();
      closeAdminModal();
    });

    importBtn.addEventListener("click", () => filePick.click());
    filePick.addEventListener("change", async () => {
      const f = filePick.files?.[0];
      filePick.value = "";
      if(!f) return;
      try{
        const text = await f.text();
        const json = sanitizeData(JSON.parse(text));
        state.data = json;
        saveLocalDraft();
        renderCategories();
        renderGames();
        renderAdminLists();
        exitEditMode();
        toastMsg("Import OK");
      }catch{
        toastMsg("Import invalide");
      }
    });

    async function init(){
      setStateMessage("Chargement‚Ä¶");
      console.log("=== INIT START ===");

      const repoData = await loadDataFromRepo();
      const localDraft = loadLocalDraft();

      console.log("Local draft exists:", !!localDraft);
      console.log("Repo data exists:", !!repoData);

      if(localDraft){
        console.log("Using local draft");
        state.data = localDraft;
        setStateMessage("üì¶ Donn√©es locales charg√©es (pas encore publi√©es)");
        setTimeout(() => setStateMessage(""), 3000);
      }else if(repoData){
        console.log("Using repo data");
        state.data = repoData;
        setStateMessage("‚òÅÔ∏è Donn√©es GitHub charg√©es");
        setTimeout(() => setStateMessage(""), 3000);
      }else{
        console.log("Using DEFAULT_DATA");
        state.data = structuredClone(DEFAULT_DATA);
        setStateMessage("data.json introuvable (mode local).");
      }

      state.activeCat = "ALL";
      state.query = "";
      q.value = "";

      editIndex = null;
      exitEditMode();

      refreshPreview();
      renderCategories();
      renderGames();
      renderAdminLists();
      
      console.log("=== INIT END ===");
      console.log("State data:", state.data);
    }

    init();
  </script>
</body>
</html>
