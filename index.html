<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <meta name="description" content="CRACKUZU - Biblioth√®que de jeux optimis√©e" />
  <title>CRACKUZU</title>
  <style>
    :root{
      --bg0:#0b0e12;
      --bg1:#10151b;
      --glass:rgba(255,255,255,.03);
      --glass2:rgba(255,255,255,.02);
      --stroke:rgba(255,255,255,.15);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.6);
      --outer:20px;
      --gap:22px;
      --pad:18px;
      --r-xl:28px;
      --r-md:18px;
      --side:260px;
      --cardW:minmax(130px,1fr);
      --accent:#6490ff;
    }
    
    *{box-sizing:border-box}
    *,*::before,*::after{-webkit-tap-highlight-color:transparent}
    
    @media (prefers-reduced-motion:reduce){
      *,*::before,*::after{
        animation-duration:0.01ms !important;
        animation-iteration-count:1 !important;
        transition-duration:0.01ms !important;
      }
    }
    
    /* Animations GPU-only */
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(8px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    /* Animations */
    @keyframes fadeInUp{
      from{opacity:0;transform:translateY(20px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    @keyframes fadeInScale{
      from{opacity:0;transform:scale(0.95)}
      to{opacity:1;transform:scale(1)}
    }
    
    @keyframes slideInLeft{
      from{opacity:0;transform:translateX(-20px)}
      to{opacity:1;transform:translateX(0)}
    }
    
    @keyframes shimmer{
      0%{background-position:-200% center}
      100%{background-position:200% center}
    }
    
    @keyframes pulse{
      0%,100%{opacity:1}
      50%{opacity:0.7}
    }
    
    @keyframes float{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-5px)}
    }
    
    /* Card entrance animations */
    .card{
      animation:fadeInUp .4s ease backwards;
    }
    
    .card:nth-child(1){animation-delay:0.02s}
    .card:nth-child(2){animation-delay:0.04s}
    .card:nth-child(3){animation-delay:0.06s}
    .card:nth-child(4){animation-delay:0.08s}
    .card:nth-child(5){animation-delay:0.10s}
    .card:nth-child(6){animation-delay:0.12s}
    .card:nth-child(7){animation-delay:0.14s}
    .card:nth-child(8){animation-delay:0.16s}
    .card:nth-child(9){animation-delay:0.18s}
    .card:nth-child(10){animation-delay:0.20s}
    .card:nth-child(11){animation-delay:0.22s}
    .card:nth-child(12){animation-delay:0.24s}
    .card:nth-child(13){animation-delay:0.26s}
    .card:nth-child(14){animation-delay:0.28s}
    .card:nth-child(15){animation-delay:0.30s}
    .card:nth-child(16){animation-delay:0.32s}
    
    /* Enhanced card hover */
    .card:hover{
      transform:translateY(-8px) scale(1.02);
      box-shadow:0 20px 40px rgba(0,0,0,.3),0 0 30px rgba(100,140,255,.15);
    }
    
    .card:hover .card-bg img{
      transform:scale(1.08);
    }
    
    /* Category button animations */
    .catbtn{
      transition:all .2s cubic-bezier(0.4,0,0.2,1);
    }
    
    .catbtn:hover{
      transform:translateX(4px);
    }
    
    .catbtn.active{
      animation:pulse 2s infinite;
    }
    
    /* Header animation */
    header{
      animation:slideInLeft .5s ease;
    }
    
    /* Aside animation */
    aside{
      animation:fadeInScale .4s ease .1s backwards;
    }
    
    /* Section content animation */
    section{
      animation:fadeInScale .4s ease .15s backwards;
    }
    
    /* Search bar animation */
    .search{
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    
    .search:focus-within{
      transform:scale(1.02);
      box-shadow:0 8px 25px rgba(100,140,255,.2);
    }
    
    /* Brand logo float animation */
    .brand .big{
      animation:shimmer 6s infinite linear,float 4s ease-in-out infinite;
    }
    
    /* Loading skeleton shimmer */
    .skeleton{
      background:linear-gradient(90deg,rgba(255,255,255,.05) 25%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.05) 75%);
      background-size:200% 100%;
      animation:shimmer 1.5s infinite;
    }
    
    /* Modal animations */
    .modal{
      transition:opacity .3s ease;
    }
    
    .modal.open .adminBox{
      animation:fadeInScale .3s ease;
    }
    
    /* Toast animation */
    .toast{
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    
    /* Button hover effects */
    button,.catbtn{
      position:relative;
      overflow:hidden;
    }
    
    button::after,.catbtn::after{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      background:rgba(255,255,255,.2);
      border-radius:50%;
      transform:translate(-50%,-50%);
      transition:width .3s,height .3s;
    }
    
    button:active::after,.catbtn:active::after{
      width:200%;
      height:200%;
    }
    
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:transparent;
      overflow-x:hidden;
    }
    
    body{
      text-rendering:optimizeSpeed;
      -webkit-font-smoothing:antialiased;
    }
    
    /* FOND FLOUT√â DE BASE */
    .parallax-bg{
      position:fixed;
      inset:-100px;
      background:url('background.png') center center/cover no-repeat fixed;
      z-index:-1;
      filter:blur(20px) brightness(0.4) saturate(0.8);
      transform:translateZ(0);
      will-change:transform;
      pointer-events:none;
    }
    
    @media (pointer:coarse),(hover:none){
      .parallax-bg{
        filter:blur(12px) brightness(0.35) saturate(0.7);
      }
    }
    
    .app{
      min-height:100vh;
      padding:var(--outer);
      width:100%;
      contain:layout;
    }
    
    .shell{
      width:min(1800px,calc(100vw - 28px));
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      min-height:calc(100vh - 28px);
    }
    
    header{
      position:sticky;
      top:var(--outer);
      z-index:100;
      border-radius:var(--r-xl);
      padding:var(--pad);
      background:rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      display:grid;
      grid-template-columns:1fr;
      align-items:center;
      gap:var(--gap);
      contain:layout style;
      backdrop-filter:blur(20px) saturate(150%);
      -webkit-backdrop-filter:blur(20px) saturate(150%);
    }
    
    @media (pointer:coarse),(hover:none),(max-width:768px){
      header{
        background:rgba(255,255,255,.08);
        backdrop-filter:blur(16px) saturate(150%);
        -webkit-backdrop-filter:blur(16px) saturate(150%);
      }
    }
    
    .brand{
      text-align:center;
      user-select:none;
      contain:layout;
    }
    
    .brand .big{
      font-weight:300;
      letter-spacing:2px;
      font-size:clamp(24px,3vw,40px);
      background:linear-gradient(135deg,#fff 0%,#a0a0ff 50%,#fff 100%);
      background-size:200% auto;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      animation:shimmer 6s infinite linear;
    }
    
    @media (prefers-reduced-motion:reduce){
      .brand .big{animation:none}
    }
    
    .brand .small{
      margin-top:4px;
      font-size:12px;
      letter-spacing:2px;
      color:var(--muted);
      cursor:pointer;
    }
    
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.7);
    }
    
    .search{
      position:absolute;
      right:var(--pad);
      top:50%;
      transform:translateY(-50%);
      width:clamp(200px,25vw,320px);
      height:40px;
      border-radius:999px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.2);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      transition:all .2s ease;
      contain:layout;
    }
    
    .search:focus-within{
      background:rgba(255,255,255,.08);
      border-color:rgba(100,140,255,.5);
    }
    
    .search input{
      flex:1;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    
    .search input::placeholder{color:rgba(255,255,255,.4)}
    
    .main{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns:var(--side) 1fr;
      gap:var(--gap);
      contain:layout;
    }
    
    @media (max-width:1024px){
      .main{grid-template-columns:1fr}
      .search{position:static;transform:none;width:100%;margin-top:8px}
    }
    
    aside{
      border-radius:var(--r-xl);
      padding:var(--pad);
      background:rgba(255,255,255,.03);
      border:1px solid var(--stroke);
      display:flex;
      flex-direction:column;
      min-height:0;
      contain:layout style;
      backdrop-filter:blur(16px) saturate(150%);
      -webkit-backdrop-filter:blur(16px) saturate(150%);
    }
    
    @media (max-width:1024px){
      aside{position:fixed;bottom:0;left:0;right:0;z-index:99;border-radius:var(--r-xl) var(--r-xl) 0 0;max-height:60vh;transform:translateY(calc(100% - 60px));transition:transform .3s ease}
      aside.expanded{transform:translateY(0)}
    }
    
    aside h2{
      margin:6px 0 12px;
      text-align:center;
      font-weight:400;
      font-size:18px;
      color:rgba(255,255,255,.85);
      contain:layout;
    }
    
    .catlist{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
      overflow-y:visible;
      -webkit-overflow-scrolling:touch;
    }
    
    .catbtn{
      height:44px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:500;
      font-size:13px;
      letter-spacing:.5px;
      color:rgba(255,255,255,.7);
      cursor:pointer;
      transition:all .15s ease;
      user-select:none;
      contain:layout;
      will-change:transform;
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
    }
    
    .catbtn:hover,.catbtn.active{
      background:rgba(100,140,255,.15);
      border-color:rgba(100,140,255,.4);
      color:#fff;
      transform:translateY(-1px);
    }
    
    .catbtn.active{
      box-shadow:0 4px 15px rgba(100,140,255,.2);
    }
    
    section{
      border-radius:var(--r-xl);
      padding:var(--pad);
      background:rgba(255,255,255,.02);
      border:1px solid var(--stroke);
      min-height:0;
      overflow:auto;
      contain:layout style;
      -webkit-overflow-scrolling:touch;
      backdrop-filter:blur(16px) saturate(150%);
      -webkit-backdrop-filter:blur(16px) saturate(150%);
    }
    
    .grid{
      display:grid;
      gap:var(--gap);
      grid-template-columns:repeat(8,1fr);
      align-content:start;
      contain:layout;
      min-height:200px;
    }
    
    @media (max-width:1400px){.grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:1200px){.grid{grid-template-columns:repeat(5,1fr)}}
    @media (max-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:768px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:480px){.grid{grid-template-columns:repeat(2,1fr)}}
    
    .card{
      position:relative;
      border-radius:var(--r-md);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.03);
      aspect-ratio:3/4;
      cursor:pointer;
      transform:translateZ(0);
      transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease;
      will-change:transform;
      backdrop-filter:blur(12px) saturate(150%);
      -webkit-backdrop-filter:blur(12px) saturate(150%);
    }
    
    .card:hover{
      transform:translateY(-6px) scale(1.02);
      border-color:rgba(100,140,255,.4);
      box-shadow:0 12px 30px rgba(0,0,0,.4),0 0 20px rgba(100,140,255,.1);
      background:rgba(255,255,255,.05);
    }
    
    @media (pointer:coarse),(hover:none){
      .card:hover{transform:none;box-shadow:none}
      .card:active{transform:scale(.98)}
    }
    
    .card-bg{
      position:absolute;
      inset:0;
      overflow:hidden;
      contain:strict;
    }
    
    .card-bg img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      transition:transform .4s ease;
      will-change:transform;
    }
    
    .card:hover .card-bg img{transform:scale(1.05)}
    
    .card.saga-card{
      contain:none !important;
      content-visibility:visible !important;
      contain-intrinsic-size:auto !important;
    }
    
    .card.saga-card .card-bg{
      contain:none !important;
    }
    
    /* Saga cards - Glassmorphic V2 style */
    .saga-card-glass{
      position:relative;
      border-radius:var(--r-md);
      overflow:hidden;
      border:1px solid rgba(255,215,0,.25);
      background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      backdrop-filter:blur(16px) saturate(180%);
      -webkit-backdrop-filter:blur(16px) saturate(180%);
      box-shadow:
        0 20px 60px rgba(0,0,0,.4),
        inset 0 1px 0 rgba(255,255,255,.15),
        0 0 30px rgba(255,215,0,.1);
      /* Size: 2 covers wide √ó 1 cover tall */
      grid-column:span 2;
      grid-row:span 1;
      min-height:0;
      cursor:pointer;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    
    .saga-card-glass:hover{
      transform:translateY(-8px) scale(1.02);
      border-color:rgba(255,215,0,.5);
      box-shadow:
        0 28px 80px rgba(0,0,0,.5),
        0 0 40px rgba(255,215,0,.2);
    }
    
    .saga-badge-glass{
      position:absolute;
      top:10px;
      left:10px;
      background:linear-gradient(135deg,rgba(255,215,0,.9),rgba(255,140,0,.9));
      color:#000;
      font-size:11px;
      font-weight:700;
      padding:4px 12px;
      border-radius:999px;
      letter-spacing:1px;
      z-index:20;
      box-shadow:0 4px 15px rgba(255,215,0,.3);
    }
    
    /* Cover stack - EXACT V2 style */
    .saga-cover-stack{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    
    .saga-cover-stack img{
      position:absolute;
      width:40%;
      height:85%;
      object-fit:cover;
      border-radius:20px;
      box-shadow:0 8px 25px rgba(0,0,0,.5);
      transition:transform .3s;
    }
    
    /* Image 1 - center (first game) */
    .saga-cover-stack img:nth-child(1){
      transform:translateX(0) rotate(0) scale(1);
      z-index:3;
      box-shadow:0 12px 40px rgba(0,0,0,.6);
    }
    /* Image 2 - left rotated */
    .saga-cover-stack img:nth-child(2){
      transform:translateX(-25%) rotate(-5deg) scale(.9);
      z-index:1;
      opacity:.7;
    }
    /* Image 3 - right rotated */
    .saga-cover-stack img:nth-child(3){
      transform:translateX(25%) rotate(5deg) scale(.9);
      z-index:1;
      opacity:.7;
    }
    
    /* Hover effects - V2 style */
    .saga-card-glass:hover .saga-cover-stack img:nth-child(1){
      transform:translateX(0) rotate(0) scale(1.05);
    }
    .saga-card-glass:hover .saga-cover-stack img:nth-child(2){
      transform:translateX(-40%) rotate(-8deg) scale(.85);
    }
    .saga-card-glass:hover .saga-cover-stack img:nth-child(3){
      transform:translateX(40%) rotate(8deg) scale(.85);
    }
    
    .saga-info-glass{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background:linear-gradient(to top,rgba(0,0,0,.9) 0%,rgba(0,0,0,.5) 50%,transparent 100%);
      padding:25px 16px 16px;
      z-index:30;
    }
    
    .saga-title-glass{
      font-size:clamp(15px,1.3vw,18px);
      font-weight:600;
      color:rgba(255,255,255,.95);
      text-shadow:0 2px 8px rgba(0,0,0,.5);
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    .saga-meta-glass{
      font-size:12px;
      color:rgba(255,255,255,.7);
      font-weight:500;
    }
    
    /* Sagas in home view - force height based on width */
    .sagas-home-grid{
      grid-auto-rows: auto;
    }
    .sagas-home-grid .saga-card-glass{
      aspect-ratio:3/2 !important;
      height:auto !important;
    }
    
    .card-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(to bottom,transparent 30%,rgba(0,0,0,.7) 100%);
      opacity:0;
      transition:opacity .2s ease;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:12px;
      gap:6px;
      contain:layout;
      pointer-events:none;
    }
    
    .card:hover .card-overlay{opacity:1}
    
    @media (pointer:coarse),(hover:none){
      .card-overlay{opacity:1;background:linear-gradient(to bottom,transparent 50%,rgba(0,0,0,.85) 100%)}
    }
    
    .card-title{
      font-size:13px;
      font-weight:600;
      color:#fff;
      text-shadow:0 2px 4px rgba(0,0,0,.5);
      line-height:1.3;
      margin:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    
    .card-download{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:6px 10px;
      border-radius:6px;
      background:rgba(255,255,255,.15);
      border:1px solid rgba(255,255,255,.2);
      color:#fff;
      font-size:11px;
      font-weight:500;
      text-decoration:none;
      transition:all .15s ease;
      pointer-events:auto;
    }
    
    .card-download:hover{background:rgba(255,255,255,.25)}
    
    .card-download svg{width:12px;height:12px}
    
    .pagination-container{
      grid-column:1/-1;
      display:flex;
      justify-content:center;
      gap:8px;
      padding:20px 0;
      flex-wrap:wrap;
    }
    
    .pagination-btn{
      padding:8px 14px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.1);
      background:rgba(255,255,255,.05);
      color:rgba(255,255,255,.8);
      font-size:13px;
      cursor:pointer;
      transition:all .15s ease;
      min-width:40px;
    }
    
    .pagination-btn:hover,.pagination-btn.active{
      background:rgba(100,140,255,.2);
      border-color:rgba(100,140,255,.4);
      color:#fff;
    }
    
    .modal{
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(10,10,18,.2);
      backdrop-filter:blur(8px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:var(--outer);
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
      contain:strict;
    }
    
    .modal.open{opacity:1;pointer-events:all}
    
    .adminBox{
      background:rgba(20,25,35,.6);
      backdrop-filter:blur(20px) saturate(180%);
      border-radius:var(--r-xl);
      border:1px solid rgba(255,255,255,.15);
      width:min(900px,95vw);
      max-height:90vh;
      display:grid;
      grid-template-columns:240px 1fr;
      overflow:hidden;
      contain:layout;
    }
    
    @media (max-width:768px){
      .adminBox{grid-template-columns:1fr;max-height:95vh}
    }
    
    .adminSidebar{
      background:rgba(0,0,0,.3);
      border-right:1px solid var(--stroke);
      padding:20px;
      overflow-y:auto;
    }
    
    .adminNavBtn{
      padding:10px 14px;
      border-radius:8px;
      border:1px solid transparent;
      background:transparent;
      color:rgba(255,255,255,.7);
      font-size:13px;
      cursor:pointer;
      transition:all .15s ease;
      text-align:left;
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
      margin-bottom:4px;
    }
    
    .adminNavBtn:hover{background:rgba(255,255,255,.06);color:#fff}
    .adminNavBtn.active{background:rgba(100,140,255,.15);border-color:rgba(100,140,255,.3);color:#fff}
    
    .adminContent{
      overflow-y:auto;
      padding:24px;
      max-height:calc(90vh - 60px);
      -webkit-overflow-scrolling:touch;
    }
    
    input,textarea{
      width:100%;
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-size:13px;
      outline:0;
      transition:border-color .2s ease;
      font-family:inherit;
    }
    
    input:focus,textarea:focus{border-color:var(--accent);background:rgba(255,255,255,.08)}
    
    .formRow{display:flex;gap:12px;margin-bottom:12px;align-items:flex-end}
    .formRow>div{flex:1}
    
    button,.btn{
      padding:8px 16px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.1);
      color:rgba(255,255,255,.9);
      font-size:13px;
      cursor:pointer;
      transition:all .15s ease;
      font-family:inherit;
    }
    
    button:hover{background:rgba(255,255,255,.15);transform:translateY(-1px)}
    button.primary{background:rgba(100,140,255,.2);border-color:rgba(100,140,255,.3)}
    button.danger{background:rgba(255,80,100,.15);border-color:rgba(255,80,100,.3)}
    
    .toast{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%) translateY(100px);
      padding:10px 20px;
      border-radius:10px;
      background:rgba(20,25,35,.95);
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
      box-shadow:0 8px 30px rgba(0,0,0,.5);
      z-index:10000;
      font-size:13px;
      opacity:0;
      transition:all .3s ease;
      pointer-events:none;
      contain:layout;
    }
    
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    
    .noGames{
      text-align:center;
      color:rgba(255,255,255,.5);
      padding:40px 20px;
      font-style:italic;
      grid-column:1/-1;
    }
    
    .gameListContainer{
      max-height:40vh;
      overflow-y:auto;
      border:1px solid var(--stroke);
      border-radius:10px;
      padding:10px;
      background:rgba(255,255,255,.02);
      margin-top:12px;
      -webkit-overflow-scrolling:touch;
    }
    
    .gameRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:6px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      margin-bottom:6px;
      transition:background .15s ease;
    }
    
    .gameRow:hover{background:rgba(255,255,255,.06)}
    
    .gameRow .thumb{width:32px;height:42px;border-radius:4px;object-fit:cover;flex-shrink:0}
    .gameRow .name{font-size:13px;color:rgba(255,255,255,.9);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .gameRow .cat{font-size:10px;padding:2px 6px;border-radius:999px;background:rgba(255,255,255,.1);color:rgba(255,255,255,.6)}
    .iconBtn{padding:6px 10px;font-size:11px}
    
    .categoryBadges{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .catBadge{padding:4px 10px;border-radius:6px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.7);font-size:11px;cursor:pointer;transition:all .15s ease}
    .catBadge:hover{background:rgba(255,255,255,.1)}
    .catBadge.selected{background:rgba(100,140,255,.15);border-color:rgba(100,140,255,.3);color:#fff}
    
    .selectedCategories{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,.03);min-height:40px}
    .selectedCat{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;background:rgba(100,140,255,.2);color:#fff;font-size:11px}
    .selectedCat .remove{cursor:pointer;opacity:.7;transition:opacity .15s ease}
    .selectedCat .remove:hover{opacity:1}
    
    .sidefoot{
      margin-top:auto;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      color:rgba(255,255,255,.5);
      font-size:11px;
    }
    
    .mobile-cat-toggle{
      display:none;
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:98;
      width:50px;
      height:50px;
      border-radius:50%;
      background:rgba(100,140,255,.9);
      border:none;
      color:#fff;
      font-size:20px;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(100,140,255,.4);
    }
    
    @media (max-width:1024px){
      .mobile-cat-toggle{display:flex;align-items:center;justify-content:center}
    }
    
    .state-msg{
      position:fixed;
      top:80px;
      left:50%;
      transform:translateX(-50%);
      padding:8px 16px;
      border-radius:20px;
      background:rgba(20,25,35,.9);
      border:1px solid rgba(255,255,255,.1);
      color:rgba(255,255,255,.8);
      font-size:12px;
      z-index:90;
      opacity:0;
      transition:opacity .3s ease;
      pointer-events:none;
    }
    
    .state-msg.show{opacity:1}
    
    .closeBtn{
      position:absolute;
      top:16px;
      right:16px;
      width:32px;
      height:32px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.08);
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      transition:all .2s ease;
    }
    
    .closeBtn:hover{background:rgba(255,255,255,.15);transform:rotate(90deg)}
    
    .adminSection{display:none;animation:fadeIn .3s ease}
    .adminSection.active{display:block}
    
    @media (prefers-reduced-motion:reduce),(update:slow){
      .card{transition:none}
      .card-bg img{transition:none}
      .brand .big{animation:none}
    }
    
    /* ===== RECHERCHE IMMERSIVE ===== */
    .search-overlay{
      position:fixed;
      inset:0;
      z-index:9998;
      background:rgba(10,10,18,.85);
      backdrop-filter:blur(20px) saturate(180%);
      opacity:0;
      pointer-events:none;
      transition:opacity .4s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-top:15vh;
    }
    
    .search-overlay.active{opacity:1;pointer-events:all}
    
    .search-immersive{
      width:min(700px,90vw);
      position:relative;
      transform:translateY(-30px) scale(.9);
      opacity:0;
      transition:all .5s cubic-bezier(.34,1.56,.64,1);
    }
    
    .search-overlay.active .search-immersive{
      transform:translateY(0) scale(1);
      opacity:1;
    }
    
    .search-immersive-box{
      display:flex;
      align-items:center;
      gap:16px;
      padding:0 24px;
      height:64px;
      border-radius:20px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 8px 32px rgba(0,0,0,.3);
      backdrop-filter:blur(20px);
    }
    
    .search-immersive-box:focus-within{
      background:rgba(255,255,255,.12);
      border-color:rgba(100,140,255,.5);
      box-shadow:0 12px 48px rgba(0,0,0,.4),0 0 30px rgba(100,140,255,.2);
      transform:scale(1.02);
    }
    
    .search-immersive input{
      flex:1;
      border:0;
      outline:0;
      background:transparent;
      color:#fff;
      font-size:18px;
    }
    
    .search-immersive-close{
      width:36px;
      height:36px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.7);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .2s ease;
    }
    
    .search-immersive-close:hover{
      background:rgba(255,255,255,.15);
      color:#fff;
      transform:rotate(90deg);
    }
    
    .search-results{
      width:min(700px,90vw);
      max-height:50vh;
      margin-top:20px;
      overflow-y:auto;
      border-radius:16px;
      background:rgba(18,22,32,.95);
      border:1px solid rgba(255,255,255,.1);
      transform:translateY(20px);
      opacity:0;
      transition:all .4s ease .1s;
    }
    
    .search-overlay.active .search-results{
      transform:translateY(0);
      opacity:1;
    }
    
    .search-result-item{
      display:flex;
      align-items:center;
      gap:16px;
      padding:14px 20px;
      cursor:pointer;
      transition:all .2s ease;
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    
    .search-result-item:hover{
      background:rgba(100,140,255,.1);
      padding-left:28px;
    }
    
    .search-result-cover{
      width:50px;
      height:67px;
      border-radius:6px;
      overflow:hidden;
      flex-shrink:0;
    }
    
    .search-result-cover img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    
    .search-result-name{
      font-size:15px;
      font-weight:500;
      color:#fff;
    }
    
    .search-result-cat{
      font-size:11px;
      color:rgba(255,255,255,.5);
      margin-top:4px;
    }
  </style>
</head>
<body>
  <div class="parallax-bg" id="parallaxBg"></div>
  
  <div class="app">
    <div class="shell">
      <header id="mainHeader">
        <div class="brand">
          <div class="big">CRACKUZU</div>
          <div class="small" id="adminEntry">BY CR…ÖCKUZU</div>
        </div>
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="search" id="searchInput" placeholder="Rechercher un jeu..." autocomplete="off" />
        </div>
      </header>
      
      <div class="main">
        <aside id="catAside">
          <h2>CAT√âGORIES</h2>
          <div class="catlist" id="catList"></div>
          <div class="sidefoot">
            <span id="versionInfo">-</span>
            <span style="color:inherit"><a href="https://discord.gg/votre-invite" target="_blank" style="color:inherit;text-decoration:none;">Discord</a></span>
          </div>
        </aside>
        
        <section id="gameSection">
          <div class="grid" id="gameGrid"></div>
          <div class="noGames" id="noGames" style="display:none">Aucun jeu trouv√©</div>
        </section>
      </div>
    </div>
  </div>
  
  <button class="mobile-cat-toggle" id="mobileCatToggle">‚ò∞</button>
  
  <div class="state-msg" id="stateMsg"></div>
  
  <div class="toast" id="toast"></div>
  
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="adminBox">
      <div class="adminSidebar">
        <h2 style="margin:0 0 20px;font-size:20px;font-weight:400">Admin</h2>
        <div class="adminNav">
          <button class="adminNavBtn active" data-section="add">+ Ajouter</button>
          <button class="adminNavBtn" data-section="list">Jeux</button>
          <button class="adminNavBtn" data-section="cats">Cat√©gories</button>
          <button class="adminNavBtn" data-section="import">Import/Export</button>
        </div>
      </div>
      <div class="adminContent">
        <button class="closeBtn" id="closeAdmin">√ó</button>
        
        <div class="adminSection active" id="sectionAdd">
          <h3>Ajouter un jeu</h3>
          <div class="formRow">
            <div><label>Nom</label><input type="text" id="gameName" placeholder="Nom du jeu" /></div>
            <div><label>Cover URL</label><input type="text" id="gameCover" placeholder="https://..." /></div>
          </div>
          <div class="formRow">
            <div style="flex:2"><label>Magnet</label><input type="text" id="gameMagnet" placeholder="magnet:?xt=..." /></div>
            <div><label>Lien Direct</label><input type="text" id="gameDirectLink" placeholder="https://..." /></div>
          </div>
          <div class="formRow">
            <div><label>Cat√©gories</label>
              <div class="selectedCategories" id="selectedCategories"><span style="color:rgba(255,255,255,.4);font-size:12px">Aucune cat√©gorie s√©lectionn√©e</span></div>
            </div>
          </div>
          <div class="categoryBadges" id="categoryBadges"></div>
          <div class="formRow" style="margin-top:16px">
            <button class="primary" id="addGameBtn">Ajouter</button>
            <button id="saveEditBtn" style="display:none">Sauvegarder</button>
            <button id="cancelEditBtn" style="display:none;background:transparent">Annuler</button>
          </div>
        </div>
        
        <div class="adminSection" id="sectionList">
          <h3>Liste des jeux</h3>
          <input type="text" id="adminGameSearch" placeholder="Rechercher..." style="margin-bottom:12px" />
          <div class="gameListContainer" id="gameListAdmin"></div>
        </div>
        
        <div class="adminSection" id="sectionCats">
          <h3>G√©rer les cat√©gories</h3>
          <div class="formRow">
            <div><input type="text" id="newCatName" placeholder="Nouvelle cat√©gorie" /></div>
            <button id="addCatBtn">Ajouter</button>
          </div>
          <div id="catListAdmin" style="margin-top:16px"></div>
        </div>
        
        <div class="adminSection" id="sectionImport">
          <h3>Import / Export</h3>
          <div style="display:flex;gap:12px;margin-bottom:20px">
            <button id="exportBtn" class="primary">Exporter JSON</button>
            <button id="importBtn">Importer JSON</button>
            <input type="file" id="importFile" accept=".json" style="display:none" />
          </div>
          <button id="resetBtn" class="danger">Reset Local</button>
        </div>
      </div>
    </div>
  </div>

  <div class="search-overlay" id="searchOverlay">
    <div class="search-immersive">
      <div class="search-immersive-box">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="immersiveSearchInput" placeholder="Rechercher un jeu..." autocomplete="off" />
        <button class="search-immersive-close" id="closeSearchOverlay">√ó</button>
      </div>
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const CONFIG = {
      ITEMS_PER_PAGE: 48,
      SEARCH_DEBOUNCE: 150,
      MAX_CACHE_SIZE: 5000
    };
    
    const LOCAL_KEY = 'crackuzu_data_v1';
    const ADMIN_PASSWORD = 'admin123';
    
    // ==================== √âTAT ====================
    const state = {
      data: { categories: [], games: [], sagas: [] },
      activeCat: 'HOME',
      query: '',
      currentPage: 1,
      dataLoaded: false,
      adminUnlocked: false,
      editIndex: null,
      selectedCategories: [],
      isLowPower: false
    };
    
    const dom = {};
    const normCache = new Map();
    let gameMap = new Map();
    
    // ==================== D√âTECTION ====================
    function detectLowPower(){
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isOld = !('IntersectionObserver' in window);
      state.isLowPower = isMobile || isOld;
    }
    
    // ==================== UTILITAIRES ====================
    function $(id){ return document.getElementById(id); }
    function norm(str){ return str ? str.toString().trim() : ''; }
    function upper(str){ return norm(str).toUpperCase(); }
    
    function normalizeSearch(str){
      if(!str) return '';
      if(normCache.has(str)) return normCache.get(str);
      const n = str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]/g, '');
      if(normCache.size > CONFIG.MAX_CACHE_SIZE) normCache.clear();
      normCache.set(str, n);
      return n;
    }
    
    function fuzzyScore(query, target){
      const q = normalizeSearch(query);
      const t = normalizeSearch(target);
      if(q === t) return 1000;
      if(t.includes(q)) return 900 + (q.length / t.length) * 100;
      let qi = 0;
      for(let i = 0; i < t.length && qi < q.length; i++){
        if(t[i] === q[qi]) qi++;
      }
      if(qi === q.length) return 700 + (q.length / t.length) * 100;
      return 0;
    }
    
    function cacheDOM(){
      ['gameGrid','catList','searchInput','noGames','gameCount','adminModal','closeAdmin',
       'gameName','gameMagnet','gameCover','gameDirectLink','addGameBtn','saveEditBtn','cancelEditBtn',
       'gameListAdmin','catListAdmin','sectionAdd','sectionList','sectionCats','sectionImport',
       'selectedCategories','categoryBadges','toast','stateMsg','mobileCatToggle','catAside',
       'adminGameSearch','newCatName','addCatBtn','exportBtn','importBtn','importFile','resetBtn',
       'adminEntry','parallaxBg'].forEach(id => dom[id] = $(id));
    }
    
    // ==================== DONN√âES ====================
    async function loadData(){
      setStateMessage('Chargement...');
      console.log('[loadData] Starting...');
      try{
        const res = await fetch('data.json', { cache: 'no-cache' });
        console.log('[loadData] fetch response:', res.status, res.ok);
        if(res.ok){
          const data = await res.json();
          console.log('[loadData] data received:', data ? 'yes' : 'no', 'games:', data?.games?.length);
          if(data && data.games){
            state.data = { categories: data.categories || [], games: data.games || [], sagas: data.sagas || [] };
            buildIndexes();
            state.dataLoaded = true;
            setStateMessage(`${state.data.games.length} jeux`);
            setTimeout(() => setStateMessage(''), 1500);
            console.log('[loadData] Success, games loaded:', state.data.games.length);
            // Update game count display
            const versionInfo = document.getElementById('versionInfo');
            if(versionInfo) versionInfo.textContent = formatGameCount(state.data.games.length);
            return;
          }
        }
      }catch(e){
        console.error('[loadData] Error fetching:', e);
      }
      
      const local = localStorage.getItem(LOCAL_KEY);
      console.log('[loadData] Trying localStorage:', local ? 'found' : 'not found');
      if(local){
        try{
          state.data = JSON.parse(local);
          buildIndexes();
          state.dataLoaded = true;
          setStateMessage(`${state.data.games.length} jeux (local)`);
          setTimeout(() => setStateMessage(''), 1500);
          console.log('[loadData] Local data loaded:', state.data.games.length);
          // Update game count display
          const versionInfo = document.getElementById('versionInfo');
          if(versionInfo) versionInfo.textContent = formatGameCount(state.data.games.length);
        }catch(e){
          console.error('[loadData] Error parsing local:', e);
        }
      } else {
        console.log('[loadData] No data found anywhere');
        setStateMessage('Aucune donn√©e - Cliquez sur "by Crackuzu" pour admin');
      }
    }
    
    function buildIndexes(){
      console.log('[buildIndexes] Building indexes for', state.data?.games?.length || 0, 'games');
      if(!state.data.games) state.data.games = [];
      gameMap = new Map(state.data.games.map(g => [g.name, g]));
    }
    
    function formatGameCount(count){
      if(count >= 1000000) return (count / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
      if(count >= 1000) return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
      return count.toString();
    }
    
    // ==================== RENDU ====================
    function renderCategories(){
      const cats = ['HOME', 'ALL', ...state.data.categories];
      dom.catList.innerHTML = cats.map(cat => {
        const active = state.activeCat === cat ? 'active' : '';
        const label = cat === 'HOME' ? 'üè† Accueil' : cat === 'ALL' ? 'Tous' : cat;
        return `<button class="catbtn ${active}" data-cat="${cat}">${label}</button>`;
      }).join('');
      
      dom.catList.querySelectorAll('.catbtn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.activeCat = btn.dataset.cat;
          state.currentPage = 1;
          state.query = '';
          dom.searchInput.value = '';
          renderCategories();
          renderGames();
          if(window.innerWidth <= 1024) dom.catAside.classList.remove('expanded');
        });
      });
    }
    
    function getGamesInSagasSet(){
      const set = new Set();
      (state.data.sagas || []).forEach(saga => {
        (saga.games || []).forEach(g => set.add(g));
      });
      return set;
    }
    
    function getFiltered(){
      let games = state.data.games;
      if(state.activeCat !== 'ALL'){
        games = games.filter(g => (g.categories || []).includes(state.activeCat));
      }
      if(state.query.trim()){
        games = games.filter(g => fuzzyScore(state.query, g.name) > 50)
          .sort((a, b) => fuzzyScore(state.query, b.name) - fuzzyScore(state.query, a.name));
      }
      return games;
    }
    
    function renderGames(){
      const debugInfo = document.getElementById('debugInfo');
      console.log('[renderGames] Starting, games count:', state.data?.games?.length || 0, 'activeCat:', state.activeCat);
      
      // Handle HOME view
      if(state.activeCat === 'HOME'){
        renderHomeView();
        return;
      }
      
      if(debugInfo){
        debugInfo.textContent = `Debug: ${state.data?.games?.length || 0} jeux charg√©s, cat: ${state.activeCat}, query: "${state.query}"`;
      }
      
      const games = getFiltered();
      console.log('[renderGames] Filtered games:', games.length);
      
      if(games.length === 0){
        console.log('[renderGames] No games to display');
        dom.gameGrid.innerHTML = '';
        dom.noGames.style.display = 'block';
        if(debugInfo) dom.gameGrid.appendChild(debugInfo);
        return;
      }
      
      dom.noGames.style.display = 'none';
      
      const start = (state.currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
      const end = Math.min(start + CONFIG.ITEMS_PER_PAGE, games.length);
      const pageGames = games.slice(start, end);
      console.log('[renderGames] Displaying games', start, 'to', end, 'total:', games.length);
      
      // Get sagas and standalone games
      const gamesInSagas = getGamesInSagasSet();
      const gamesSet = new Set(pageGames.map(g => g.name));
      
      // Find sagas that have games in current page
      const visibleSagas = (state.data.sagas || []).filter(saga => 
        saga.games && saga.games.some(g => gamesSet.has(g))
      );
      
      // Standalone games (not in any saga)
      const standaloneGames = pageGames.filter(g => !gamesInSagas.has(g.name));
      
      const fragment = document.createDocumentFragment();
      
      // Render sagas first
      visibleSagas.forEach(saga => {
        const sagaCard = createSagaCard(saga);
        fragment.appendChild(sagaCard);
      });
      
      // Then render standalone games
      standaloneGames.forEach((game, idx) => {
        const card = createCard(game, start + idx);
        fragment.appendChild(card);
      });
      
      dom.gameGrid.innerHTML = '';
      dom.gameGrid.appendChild(fragment);
      
      setupLazyImages();
      renderPagination(games.length);
      console.log('[renderGames] Done, sagas:', visibleSagas.length, 'standalone:', standaloneGames.length);
    }
    
    function createSagaCard(saga){
      const card = document.createElement('div');
      card.className = 'saga-card-glass';
      
      // Get up to 3 covers from saga games
      const gameMap = new Map(state.data.games.map(g => [g.name, g]));
      const covers = saga.games.slice(0, 3).map(name => {
        const game = gameMap.get(name);
        return game?.cover || '';
      }).filter(c => c);
      
      // Create stacked covers HTML like V2 - simple structure, CSS handles positioning
      let coversHTML = '<div class="saga-cover-stack">';
      covers.forEach((cover) => {
        coversHTML += `<img src="${cover}" loading="lazy" alt="" onerror="this.style.display='none'">`;
      });
      coversHTML += '</div>';
      
      card.innerHTML = `
        <div class="saga-badge-glass">SAGA</div>
        ${coversHTML}
        <div class="saga-info-glass">
          <div class="saga-title-glass">${escapeHtml(saga.name)}</div>
          <div class="saga-meta-glass">${saga.games.length} jeux</div>
        </div>
      `;
      
      // Add scroll handler for cover stack (like V2)
      let scrollPos = 0;
      const maxPos = 2;
      let isHovering = false;
      
      card.addEventListener('mouseenter', () => { isHovering = true; });
      card.addEventListener('mouseleave', () => { isHovering = false; });
      
      card.addEventListener('wheel', (e) => {
        if (!isHovering) return;
        e.preventDefault();
        e.stopPropagation();
        
        const direction = e.deltaY > 0 ? 1 : -1;
        scrollPos = (scrollPos + direction + (maxPos + 1)) % (maxPos + 1);
        
        card.classList.remove('stack-pos-1', 'stack-pos-2');
        if (scrollPos > 0) {
          card.classList.add(`stack-pos-${scrollPos}`);
        }
      }, { passive: false, capture: true });
      
      card.addEventListener('click', () => openSagaModal(saga));
      return card;
    }
    
    function openDownloadModal(game){
      const modal = document.createElement('div');
      modal.className = 'modal open';
      modal.id = 'downloadModal';
      
      const hasDirect = game.directLink && game.directLink.trim();
      const hasMagnet = game.magnet && game.magnet.trim();
      
      modal.innerHTML = `
        <div class="adminBox" style="max-width:500px;width:90vw;padding:0;overflow:hidden;position:relative;">
          <!-- Background cover -->
          <div style="position:absolute;inset:0;z-index:0;">
            <img src="${game.cover}" style="width:100%;height:100%;object-fit:cover;filter:blur(20px) brightness(0.4);" />
          </div>
          <!-- Content -->
          <div style="position:relative;z-index:1;padding:40px;text-align:center;">
            <button class="closeBtn" onclick="this.closest('.modal').remove()" style="position:absolute;top:16px;right:16px;">√ó</button>
            
            <!-- Game cover -->
            <div style="width:200px;height:280px;margin:0 auto 24px;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5);">
              <img src="${game.cover}" style="width:100%;height:100%;object-fit:cover;" />
            </div>
            
            <!-- Title -->
            <h2 style="margin:0 0 32px;font-size:28px;font-weight:600;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.5);">${escapeHtml(game.name)}</h2>
            
            <!-- Buttons -->
            <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;">
              ${hasMagnet ? `
                <a href="${game.magnet}" target="_blank" style="text-decoration:none;">
                  <button style="padding:14px 28px;border-radius:10px;border:1px solid rgba(100,140,255,.5);background:rgba(100,140,255,.2);color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);" onmouseover="this.style.background='rgba(100,140,255,.3)'" onmouseout="this.style.background='rgba(100,140,255,.2)'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                    Torrent
                  </button>
                </a>
              ` : ''}
              ${hasDirect ? `
                <a href="${game.directLink}" target="_blank" style="text-decoration:none;">
                  <button style="padding:14px 28px;border-radius:10px;border:1px solid rgba(80,200,120,.5);background:rgba(80,200,120,.2);color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);" onmouseover="this.style.background='rgba(80,200,120,.3)'" onmouseout="this.style.background='rgba(80,200,120,.2)'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                    Direct
                  </button>
                </a>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      modal.addEventListener('click', (e) => {
        if(e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }
    
    // Global function for opening download modal by game name
    window.openDownloadModalByName = function(gameName){
      try {
        const decodedName = decodeURIComponent(gameName);
        const game = state.data.games.find(g => g.name === decodedName);
        if(game) {
          openDownloadModal(game);
        } else {
          console.error('Game not found:', decodedName);
        }
      } catch(e) {
        console.error('Error opening download modal:', e);
      }
    };
    
    function openSagaModal(saga){
      const gameMap = new Map(state.data.games.map(g => [g.name, g]));
      const sagaGames = saga.games.map((name, idx) => {
        const game = gameMap.get(name);
        return game ? {...game, order: idx + 1} : null;
      }).filter(g => g);
      
      // Create modal HTML
      const modal = document.createElement('div');
      modal.className = 'modal open';
      modal.id = 'sagaModal';
      modal.innerHTML = `
        <div class="adminBox" style="max-width:1200px;width:95vw;padding:24px;display:flex;flex-direction:column;">
            <div style="margin-bottom:20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                  <h2 style="margin:0;font-size:24px;">${escapeHtml(saga.name)}</h2>
                </div>
                <button class="closeBtn" onclick="this.closest('.modal').remove()">√ó</button>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:16px;max-height:60vh;overflow-y:auto;">
              ${sagaGames.map(g => `
                <div data-href="game.html?name=${encodeURIComponent(g.name)}" style="cursor:pointer;width:100%;height:200px;border-radius:16px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.03);">
                  <div style="position:absolute;inset:0;"><img src="${g.cover}" loading="lazy" style="width:100%;height:100%;object-fit:cover;display:block;" /></div>
                  <div style="position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(0,0,0,.9) 100%);display:flex;flex-direction:column;justify-content:flex-end;padding:12px;gap:6px;">
                    <span style="position:absolute;top:8px;left:8px;background:rgba(100,140,255,.9);color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:999px;z-index:10;">#${g.order}</span>
                    <h3 style="font-size:13px;font-weight:600;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.5);line-height:1.3;margin:0;">${escapeHtml(g.name)}</h3>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
      `;
      
      modal.addEventListener('click', (e) => {
        if(e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }
    
    // Global function for opening saga modal by name - moved outside renderHomeView
    window.openSagaModalByName = function(sagaName){
      try {
        const decodedName = decodeURIComponent(sagaName);
        const saga = state.data.sagas.find(s => s.name === decodedName);
        if(saga) {
          openSagaModal(saga);
        } else {
          console.error('Saga not found:', decodedName);
          const normalizedSaga = state.data.sagas.find(s => 
            s.name.toLowerCase().replace(/[^a-z0-9]/g, '') === decodedName.toLowerCase().replace(/[^a-z0-9]/g, '')
          );
          if(normalizedSaga) openSagaModal(normalizedSaga);
        }
      } catch(e) {
        console.error('Error opening saga modal:', e);
      }
    };
    
    function renderHomeView(){
      console.log('[renderHomeView] Rendering home with sagas');
      dom.gameGrid.innerHTML = '';
      dom.noGames.style.display = 'none';
      
      // Get top sagas (first 10)
      const topSagas = (state.data.sagas || []).slice(0, 10);
      
      if(topSagas.length === 0 && state.data.games.length === 0){
        dom.noGames.style.display = 'block';
        dom.noGames.textContent = 'Aucun jeu ou saga disponible';
        return;
      }
      
      // Create home view container
      const homeContainer = document.createElement('div');
      homeContainer.style.cssText = 'grid-column:1/-1;';
      
      // Sagas section
      if(topSagas.length > 0){
        const sagasSection = document.createElement('div');
        
        // Build saga cards HTML using same style as createSagaCard
        let sagasHTML = topSagas.map(saga => {
          const gameMap = new Map(state.data.games.map(g => [g.name, g]));
          const covers = saga.games.slice(0,3).map(name => gameMap.get(name)?.cover).filter(c => c);
          
          let coversHTML = '<div class="saga-cover-stack">';
          covers.forEach(cover => {
            coversHTML += `<img src="${cover}" loading="lazy" alt="" onerror="this.style.display='none'">`;
          });
          coversHTML += '</div>';
          
          return `
            <div class="saga-card-glass" onclick='openSagaModalByName("${encodeURIComponent(saga.name).replace(/'/g, "%27")}")' style="cursor:pointer;">
              <div class="saga-badge-glass">SAGA</div>
              ${coversHTML}
              <div class="saga-info-glass">
                <div class="saga-title-glass">${escapeHtml(saga.name)}</div>
                <div class="saga-meta-glass">${saga.games.length} jeux</div>
              </div>
            </div>
          `;
        }).join('');
        
        sagasSection.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding:0 8px;">
            <h2 style="font-size:20px;font-weight:500;margin:0;">‚ú® Meilleures Sagas</h2>
            <button onclick="showAllSagas();" style="background:rgba(255,215,0,.2);border:1px solid rgba(255,215,0,.3);color:#FFD700;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:12px;">Voir toutes</button>
          </div>
          <div class="sagas-home-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--gap);margin-bottom:40px;">
            ${sagasHTML}
          </div>
        `;
        homeContainer.appendChild(sagasSection);
      }
      
      // Recent games section
      const recentGames = state.data.games.slice(0, 12);
      if(recentGames.length > 0){
        const gamesSection = document.createElement('div');
        gamesSection.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding:0 8px;">
            <h2 style="font-size:20px;font-weight:500;margin:0;">üî• Jeux R√©cents</h2>
            <button onclick="state.activeCat='ALL';renderCategories();renderGames();" style="background:rgba(100,140,255,.2);border:1px solid rgba(100,140,255,.3);color:#fff;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:12px;">Voir tous</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:16px;">
            ${recentGames.map(g => `
              <div class="card" onclick="window.location.href='game.html?name=${encodeURIComponent(g.name)}'" style="cursor:pointer;">
                <div class="card-bg"><img src="${g.cover}" loading="lazy" /></div>
                <div class="card-overlay"><h3 class="card-title">${escapeHtml(g.name)}</h3></div>
              </div>
            `).join('')}
          </div>
        `;
        homeContainer.appendChild(gamesSection);
      }
      
      dom.gameGrid.appendChild(homeContainer);
      
      // Show all sagas view
      window.showAllSagas = function(){
        dom.gameGrid.innerHTML = '';
        dom.noGames.style.display = 'none';
        
        const allSagas = state.data.sagas || [];
        if(allSagas.length === 0){
          dom.noGames.style.display = 'block';
          dom.noGames.textContent = 'Aucune saga disponible';
          return;
        }
        
        const container = document.createElement('div');
        container.style.cssText = 'grid-column:1/-1;';
        
        const sagasHTML = allSagas.map(saga => {
          const gameMap = new Map(state.data.games.map(g => [g.name, g]));
          const covers = saga.games.slice(0,3).map(name => gameMap.get(name)?.cover).filter(c => c);
          
          let coversHTML = '<div class="saga-cover-stack">';
          covers.forEach(cover => {
            coversHTML += `<img src="${cover}" loading="lazy" alt="" onerror="this.style.display='none'">`;
          });
          coversHTML += '</div>';
          
          return `
            <div class="saga-card-glass" onclick='openSagaModalByName("${encodeURIComponent(saga.name).replace(/'/g, "%27")}")' style="cursor:pointer;">
              <div class="saga-badge-glass">SAGA</div>
              ${coversHTML}
              <div class="saga-info-glass">
                <div class="saga-title-glass">${escapeHtml(saga.name)}</div>
                <div class="saga-meta-glass">${saga.games.length} jeux</div>
              </div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding:0 8px;">
            <h2 style="font-size:20px;font-weight:500;margin:0;">üìö Toutes les Sagas</h2>
            <button onclick="state.activeCat='HOME';renderCategories();renderGames();" style="background:rgba(100,140,255,.2);border:1px solid rgba(100,140,255,.3);color:#fff;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:12px;">‚Üê Retour</button>
          </div>
          <div class="sagas-home-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--gap);">
            ${sagasHTML}
          </div>
        `;
        
        dom.gameGrid.appendChild(container);
      };
    }
    
    function createCard(game, idx){
      const card = document.createElement('div');
      card.className = 'card';
      card.style.animationDelay = `${Math.min(idx * 0.03, 0.5)}s`;
      card.dataset.name = game.name;
      
      const hasDirect = game.directLink && game.directLink.trim();
      const link = hasDirect ? game.directLink : game.magnet;
      
      card.innerHTML = `
        <div class="card-bg">
          <img data-src="${game.cover || ''}" alt="${game.name}" loading="lazy" />
        </div>
        <div class="card-overlay">
          <h3 class="card-title">${escapeHtml(game.name)}</h3>
        </div>
      `;
      
      card.addEventListener('click', () => {
        // Save current state before navigating
        sessionStorage.setItem('lastState', JSON.stringify({
          activeCat: state.activeCat,
          currentPage: state.currentPage,
          scrollY: window.scrollY || dom.gameSection.scrollTop,
          query: state.query,
          timestamp: Date.now()
        }));
        window.location.href = `game.html?name=${encodeURIComponent(game.name)}`;
      });
      
      return card;
    }
    
    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    let imgObserver = null;
    function setupLazyImages(){
      if(!('IntersectionObserver' in window)){
        document.querySelectorAll('.card-bg img[data-src]').forEach(img => {
          img.src = img.dataset.src;
          img.removeAttribute('data-src');
        });
        return;
      }
      
      if(!imgObserver){
        imgObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if(entry.isIntersecting){
              const img = entry.target;
              if(img.dataset.src){
                img.src = img.dataset.src;
                img.onload = () => img.removeAttribute('data-src');
                img.onerror = () => {
                  img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='533'%3E%3Crect fill='%23222' width='400' height='533'/%3E%3C/svg%3E";
                };
              }
              imgObserver.unobserve(img);
            }
          });
        }, { rootMargin: '50px' });
      }
      
      document.querySelectorAll('.card-bg img[data-src]').forEach(img => imgObserver.observe(img));
    }
    
    function renderPagination(total){
      const pages = Math.ceil(total / CONFIG.ITEMS_PER_PAGE);
      if(pages <= 1) return;
      
      const container = document.createElement('div');
      container.className = 'pagination-container';
      
      let html = '';
      if(state.currentPage > 1) html += `<button class="pagination-btn" onclick="changePage(${state.currentPage - 1})">‚Üê</button>`;
      
      const max = 5;
      let start = Math.max(1, state.currentPage - Math.floor(max / 2));
      let end = Math.min(pages, start + max - 1);
      if(end - start < max - 1) start = Math.max(1, end - max + 1);
      
      if(start > 1) html += `<button class="pagination-btn" onclick="changePage(1)">1</button>${start > 2 ? '<span class="pagination-btn" style="background:transparent">...</span>' : ''}`;
      for(let i = start; i <= end; i++) html += `<button class="pagination-btn ${i === state.currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
      if(end < pages) html += `${end < pages - 1 ? '<span class="pagination-btn" style="background:transparent">...</span>' : ''}<button class="pagination-btn" onclick="changePage(${pages})">${pages}</button>`;
      
      if(state.currentPage < pages) html += `<button class="pagination-btn" onclick="changePage(${state.currentPage + 1})">‚Üí</button>`;
      
      container.innerHTML = html;
      dom.gameGrid.appendChild(container);
    }
    
    window.changePage = function(page){
      state.currentPage = page;
      renderGames();
      dom.gameSection.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // ==================== RECHERCHE IMMERSIVE =====
    let searchTimeout = null;
    
    function setupSearchImmersive(){
      const searchOverlay = document.getElementById('searchOverlay');
      const immersiveSearchInput = document.getElementById('immersiveSearchInput');
      const closeSearchOverlay = document.getElementById('closeSearchOverlay');
      const searchResults = document.getElementById('searchResults');
      
      if(!searchOverlay || !immersiveSearchInput){
        console.error('[setupSearchImmersive] Elements not found');
        return;
      }
      
      // Ouvrir au clic sur la barre de recherche
      if(dom.searchInput){
        dom.searchInput.addEventListener('focus', (e) => {
          // Ne pas ouvrir si on est en train de cliquer sur une cat√©gorie
          if(document.activeElement?.closest('#catAside')) return;
          searchOverlay.classList.add('active');
          immersiveSearchInput.value = dom.searchInput.value;
          immersiveSearchInput.focus();
        });
      }
      
      immersiveSearchInput.addEventListener('input', (e) => {
        if(dom.searchInput) dom.searchInput.value = e.target.value;
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          state.query = e.target.value;
          state.currentPage = 1;
          renderGames();
          renderSearchResults(e.target.value);
        }, CONFIG.SEARCH_DEBOUNCE);
      });
      
      function closeSearch(){
        searchOverlay.classList.remove('active');
        searchResults.innerHTML = '';
      }
      
      if(closeSearchOverlay){
        closeSearchOverlay.addEventListener('click', closeSearch);
      }
      searchOverlay.addEventListener('click', (e) => {
        if(e.target === searchOverlay) closeSearch();
      });
      
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && searchOverlay.classList.contains('active')){
          closeSearch();
        }
        if((e.ctrlKey || e.metaKey) && e.key === 'k'){
          e.preventDefault();
          searchOverlay.classList.add('active');
          immersiveSearchInput.focus();
        }
      });
    }
    
    function renderSearchResults(query){
      const searchResults = document.getElementById('searchResults');
      if(!searchResults) return;
      if(!query.trim()){
        searchResults.innerHTML = '';
        return;
      }
      
      // Build a map of game -> saga
      const gameToSaga = new Map();
      (state.data.sagas || []).forEach(saga => {
        (saga.games || []).forEach(gameName => {
          if (!gameToSaga.has(gameName)) {
            gameToSaga.set(gameName, saga);
          }
        });
      });
      
      // Find matching games and calculate scores
      const matchingGames = state.data.games.filter(g => fuzzyScore(query, g.name) > 50);
      
      // Get unique sagas from matching games (and track highest score per saga)
      const sagaScores = new Map();
      const standaloneGames = [];
      
      matchingGames.forEach(g => {
        const score = fuzzyScore(query, g.name);
        const saga = gameToSaga.get(g.name);
        if (saga) {
          // Keep the highest score for this saga
          if (!sagaScores.has(saga.name) || sagaScores.get(saga.name).score < score) {
            sagaScores.set(saga.name, { saga, score });
          }
        } else {
          standaloneGames.push({ item: g, score, type: 'game' });
        }
      });
      
      // Convert saga scores to array
      const sagaResults = Array.from(sagaScores.values()).map(({ saga, score }) => ({
        item: saga,
        score,
        type: 'saga'
      }));
      
      // Combine and sort by score (highest first)
      const allResults = [...sagaResults, ...standaloneGames]
        .sort((a, b) => b.score - a.score)
        .slice(0, 8);
      
      // Build HTML
      searchResults.innerHTML = allResults.map(({ item, type }) => {
        if (type === 'saga') {
          // It's a saga
          const saga = item;
          const gameMap = new Map(state.data.games.map(g => [g.name, g]));
          const covers = saga.games.slice(0,3).map(name => gameMap.get(name)?.cover).filter(c => c);
          
          let coversHTML = '<div class="saga-cover-stack">';
          covers.forEach((cover, i) => {
            coversHTML += `<img src="${cover}" loading="lazy" alt="" onerror="this.style.display='none'">`;
          });
          coversHTML += '</div>';
          
          return `
            <div class="search-result-item" data-saga="${encodeURIComponent(saga.name)}" style="cursor:pointer;">
              <div class="search-result-cover" style="position:relative;overflow:visible;">
                <div style="position:absolute;inset:0;width:100%;height:100%;border-radius:6px;overflow:hidden;border:2px solid #FFD700;">
                  ${coversHTML}
                </div>
              </div>
              <div>
                <div class="search-result-name">${escapeHtml(saga.name)}</div>
                <div class="search-result-cat" style="color:#FFD700;">Saga ¬∑ ${saga.games.length} jeux</div>
              </div>
            </div>
          `;
        } else {
          // It's a standalone game
          const g = item;
          return `
            <div class="search-result-item" data-href="game.html?name=${encodeURIComponent(g.name)}" style="cursor:pointer;">
              <div class="search-result-cover">
                <img src="${g.cover || ''}" alt="" />
              </div>
              <div>
                <div class="search-result-name">${escapeHtml(g.name)}</div>
                <div class="search-result-cat">${(g.categories || []).join(', ')}</div>
              </div>
            </div>
          `;
        }
      }).join('');
    }
    
    // ==================== RECHERCHE (legacy) ====================
    function setupSearch(){
      setupSearchImmersive();
    }
    
    // ==================== ADMIN ====================
    function setupAdmin(){
      dom.adminEntry.addEventListener('click', () => {
        const pwd = prompt('Mot de passe:');
        if(pwd === ADMIN_PASSWORD){
          state.adminUnlocked = true;
          dom.adminModal.classList.add('open');
          renderAdminCats();
          renderAdminGames();
        }else{ toast('Incorrect'); }
      });
      
      dom.closeAdmin.addEventListener('click', () => dom.adminModal.classList.remove('open'));
      dom.adminModal.addEventListener('click', (e) => { if(e.target === dom.adminModal) dom.adminModal.classList.remove('open'); });
      
      document.querySelectorAll('.adminNavBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.adminNavBtn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.adminSection').forEach(s => s.classList.remove('active'));
          btn.classList.add('active');
          $(`section${btn.dataset.section.charAt(0).toUpperCase() + btn.dataset.section.slice(1)}`).classList.add('active');
        });
      });
      
      dom.addGameBtn.addEventListener('click', addGame);
      dom.saveEditBtn.addEventListener('click', saveEdit);
      dom.cancelEditBtn.addEventListener('click', cancelEdit);
      dom.adminGameSearch?.addEventListener('input', (e) => renderAdminGames(e.target.value));
      dom.addCatBtn?.addEventListener('click', addCategory);
      dom.exportBtn?.addEventListener('click', exportData);
      dom.importBtn?.addEventListener('click', () => dom.importFile?.click());
      dom.importFile?.addEventListener('change', importData);
      dom.resetBtn?.addEventListener('click', resetData);
    }
    
    function renderAdminCats(){
      const badges = state.data.categories.map(cat => {
        const sel = state.selectedCategories.includes(cat) ? 'selected' : '';
        return `<span class="catBadge ${sel}" data-cat="${cat}">${cat}</span>`;
      }).join('');
      
      dom.categoryBadges.innerHTML = badges;
      dom.categoryBadges.querySelectorAll('.catBadge').forEach(badge => {
        badge.addEventListener('click', () => {
          const cat = badge.dataset.cat;
          state.selectedCategories = state.selectedCategories.includes(cat) 
            ? state.selectedCategories.filter(c => c !== cat)
            : [...state.selectedCategories, cat];
          renderAdminCats();
          updateSelectedCats();
        });
      });
    }
    
    function updateSelectedCats(){
      if(state.selectedCategories.length === 0){
        dom.selectedCategories.innerHTML = '<span style="color:rgba(255,255,255,.4);font-size:12px">Aucune</span>';
      }else{
        dom.selectedCategories.innerHTML = state.selectedCategories.map(cat => 
          `<span class="selectedCat">${cat} <span class="remove" data-c="${cat}">√ó</span></span>`
        ).join('');
        dom.selectedCategories.querySelectorAll('.remove').forEach(btn => {
          btn.addEventListener('click', () => {
            state.selectedCategories = state.selectedCategories.filter(c => c !== btn.dataset.c);
            updateSelectedCats();
            renderAdminCats();
          });
        });
      }
    }
    
    function renderAdminGames(search = ''){
      let games = state.data.games;
      if(search) games = games.filter(g => g.name.toLowerCase().includes(search.toLowerCase()));
      
      dom.gameListAdmin.innerHTML = games.slice(0, 100).map(g => `
        <div class="gameRow">
          <img class="thumb" src="${g.cover || ''}" alt="" />
          <span class="name" onclick="window.location.href='game.html?name=${encodeURIComponent(g.name)}'" style="cursor:pointer;color:rgba(100,140,255,.9);">${escapeHtml(g.name)}</span>
          <span class="cat">${(g.categories || []).join(', ') || '-'}</span>
          <button class="iconBtn primary" onclick="editGame('${g.name}')">Modif</button>
          <button class="iconBtn danger" onclick="deleteGame('${g.name}')">Suppr</button>
        </div>
      `).join('');
    }
    
    window.editGame = function(name){
      const idx = state.data.games.findIndex(g => g.name === name);
      if(idx === -1) return;
      state.editIndex = idx;
      const g = state.data.games[idx];
      dom.gameName.value = g.name;
      dom.gameMagnet.value = g.magnet || '';
      dom.gameDirectLink.value = g.directLink || '';
      dom.gameCover.value = g.cover || '';
      state.selectedCategories = [...(g.categories || [])];
      dom.addGameBtn.style.display = 'none';
      dom.saveEditBtn.style.display = '';
      dom.cancelEditBtn.style.display = '';
      renderAdminCats();
      updateSelectedCats();
      document.querySelector('[data-section="add"]').click();
      toast('Mode modification');
    };
    
    window.deleteGame = function(name){
      const idx = state.data.games.findIndex(g => g.name === name);
      if(idx === -1 || !confirm(`Supprimer "${name}" ?`)) return;
      state.data.games.splice(idx, 1);
      saveLocal();
      buildIndexes();
      renderGames();
      renderAdminGames();
      toast('Supprim√©');
    };
    
    function addGame(){
      const name = norm(dom.gameName.value);
      const magnet = norm(dom.gameMagnet.value);
      const direct = norm(dom.gameDirectLink.value);
      const cover = norm(dom.gameCover.value);
      
      if(!name || (!magnet && !direct) || !cover || state.selectedCategories.length === 0){
        toast('Tous les champs requis');
        return;
      }
      
      state.data.games.unshift({ name, magnet, directLink: direct, cover, categories: [...state.selectedCategories] });
      saveLocal();
      buildIndexes();
      clearForm();
      renderGames();
      renderAdminGames();
      toast('Ajout√©');
    }
    
    function saveEdit(){
      if(state.editIndex === null) return;
      const name = norm(dom.gameName.value);
      const magnet = norm(dom.gameMagnet.value);
      const direct = norm(dom.gameDirectLink.value);
      const cover = norm(dom.gameCover.value);
      
      if(!name || (!magnet && !direct) || !cover){
        toast('Champs requis manquants');
        return;
      }
      
      state.data.games[state.editIndex] = { name, magnet, directLink: direct, cover, categories: [...state.selectedCategories] };
      saveLocal();
      buildIndexes();
      clearForm();
      renderGames();
      renderAdminGames();
      cancelEdit();
      toast('Sauvegard√©');
    }
    
    function cancelEdit(){
      state.editIndex = null;
      clearForm();
      dom.addGameBtn.style.display = '';
      dom.saveEditBtn.style.display = 'none';
      dom.cancelEditBtn.style.display = 'none';
    }
    
    function clearForm(){
      dom.gameName.value = '';
      dom.gameMagnet.value = '';
      dom.gameDirectLink.value = '';
      dom.gameCover.value = '';
      // Mettre ACTION par d√©faut si disponible
      state.selectedCategories = state.data.categories.includes('ACTION') ? ['ACTION'] : [];
      renderAdminCats();
      updateSelectedCats();
    }
    
    function addCategory(){
      const name = upper(dom.newCatName.value);
      if(!name || state.data.categories.includes(name)){
        toast(name ? 'Existe d√©j√†' : 'Nom requis');
        return;
      }
      state.data.categories.push(name);
      state.data.categories.sort();
      saveLocal();
      dom.newCatName.value = '';
      renderCategories();
      renderAdminCats();
      toast('Cat√©gorie ajout√©e');
    }
    
    function exportData(){
      const blob = new Blob([JSON.stringify(state.data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'crackuzu_data.json';
      a.click();
      toast('Export√©');
    }
    
    async function importData(e){
      const file = e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        state.data = { categories: data.categories || [], games: data.games || [], sagas: data.sagas || [] };
        buildIndexes();
        saveLocal();
        renderCategories();
        renderGames();
        renderAdminGames();
        toast('Import√©');
      }catch{ toast('Erreur import'); }
      e.target.value = '';
    }
    
    function resetData(){
      if(!confirm('Supprimer toutes les donn√©es ?')) return;
      localStorage.removeItem(LOCAL_KEY);
      state.data = { categories: [], games: [], sagas: [] };
      buildIndexes();
      renderCategories();
      renderGames();
      toast('Reset OK');
    }
    
    // ==================== UI ====================
    function toast(msg){
      dom.toast.textContent = msg;
      dom.toast.classList.add('show');
      setTimeout(() => dom.toast.classList.remove('show'), 2500);
    }
    
    function setStateMessage(msg){
      if(!msg){ dom.stateMsg.classList.remove('show'); return; }
      dom.stateMsg.textContent = msg;
      dom.stateMsg.classList.add('show');
    }
    
    function setupMobile(){
      dom.mobileCatToggle.addEventListener('click', () => dom.catAside.classList.toggle('expanded'));
      dom.gameSection.addEventListener('click', () => { if(window.innerWidth <= 1024) dom.catAside.classList.remove('expanded'); });
    }
    
    function setupParallax(){
      if(state.isLowPower) return;
      let raf = null, mx = 0, my = 0, cx = 0, cy = 0;
      document.addEventListener('mousemove', (e) => {
        mx = (e.clientX / window.innerWidth - 0.5) * -20;
        my = (e.clientY / window.innerHeight - 0.5) * -15;
        if(!raf) raf = requestAnimationFrame(update);
      }, { passive: true });
      function update(){
        cx += (mx - cx) * 0.05;
        cy += (my - cy) * 0.05;
        if(dom.parallaxBg) dom.parallaxBg.style.transform = `translate(${cx}px, ${cy}px) scale(1.05)`;
        if(Math.abs(mx - cx) > 0.1 || Math.abs(my - cy) > 0.1) raf = requestAnimationFrame(update);
        else raf = null;
      }
    }
    
    // ==================== INIT ====================
    async function init(){
      detectLowPower();
      cacheDOM();
      await loadData();
      
      // Restore previous state if returning from game.html
      const urlParams = new URLSearchParams(window.location.search);
      const savedState = sessionStorage.getItem('lastState');

      if(urlParams.has('cat') || urlParams.has('q') || urlParams.has('saga')) {
        // Retour depuis game.html via goBack
        state.activeCat = urlParams.get('cat') || 'HOME';
        state.currentPage = parseInt(urlParams.get('page')) || 1;
        state.query = urlParams.get('q') || '';
        state.restoreScrollY = parseInt(urlParams.get('scroll')) || 0;
        state.restoreSaga = urlParams.get('saga') || null;
        state.restoreSearch = urlParams.has('search');
        sessionStorage.removeItem('lastState');
        // Nettoyer l'URL sans recharger
        history.replaceState(null, '', 'index.html');
      } else if(savedState){
        try{
          const stateData = JSON.parse(savedState);
          if(Date.now() - stateData.timestamp < 300000){
            state.activeCat = stateData.activeCat || 'HOME';
            state.currentPage = stateData.currentPage || 1;
            state.query = stateData.query || '';
            sessionStorage.removeItem('lastState');
            state.restoreScrollY = stateData.scrollY;
            state.restoreSearch = stateData.searchOpen || false;
          }
        }catch(e){ console.error('Error restoring state:', e); }
      }
      
      renderCategories();
      if(state.query) dom.searchInput.value = state.query;
      renderGames();
      
      // Restore scroll position after render
      if(state.restoreScrollY){
        setTimeout(() => {
          dom.gameSection.scrollTop = state.restoreScrollY;
          window.scrollTo(0, state.restoreScrollY);
          state.restoreScrollY = null;
        }, 100);
      }

      // Restore search overlay if coming back from search
      if(state.restoreSearch){
        setTimeout(() => {
          const searchOverlay = document.getElementById('searchOverlay');
          const immersiveInput = document.getElementById('immersiveSearchInput');
          if(searchOverlay){
            searchOverlay.classList.add('active');
            if(immersiveInput && state.query){
              immersiveInput.value = state.query;
              immersiveInput.focus();
              renderSearchResults(state.query);
            }
          }
          state.restoreSearch = false;
        }, 150);
      }

      // Restore saga modal if coming back from a saga game
      if(state.restoreSaga){
        setTimeout(() => {
          const saga = state.data.sagas && state.data.sagas.find(s => s.name === state.restoreSaga);
          if(saga) openSagaModal(saga);
          state.restoreSaga = null;
        }, 150);
      }
      
      setupSearch();
      setupAdmin();
      setupMobile();
      setupParallax();
      
      // Open search automatically on home page if not returning from game
      if(state.activeCat === 'HOME' && !urlParams.has('cat') && !savedState){
        setTimeout(() => {
          const searchOverlay = document.getElementById('searchOverlay');
          const immersiveInput = document.getElementById('immersiveSearchInput');
          if(searchOverlay && immersiveInput){
            searchOverlay.classList.add('active');
            immersiveInput.focus();
          }
        }, 800);
      }
      
      // Force render after delay
      setTimeout(() => {
        console.log('[init] Force render check, games:', state.data?.games?.length);
        if(state.data?.games?.length > 0){
          renderGames();
        }
      }, 500);
      
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          dom.adminModal.classList.remove('open');
          if(window.innerWidth <= 1024) dom.catAside.classList.remove('expanded');
        }
      });
    }
    
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

    // Global delegation ‚Äî g√®re tous les clics sur cards
    document.addEventListener('click', (e) => {
      // Cards normales (via dataset.name)
      const card = e.target.closest('.card');
      if(card && !e.target.closest('.card-download')) {
        const name = card.dataset.name;
        if(name) {
          sessionStorage.setItem('lastState', JSON.stringify({
            activeCat: state.activeCat,
            currentPage: state.currentPage,
            scrollY: window.scrollY,
            query: state.query,
            searchOpen: document.getElementById('searchOverlay')?.classList.contains('active'),
            timestamp: Date.now()
          }));
          window.location.href = 'game.html?name=' + encodeURIComponent(name);
          return;
        }
      }
      // Cards dans les modals saga (via data-href)
      const hrefEl = e.target.closest('[data-href]');
      if(hrefEl && !e.target.closest('.card-download')) {
        // Cherche si on est dans un modal saga
        const sagaModal = hrefEl.closest('#sagaModal');
        const sagaName = sagaModal ? sagaModal.querySelector('h2')?.textContent : null;
        // Cherche si on est dans la recherche immersive
        const searchOverlay = hrefEl.closest('#searchOverlay');
        const isSearch = !!searchOverlay;
        sessionStorage.setItem('lastState', JSON.stringify({
          activeCat: state.activeCat,
          currentPage: state.currentPage,
          scrollY: window.scrollY,
          query: state.query,
          sagaName: sagaName || null,
          searchOpen: isSearch || document.getElementById('searchOverlay')?.classList.contains('active'),
          timestamp: Date.now()
        }));
        window.location.href = hrefEl.dataset.href;
      }
      
      // Click sur saga dans les r√©sultats de recherche
      const sagaEl = e.target.closest('[data-saga]');
      if(sagaEl) {
        e.preventDefault();
        e.stopPropagation();
        sessionStorage.setItem('lastState', JSON.stringify({
          activeCat: state.activeCat,
          currentPage: state.currentPage,
          scrollY: window.scrollY,
          query: state.query,
          searchOpen: true,
          timestamp: Date.now()
        }));
        openSagaModalByName(sagaEl.dataset.saga);
        document.getElementById('searchOverlay').classList.remove('active');
        return;
      }
    });
  </script>
</body>
</html>
