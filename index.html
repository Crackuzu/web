<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRACKUZU</title>

  <style>
    :root{
      --bg0:#0b0e12;
      --bg1:#10151b;
      --glass: rgba(255,255,255,.065);
      --glass2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.11);
      --stroke2: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --outer: clamp(14px, 2.2vw, 26px);
      --gap:   clamp(12px, 1.2vw, 18px);
      --pad:   clamp(14px, 1.6vw, 20px);
      --r-xl:  clamp(18px, 2vw, 26px);
      --r-md:  clamp(14px, 1.5vw, 18px);
      --shadow: 0 28px 90px rgba(0,0,0,.58);
      --shadow2: 0 18px 46px rgba(0,0,0,.45);
      --side: clamp(250px, 20vw, 330px);
      --cardW: clamp(140px, 10.5vw, 185px);
    }

    /* ANIMATIONS */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(100, 140, 255, 0.3); }
      50% { box-shadow: 0 0 40px rgba(100, 140, 255, 0.3); }
    }

    @keyframes searchPulse {
      0%, 100% {
        box-shadow: 
          inset 0 1px 0 rgba(255, 255, 255, 0.2),
          0 16px 64px rgba(0, 0, 0, 0.5),
          0 0 0 2px rgba(100, 140, 255, 0.4),
          0 0 30px rgba(100, 140, 255, 0.25);
      }
      50% {
        box-shadow: 
          inset 0 1px 0 rgba(255, 255, 255, 0.2),
          0 16px 64px rgba(0, 0, 0, 0.5),
          0 0 0 2px rgba(100, 140, 255, 0.6),
          0 0 40px rgba(100, 140, 255, 0.35);
      }
    }

    @keyframes iconShimmer {
      0%, 100% {
        filter: drop-shadow(0 0 2px rgba(100, 140, 255, 0.5));
      }
      50% {
        filter: drop-shadow(0 0 6px rgba(100, 140, 255, 0.8));
      }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* FOND PARALLAX */
    .parallax-bg {
      position: fixed;
      inset: -100px;
      background: url('background.png') center center / cover no-repeat;
      z-index: -1;
      will-change: transform;
      transition: transform 0.1s ease-out;
      filter: blur(20px) brightness(0.7);
    }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: #0a0a12;
      overflow-x:hidden;
      position: relative;
    }

    .glass{
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }
    @supports ((-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px))){
      .glass{
        -webkit-backdrop-filter: blur(14px);
        backdrop-filter: blur(14px);
      }
    }

    .app{
      min-height: 100vh;
      min-height: 100dvh;
      padding: var(--outer);
      width: 100%;
      animation: fadeIn 0.6s ease-out 0.2s both;
    }

    .shell{
      width: min(1800px, calc(100dvw - (2 * var(--outer))));
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      min-height: calc(100dvh - (2 * var(--outer)));
    }

    header{
      position: sticky;
      top: var(--outer);
      z-index: 100;
      border-radius: var(--r-xl);
      padding: var(--pad);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px) saturate(200%);
      -webkit-backdrop-filter: blur(20px) saturate(200%);
      display: grid;
      grid-template-columns: 1fr;
      align-items: center;
      gap: var(--gap);
      min-height: clamp(86px, 10vh, 120px);
      animation: slideInRight 0.7s ease-out 0.3s both;
      transition: all 0.3s ease;
    }

    header.scrolled{
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(100, 140, 255, 0.3);
      box-shadow: 
        0 16px 64px rgba(0, 0, 0, 0.4),
        0 0 40px rgba(100, 140, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .brand{
      position: relative;
      text-align: center;
      grid-column: 1 / -1;
      justify-self: center;
      width: fit-content;
      margin: 0 auto;
      user-select:none;
      line-height:1.05;
    }
    .brand .big{
      font-weight: 300;
      letter-spacing: clamp(1px, .25vw, 2.5px);
      font-size: clamp(28px, 3.2vw, 46px);
      opacity:.92;
      background: linear-gradient(135deg, #fff 0%, #a0a0ff 50%, #fff 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmer 3s infinite linear;
      text-shadow: 0 0 30px rgba(160, 160, 255, 0.3);
    }
    .brand .small{
      margin-top: 4px;
      font-size: clamp(12px, 1.1vw, 14px);
      letter-spacing: clamp(2px, .35vw, 3.5px);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor: pointer;
    }
    .brand .small:hover{ color: rgba(255,255,255,.78); }

    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.70);
      letter-spacing: 1px;
      animation: pulseGlow 2s infinite;
      transition: all 0.3s ease;
    }

    /* BARRE DE RECHERCHE AM√âLIOR√âE - CORRIG√âE */
    .search {
      position: absolute;
      right: var(--pad);
      top: 50%;
      transform: translateY(-50%);
      width: clamp(220px, 28vw, 400px);
      height: clamp(40px, 5vh, 48px);
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 18px;
      border: none;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      box-shadow: 
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.08);
      justify-self: end;
      outline: none !important;
      isolation: isolate;
      transform: translateY(-50%) translateZ(0);
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      overflow: hidden;
    }

    .search::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.1), 
        transparent);
      transition: left 0.6s ease;
      z-index: 1;
    }

    .search:hover::before {
      left: 100%;
    }

    .search:hover {
      box-shadow: 
        inset 0 1px 0 rgba(255, 255, 255, 0.15),
        0 12px 48px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(100, 140, 255, 0.3),
        0 0 20px rgba(100, 140, 255, 0.15);
      transform: translateY(-50%) scale(1.02);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    }

    .search:focus-within {
      box-shadow: 
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        0 16px 64px rgba(0, 0, 0, 0.5),
        0 0 0 2px rgba(100, 140, 255, 0.4),
        0 0 30px rgba(100, 140, 255, 0.25);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
      animation: searchPulse 2s infinite;
    }

    .search svg {
      width: 20px;
      height: 20px;
      opacity: 0.7;
      transition: all 0.3s ease;
      flex-shrink: 0;
      stroke-width: 2.2;
    }

    .search:focus-within svg {
      opacity: 1;
      color: rgba(100, 140, 255, 1);
      transform: scale(1.1);
      animation: iconShimmer 1.5s ease-in-out infinite;
    }

    /* CORRECTION DU BUG : texte invisible */
    .search input {
      width: 100%;
      border: 0 !important;
      outline: 0 !important;
      box-shadow: none !important;
      background: transparent !important;
      color: var(--text) !important;
      font-size: clamp(14px, 1.15vw, 15px);
      font-weight: 400;
      letter-spacing: 0.3px;
      padding: 0;
      transition: color 0.3s ease;
    }

    .search input:focus {
      color: rgba(255, 255, 255, 0.98) !important;
    }

    .search input::placeholder {
      color: rgba(255, 255, 255, 0.5);
      font-weight: 400;
      transition: color 0.3s ease;
    }

    .search:focus-within input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .search input::-webkit-search-cancel-button {
      -webkit-appearance: none;
      height: 20px;
      width: 20px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000s/svg" viewBox="0 0 24 24" fill="rgba(255,255,255,0.5)"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>') no-repeat center;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .search input::-webkit-search-cancel-button:hover {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000s/svg" viewBox="0 0 24 24" fill="rgba(255,255,255,0.8)"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>') no-repeat center;
    }

    .main{
      flex: 1;
      min-height: 0;
      display:grid;
      grid-template-columns: var(--side) 1fr;
      gap: var(--gap);
      animation: fadeIn 0.8s ease-out 0.5s both;
    }

    aside{
      border-radius: var(--r-xl);
      padding: var(--pad);
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 
        0 24px 80px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      display:flex;
      flex-direction:column;
      min-height: 0;
      animation: slideInLeft 0.7s ease-out 0.6s both;
    }

    aside h2{
      margin: 6px 0 12px;
      text-align:center;
      font-weight: 300;
      letter-spacing: clamp(1px, .3vw, 2.2px);
      font-size: clamp(22px, 2.3vw, 28px);
      color: rgba(255,255,255,.86);
    }

    .catlist{
      display:flex;
      flex-direction:column;
      gap: clamp(10px, 1.2vw, 14px);
      margin-top: clamp(10px, 1.3vw, 18px);
    }

    .catbtn{
      height: clamp(46px, 5.8vh, 54px);
      border-radius: clamp(14px, 1.4vw, 16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      font-weight: 520;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, .70);
      cursor:pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      user-select:none;
      opacity: 0;
      animation: slideInLeft 0.5s ease-out forwards;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
    }
    .catbtn:hover{
      background: rgba(100, 140, 255, 0.15);
      border-color: rgba(100, 140, 255, 0.4);
      transform: translateY(-2px);
      color: rgba(255, 255, 255, .95);
      box-shadow: 0 8px 24px rgba(100, 140, 255, 0.2);
    }
    .catbtn.active{
      background: rgba(100, 140, 255, 0.25);
      border-color: rgba(100, 140, 255, 0.6);
      color: rgba(255, 255, 255, 1);
      box-shadow: 
        0 8px 32px rgba(100, 140, 255, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .sidefoot{
      margin-top:auto;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: rgba(255,255,255,.55);
      font-size: clamp(12px, 1.05vw, 13px);
      letter-spacing: .8px;
      animation: fadeIn 0.6s ease-out 1.5s both;
    }
    .sidefoot .boondocks{ color: rgba(255,255,255,.55); text-decoration: none; }
    .sidefoot .boondocks:hover{ color: rgba(255,255,255,.80); text-decoration: underline; }

    section{
      border-radius: var(--r-xl);
      padding: var(--pad);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 
        0 24px 80px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      min-height: 0;
      overflow:auto;
      animation: slideInRight 0.7s ease-out 0.6s both;
    }

    .grid{
      display:grid;
      gap: var(--gap);
      grid-template-columns: repeat(auto-fill, minmax(var(--cardW), 1fr));
      align-content: start;
    }

    .card{
      opacity: 0;
      animation: fadeIn 0.6s ease-out forwards;
    }

    .card{
      position: relative;
      border-radius: var(--r-md);
      overflow:hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      box-shadow: 
        0 16px 40px rgba(0,0,0,.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.06);
      aspect-ratio: 3 / 4;
      cursor: pointer;
      transform: translateZ(0);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      background:
        radial-gradient(600px 260px at 30% 10%, rgba(170,140,255,.28), transparent 60%),
        radial-gradient(500px 240px at 80% 90%, rgba(0,210,255,.20), transparent 55%);
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-18px;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.20),
          rgba(255,255,255,.12),
          transparent 60%);
      filter: blur(28px);
    }
    .card:hover{
      transform: translateY(-8px) scale(1.02);
      border-color: rgba(100, 140, 255, 0.4);
      box-shadow: 
        0 28px 60px rgba(0,0,0,.6),
        0 0 40px rgba(100, 140, 255, 0.2);
    }
    .card:hover::before{ 
      opacity:1; 
      background:
        radial-gradient(600px 260px at 30% 10%, rgba(100, 140, 255, 0.3), transparent 60%),
        radial-gradient(500px 240px at 80% 90%, rgba(100, 200, 255, 0.2), transparent 55%);
    }
    .card:hover::after{ opacity:1; }

    .card-bg{
      position:absolute;
      inset:0;
      overflow:hidden;
    }
    .card-bg img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      transition: transform .5s ease;
    }
    .card:hover .card-bg img{
      transform: scale(1.08);
    }

    .card-overlay{
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, 
        rgba(0,0,0,0) 0%,
        rgba(0,0,0,.3) 40%,
        rgba(0,0,0,.85) 100%);
      opacity:0;
      transition: opacity .3s ease;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding: clamp(12px, 1.5vw, 18px);
      gap: clamp(8px, 1vw, 12px);
    }
    .card:hover .card-overlay{
      opacity:1;
    }

    .card-title{
      font-size: clamp(13px, 1.15vw, 16px);
      font-weight: 600;
      letter-spacing: .6px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 8px rgba(0,0,0,.5);
      line-height: 1.3;
      margin: 0;
    }

    .card-download{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.25);
      color: rgba(255,255,255,.95);
      font-size: clamp(11px, 1vw, 13px);
      font-weight: 500;
      letter-spacing: .5px;
      text-decoration: none;
      transition: all .2s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      align-self: flex-start;
    }
    .card-download:hover{
      background: rgba(255,255,255,.28);
      border-color: rgba(255,255,255,.4);
      transform: translateY(-1px);
    }
    .card-download.direct{
      background: rgba(100,200,100,.2);
      border-color: rgba(100,200,100,.4);
      color: rgba(200,255,200,.95);
      margin-top: 8px;
    }
    .card-download.direct:hover{
      background: rgba(100,200,100,.35);
      border-color: rgba(100,200,100,.6);
    }
    .card-download svg{
      width: 14px;
      height: 14px;
    }

    /* ===== STYLES POUR LES CARTES SAGA ===== */
    .saga-card {
      position: relative;
      border-radius: var(--r-md);
      overflow: hidden;
      border: 2px solid rgba(255, 215, 0, 0.3);
      background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.1));
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      box-shadow: 
        0 16px 40px rgba(0,0,0,.3),
        inset 0 1px 0 rgba(255,255,255,.1),
        0 0 20px rgba(255,215,0,0.15);
      aspect-ratio: 3 / 4;
      cursor: pointer;
      transform: translateZ(0);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .saga-card:hover {
      transform: translateY(-8px) scale(1.02);
      border-color: rgba(255, 215, 0, 0.5);
      box-shadow: 
        0 28px 60px rgba(0,0,0,.6),
        0 0 40px rgba(255,215,0,0.3);
    }
    .saga-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: linear-gradient(135deg, rgba(255,215,0,0.9), rgba(255,140,0,0.9));
      color: #000;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 999px;
      letter-spacing: 1px;
      z-index: 10;
      box-shadow: 0 2px 10px rgba(255,215,0,0.3);
    }
    .saga-count {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .saga-cover-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      width: 100%;
      height: 100%;
      gap: 2px;
    }
    .saga-cover-grid img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .saga-cover-grid img:only-child,
    .saga-cover-grid img:first-child:nth-last-child(2),
    .saga-cover-grid img:first-child:nth-last-child(2) ~ img {
      grid-column: span 1;
      grid-row: span 2;
    }
    .saga-cover-grid img:first-child:nth-last-child(3) {
      grid-row: span 2;
    }
    .saga-title {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
      padding: 20px 15px 15px;
      font-size: clamp(13px, 1.15vw, 16px);
      font-weight: 600;
      letter-spacing: .6px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 8px rgba(0,0,0,.5);
      text-align: center;
    }

    /* ===== MODAL SAGA ===== */
    .saga-modal {
      position: fixed;
      inset: 0;
      z-index: 9998;
      background: rgba(10, 10, 18, 0.7);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10vh;
      overflow-y: auto;
    }
    .saga-modal.active {
      opacity: 1;
      pointer-events: all;
    }
    .saga-modal-box {
      width: min(900px, 95vw);
      max-height: 80vh;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: var(--r-xl);
      backdrop-filter: blur(40px) saturate(200%);
      -webkit-backdrop-filter: blur(40px) saturate(200%);
      box-shadow: 
        0 28px 90px rgba(0,0,0,.6),
        inset 0 1px 0 rgba(255,255,255,.1);
      transform: translateY(-30px) scale(0.95);
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .saga-modal.active .saga-modal-box {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
    .saga-modal-header {
      padding: clamp(20px, 3vw, 30px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      flex-shrink: 0;
    }
    .saga-modal-header h2 {
      margin: 0;
      font-size: clamp(24px, 3vw, 32px);
      font-weight: 300;
      letter-spacing: 1px;
      color: rgba(255,255,255,.95);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .saga-modal-header h2::before {
      content: '‚ú¶';
      color: #FFD700;
      font-size: 0.8em;
    }
    .saga-modal-close {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 24px;
      flex-shrink: 0;
    }
    .saga-modal-close:hover {
      background: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.95);
      transform: rotate(90deg);
    }
    .saga-modal-content {
      padding: clamp(20px, 3vw, 30px);
      overflow-y: auto;
      flex: 1;
    }
    .saga-games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 20px;
    }
    .saga-game-card {
      position: relative;
      border-radius: var(--r-md);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      aspect-ratio: 3 / 4;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .saga-game-card:hover {
      transform: translateY(-5px) scale(1.02);
      border-color: rgba(100, 140, 255, 0.4);
      box-shadow: 0 16px 40px rgba(0,0,0,.4);
    }
    .saga-game-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .saga-game-card .game-order {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(100, 140, 255, 0.9);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .saga-game-card .game-title {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.3), transparent);
      padding: 15px 10px 10px;
      font-size: 13px;
      font-weight: 500;
      color: rgba(255,255,255,.95);
      text-align: center;
    }

    .noGames{
      text-align:center;
      color: rgba(255,255,255,.55);
      padding: 40px 20px;
      font-style:italic;
      font-size: clamp(14px, 1.2vw, 16px);
    }

    /* MODAL BASE */
    .modal{
      position:fixed;
      display:flex;
      inset:0;
      z-index:9999;
      background: rgba(10, 10, 18, 0.85);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      backdrop-filter: blur(20px) saturate(180%);
      align-items:center;
      justify-content:center;
      padding: var(--outer);
      opacity:0;
      pointer-events:none;
      transition: opacity .4s ease;
    }
    .modal.open{
      opacity:1;
      pointer-events:all;
    }

    /* ADMIN PANEL - GLASS MORPHISM DESIGN */
    .adminBox{
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--r-xl);
      box-shadow: 
        0 28px 90px rgba(0,0,0,.6),
        0 0 0 1px rgba(255,255,255,0.1),
        inset 0 1px 0 rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.12);
      width: min(1400px, 95vw);
      max-height: 90vh;
      display: grid;
      grid-template-columns: 280px 1fr;
      overflow: hidden;
      position:relative;
      -webkit-backdrop-filter: blur(24px) saturate(200%);
      backdrop-filter: blur(24px) saturate(200%);
      animation: modalEnter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes modalEnter {
      from { opacity: 0; transform: scale(0.95) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .adminSidebar{
      background: rgba(0,0,0,.15);
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: clamp(20px, 2.5vw, 28px);
      overflow-y: auto;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    .adminSidebar h1{
      margin: 0 0 8px;
      font-size: clamp(22px, 2.2vw, 26px);
      font-weight: 400;
      letter-spacing: 1px;
      color: rgba(255,255,255,.95);
    }

    .adminSidebar .subtitle{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 24px;
      letter-spacing: .8px;
    }

    .adminNav{
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .adminNavBtn{
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.7);
      font-size: 14px;
      font-weight: 500;
      letter-spacing: .5px;
      cursor: pointer;
      transition: all .2s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .adminNavBtn:hover{
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
    }

    .adminNavBtn.active{
      background: rgba(100,140,255,.15);
      border-color: rgba(100,140,255,.3);
      color: rgba(255,255,255,.95);
    }

    .adminNavBtn .icon{
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    /* BOUTON UPLOAD DIRECT DANS LA SIDEBAR */
    .adminNavBtn.upload-btn {
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.15), rgba(39, 174, 96, 0.12));
      border-color: rgba(46, 204, 113, 0.25);
      color: rgba(255,255,255,.95);
    }
    .adminNavBtn.upload-btn:hover {
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.25), rgba(39, 174, 96, 0.2));
      border-color: rgba(46, 204, 113, 0.4);
      transform: translateY(-1px);
    }

    .adminContent{
      overflow-y: auto;
      padding: clamp(24px, 3vw, 36px);
      max-height: calc(90vh - 60px);
    }

    .adminSection{
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .adminSection.active{
      display: block;
      opacity: 1;
      transform: translateY(0);
      animation: sectionFadeIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes sectionFadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Stagger animation for form elements */
    .adminSection.active .formRow {
      animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
    }

    .adminSection.active .formRow:nth-child(1) { animation-delay: 0.05s; }
    .adminSection.active .formRow:nth-child(2) { animation-delay: 0.1s; }
    .adminSection.active .formRow:nth-child(3) { animation-delay: 0.15s; }
    .adminSection.active .formRow:nth-child(4) { animation-delay: 0.2s; }
    .adminSection.active .formRow:nth-child(5) { animation-delay: 0.25s; }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .adminSection h2{
      margin: 0 0 20px;
      font-size: clamp(20px, 2vw, 24px);
      font-weight: 400;
      letter-spacing: .8px;
      color: rgba(255,255,255,.92);
      padding-bottom: 12px;
      border-bottom: 1px solid var(--stroke);
    }

    .closeBtn{
      position:absolute;
      top: clamp(16px, 2vw, 24px);
      right: clamp(16px, 2vw, 24px);
      width: 36px;
      height: 36px;
      border-radius:50%;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.75);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all .2s ease;
      z-index: 10;
    }
    .closeBtn:hover{
      background: rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      transform: rotate(90deg);
    }

    label{
      display:block;
      margin-bottom:6px;
      font-size: clamp(12px, 1.05vw, 14px);
      letter-spacing:.5px;
      color: rgba(255,255,255,.75);
      font-weight:500;
    }

    input[type=text], input[type=password], input[type=url], textarea{
      width:100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size: clamp(13px, 1.1vw, 14px);
      outline:0;
      transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-family: inherit;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }
    input[type=text]:focus, input[type=password]:focus, input[type=url]:focus, textarea:focus{
      border-color: rgba(100,140,255,0.6);
      background: rgba(255,255,255,0.1);
      box-shadow: 
        0 0 0 3px rgba(100,140,255,0.15),
        0 4px 20px rgba(100,140,255,0.15);
      transform: translateY(-1px);
    }
    input[type=text]:hover, input[type=password]:hover, input[type=url]:hover, textarea:hover{
      border-color: rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.08);
    }
    textarea{
      resize:vertical;
      min-height:80px;
    }

    .formRow{
      display:flex;
      gap: clamp(12px, 1.5vw, 18px);
      margin-bottom: clamp(12px, 1.5vw, 16px);
      align-items: flex-end;
      width: 100%;
      box-sizing: border-box;
    }
    .formRow > div{
      flex:1;
      min-width: 0;
    }
    .formRow > div.shrink-0 {
      flex: 0 0 auto;
    }

    button, .btn{
      padding: 10px 18px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.88);
      font-size: clamp(13px, 1.1vw, 14px);
      font-weight:500;
      letter-spacing:.6px;
      cursor:pointer;
      transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-family:inherit;
      position: relative;
      overflow: hidden;
    }
    button:hover, .btn:hover{
      background: rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255,255,255,0.1);
    }
    button:active, .btn:active{
      transform: translateY(0);
      transition: all 0.1s ease;
    }
    button.primary{
      background: linear-gradient(135deg, rgba(100,140,255,.22), rgba(80,120,240,.18));
      border-color: rgba(100,140,255,.35);
    }
    button.primary:hover{
      background: linear-gradient(135deg, rgba(100,140,255,.3), rgba(80,120,240,.25));
      border-color: rgba(100,140,255,.5);
      box-shadow: 0 4px 20px rgba(100,140,255,0.25);
    }
    button.danger{
      background: linear-gradient(135deg, rgba(255,80,100,.18), rgba(240,60,80,.14));
      border-color: rgba(255,80,100,.3);
    }
    button.danger:hover{
      background: linear-gradient(135deg, rgba(255,80,100,.25), rgba(240,60,80,.2));
      border-color: rgba(255,80,100,.45);
      box-shadow: 0 4px 20px rgba(255,80,100,0.2);
    }

    .btnGroup{
      display:flex;
      gap: 10px;
      margin-top:12px;
      flex-wrap: wrap;
    }

    .stateMsg{
      padding:10px 16px;
      border-radius:8px;
      background: rgba(100,180,255,.15);
      border: 1px solid rgba(100,180,255,.3);
      color: rgba(150,200,255,.95);
      font-size: clamp(12px, 1.05vw, 13px);
      margin-bottom:14px;
      text-align:center;
    }

    /* LISTE DES JEUX ADMIN - AM√âLIOR√âE */
    .gameListContainer{
      max-height: 50vh;
      overflow-y: auto;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255,255,255,.03);
      margin-top: 12px;
    }

    .gameSearchBox{
      margin-bottom: 16px;
      position: relative;
    }

    .gameSearchBox input{
      width: 100%;
      padding: 12px 16px 12px 42px;
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      color: var(--text);
      font-size: 14px;
    }

    .gameSearchBox::before{
      content: "üîç";
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,.5);
      font-size: 16px;
    }

    .gameRow, .catRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      border-radius:8px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      margin-bottom:8px;
      transition: background .2s ease;
    }
    .gameRow:hover, .catRow:hover{
      background: rgba(255,255,255,.07);
    }
    .gameRow .left{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .gameRow .thumb{
      width:40px;
      height:40px;
      border-radius:6px;
      object-fit:cover;
      flex-shrink:0;
    }
    .gameRow .name, .catRow .name{
      font-size: clamp(13px, 1.1vw, 14px);
      font-weight:500;
      color: rgba(255,255,255,.88);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex: 1;
    }
    .gameRow .cat{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.7);
      letter-spacing:.5px;
    }
    .iconBtn{
      padding: 8px 14px;
      font-size:12px;
      flex-shrink:0;
    }

    .toast{
      position:fixed;
      bottom:30px;
      left:50%;
      transform:translateX(-50%) translateY(100px);
      padding:12px 24px;
      border-radius:12px;
      background: rgba(20,25,35,.95);
      border: 1px solid rgba(255,255,255,.2);
      color: rgba(255,255,255,.92);
      box-shadow: 0 12px 40px rgba(0,0,0,.6);
      z-index:10000;
      font-size:14px;
      font-weight:500;
      letter-spacing:.5px;
      pointer-events:none;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      opacity:0;
      transition: all .3s cubic-bezier(.18,.89,.32,1.28);
    }
    .toast.show{
      transform:translateX(-50%) translateY(0);
      opacity:1;
    }

    .previewBox{
      margin-top:16px;
      padding:16px;
      border-radius:10px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
    }
    .previewBox h3{
      margin:0 0 12px;
      font-size:15px;
      font-weight:500;
      color: rgba(255,255,255,.8);
    }
    .previewBox img{
      width:100%;
      max-width:200px;
      border-radius:8px;
      border: 1px solid rgba(255,255,255,.12);
    }

    .categoryBadges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    .catBadge{
      padding:6px 12px;
      border-radius:6px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.75);
      font-size:12px;
      letter-spacing:.5px;
      cursor:pointer;
      transition: all .2s ease;
      user-select:none;
    }
    .catBadge:hover{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.25);
    }
    .catBadge.selected{
      background: rgba(100,140,255,.2);
      border-color: rgba(100,140,255,.4);
      color: rgba(200,220,255,.95);
    }

    /* NOUVEAU STYLE POUR LES CAT√âGORIES LISTE */
    .categories-list-container {
      margin-top: 12px;
      padding: 16px;
      border-radius: 10px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
    }

    .categories-list-container h4 {
      margin: 0 0 12px;
      font-size: 14px;
      font-weight: 500;
      color: rgba(255,255,255,.8);
    }

    .categories-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 16px;
    }

    .category-item {
      padding: 6px 10px;
      border-radius: 6px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      color: rgba(255,255,255,.7);
      font-size: 11px;
      cursor: pointer;
      transition: all .2s ease;
    }

    .category-item:hover {
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.2);
    }

    .category-item.selected {
      background: rgba(100,140,255,.15);
      border-color: rgba(100,140,255,.3);
      color: rgba(200,220,255,.95);
    }

    .add-category-form {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .add-category-form input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.1);
      color: var(--text);
      font-size: 12px;
    }

    .torrent-drop-zone{
      margin-top:12px;
      padding:24px;
      border-radius:10px;
      border: 2px dashed rgba(255,255,255,.2);
      background: rgba(255,255,255,.03);
      text-align:center;
      transition: all .3s ease;
      cursor:pointer;
    }
    .torrent-drop-zone.dragover{
      border-color: rgba(100,180,255,.5);
      background: rgba(100,180,255,.1);
    }
    .torrent-drop-zone p{
      margin:0;
      color: rgba(255,255,255,.65);
      font-size:13px;
    }
    .torrent-drop-zone .icon{
      font-size:32px;
      margin-bottom:8px;
      opacity:.6;
    }

    /* MENU S√âLECTION IGDB */
    .game-selector-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      padding: var(--outer);
      opacity: 0;
      transition: opacity .3s ease;
    }

    .game-selector-modal.open {
      display: flex;
      opacity: 1;
    }

    .game-selector-box {
      background: var(--bg1);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      border: 1px solid var(--stroke2);
      width: min(700px, 95vw);
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .game-selector-header {
      padding: clamp(18px, 2.5vw, 24px);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .game-selector-header h2 {
      margin: 0;
      font-size: clamp(20px, 2.2vw, 26px);
      font-weight: 400;
      letter-spacing: .8px;
      color: rgba(255,255,255,.92);
    }

    .game-selector-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.75);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s ease;
      font-size: 20px;
    }

    .game-selector-close:hover {
      background: rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      transform: rotate(90deg);
    }

    .game-selector-content {
      flex: 1;
      overflow-y: auto;
      padding: clamp(14px, 2vw, 20px);
    }

    .game-selector-loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .game-selector-loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,.1);
      border-top-color: rgba(255,255,255,.6);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    .game-selector-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .game-selector-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      cursor: pointer;
      transition: all .2s ease;
    }

    .game-selector-item:hover {
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
      transform: translateX(4px);
    }

    .game-selector-cover {
      width: 60px;
      height: 80px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
    }

    .game-selector-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .game-selector-info {
      flex: 1;
      min-width: 0;
    }

    .game-selector-name {
      font-size: clamp(14px, 1.2vw, 16px);
      font-weight: 600;
      color: rgba(255,255,255,.92);
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .game-selector-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .game-selector-year {
      font-size: 12px;
      color: rgba(255,255,255,.6);
    }

    .game-selector-type {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.75);
      letter-spacing: .5px;
    }

    .game-selector-arrow {
      color: rgba(255,255,255,.4);
      font-size: 18px;
      transition: all .2s ease;
    }

    .game-selector-item:hover .game-selector-arrow {
      color: rgba(255,255,255,.8);
      transform: translateX(4px);
    }

    /* ===== RECHERCHE IMMERSIVE MASTERCLASS ===== */
    .search-overlay {
      position: fixed;
      inset: 0;
      z-index: 9998;
      background: rgba(10, 10, 18, 0.7);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 15vh;
    }

    .search-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Barre de recherche centrale - GLASS MORPHISM EXTREME */
    .search-immersive {
      width: min(700px, 90vw);
      position: relative;
      transform: translateY(-30px) scale(0.95);
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .search-overlay.active .search-immersive {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .search-immersive-box {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 24px;
      height: 64px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(24px) saturate(200%);
      -webkit-backdrop-filter: blur(24px) saturate(200%);
      transition: all 0.3s ease;
    }

    .search-immersive-box:focus-within {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(100, 140, 255, 0.5);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
      transform: scale(1.02);
    }

    .search-immersive svg {
      width: 24px;
      height: 24px;
      color: rgba(255, 255, 255, 0.6);
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .search-immersive-box:focus-within svg {
      color: rgba(100, 140, 255, 1);
      transform: scale(1.1);
      filter: drop-shadow(0 0 8px rgba(100, 140, 255, 0.8));
    }

    .search-immersive input,
    .search-immersive input:hover,
    .search-immersive input:active,
    .search-immersive input:valid,
    .search-immersive input:invalid {
      all: unset;
      flex: 1;
      background: #0a0a12 !important;
      background-color: #0a0a12 !important;
      color: rgba(255, 255, 255, 0.95) !important;
      font-size: 18px;
      font-weight: 400;
      letter-spacing: 0.3px;
      font-family: inherit;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      border-radius: 0 !important;
      padding: 0;
      margin: 0;
      -webkit-text-fill-color: rgba(255, 255, 255, 0.95);
      height: 100%;
      caret-color: rgba(255, 255, 255, 0.95);
      display: block;
    }

    .search-immersive-box input {
      background: transparent !important;
      background-color: transparent !important;
      box-shadow: none !important;
    }

    .search-immersive input:focus {
      background: transparent !important;
      background-color: transparent !important;
      background-image: none !important;
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
    }

    .search-immersive input:-webkit-autofill,
    .search-immersive input:-webkit-autofill:hover,
    .search-immersive input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0 1000px transparent inset !important;
      -webkit-text-fill-color: rgba(255, 255, 255, 0.95) !important;
      background-color: transparent !important;
      transition: background-color 5000s ease-in-out 0s;
    }

    /* Fix pour barre grise - forcer transparence compl√®te */
    .search-immersive input::selection {
      background: rgba(100, 140, 255, 0.3);
      color: rgba(255, 255, 255, 0.95);
    }

    .search-immersive input::-webkit-search-decoration,
    .search-immersive input::-webkit-search-cancel-button,
    .search-immersive input::-webkit-search-results-button,
    .search-immersive input::-webkit-search-results-decoration {
      display: none;
      -webkit-appearance: none;
    }

    .search-immersive input:-webkit-autofill,
    .search-immersive input:-webkit-autofill:hover,
    .search-immersive input:-webkit-autofill:focus {
      -webkit-text-fill-color: rgba(255, 255, 255, 0.95);
      -webkit-box-shadow: 0 0 0px 1000px transparent inset !important;
      transition: background-color 5000s ease-in-out 0s;
      background-color: transparent !important;
    }

    .search-immersive input::placeholder {
      color: rgba(255, 255, 255, 0.4);
      font-weight: 300;
    }

    .search-immersive-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 18px;
      flex-shrink: 0;
    }

    .search-immersive-close:hover {
      background: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.95);
      transform: rotate(90deg);
    }

    /* R√©sultats de recherche - LISTE VERTICALE GLASS MORPHISM MAX */
    .search-results {
      width: min(700px, 90vw);
      max-height: 55vh;
      margin-top: 20px;
      overflow-y: auto;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(60px) saturate(200%);
      -webkit-backdrop-filter: blur(60px) saturate(200%);
      box-shadow: 
        0 24px 80px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.1s;
    }

    .search-overlay.active .search-results {
      transform: translateY(0);
      opacity: 1;
    }

    .search-results::-webkit-scrollbar {
      width: 8px;
    }

    .search-results::-webkit-scrollbar-track {
      background: transparent;
    }

    .search-results::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
    }

    .search-results::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .search-result-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.25s ease;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      opacity: 0;
      animation: fadeIn 0.5s ease-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: linear-gradient(90deg, 
        rgba(100, 140, 255, 0.1) 0%, 
        rgba(100, 140, 255, 0.05) 50%,
        transparent 100%);
      transform: translateX(8px);
    }

    .search-result-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, 
        rgba(100, 140, 255, 0.8), 
        rgba(100, 140, 255, 0.4));
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .search-result-item:hover::before {
      opacity: 1;
    }

    .search-result-cover {
      width: 70px;
      height: 95px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .search-result-item:hover .search-result-cover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .search-result-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .search-result-info {
      flex: 1;
      min-width: 0;
    }

    .search-result-name {
      font-size: 17px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.95);
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      letter-spacing: 0.3px;
    }

    .search-result-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .search-result-year {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
    }

    .search-result-categories {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .search-result-cat {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.75);
      letter-spacing: 0.5px;
    }

    .search-result-match {
      font-size: 12px;
      color: rgba(100, 200, 255, 0.8);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .search-result-match::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(100, 200, 255, 0.8);
    }

    .search-empty {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.5);
    }

    .search-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .search-shortcuts {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      color: rgba(255, 255, 255, 0.4);
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .search-shortcuts span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .search-shortcuts kbd {
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      font-family: inherit;
      font-size: 11px;
    }

    .game-selector-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .game-selector-error {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255,150,150,.9);
      background: rgba(255,100,100,.1);
      border-radius: 12px;
      border: 1px solid rgba(255,100,100,.3);
    }

    .selectedGamePreview{
      display: none;
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      background: rgba(100,140,255,.1);
      border: 1px solid rgba(100,140,255,.3);
    }
    .selectedGamePreview.show{
      display: block;
    }
    .selectedGamePreview .inner{
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .selectedGamePreview img{
      width: 50px;
      height: 67px;
      border-radius: 6px;
      object-fit: cover;
    }
    .selectedGamePreview .info{
      flex: 1;
    }
    .selectedGamePreview .gameName{
      font-weight: 600;
      color: rgba(255,255,255,.92);
      margin-bottom: 4px;
    }
    .selectedGamePreview .gameMeta{
      font-size: 12px;
      color: rgba(255,255,255,.7);
    }
    .selectedGamePreview .categories{
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* BOUTON COLLER IMAGE */
    .paste-image-btn {
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.22), rgba(142, 68, 173, 0.18));
      border-color: rgba(155, 89, 182, 0.35);
    }
    .paste-image-btn:hover {
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.3), rgba(142, 68, 173, 0.25));
      border-color: rgba(155, 89, 182, 0.5);
    }
  </style>
</head>
<body>
  <!-- FOND PARALLAX -->
  <div class="parallax-bg" id="parallaxBg"></div>
  <div class="app">
    <div class="shell">

      <header class="glass">
        <div class="brand">
          <div class="big">CRACKUZU</div>
          <div class="small" id="adminEntry">
            BY CH…ÖRUZU
            <span class="pill" id="adminPill" style="display:none;">ADMIN</span>
          </div>
        </div>

        <div class="search" id="searchTrigger" style="cursor: pointer;">
          <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <span style="color: rgba(255,255,255,.5); font-size: clamp(14px, 1.15vw, 15px);">Rechercher un jeu...</span>
        </div>
      </header>

      <div class="main">
        <aside class="glass">
          <h2>Cat√©gories</h2>
          <div class="catlist" id="catList"></div>
          <div class="sidefoot">
            <a href="https://discord.gg/qvxkVubaGN" class="boondocks" target="_blank">ùïãùïôùïñ ùîπùï†ùï†ùïüùïïùï†ùïîùïúùï§</a>
            <span id="gameCountDisplay" class="boondocks">0 jeux</span>
          </div>
        </aside>

        <section class="glass">
          <div id="stateMsg" class="stateMsg" style="display:none;"></div>
          <div class="grid" id="gameGrid"></div>
          <div class="noGames" id="noGames" style="display:none;">Aucun jeu trouv√©.</div>
        </section>
      </div>

    </div>
  </div>

  <!-- RECHERCHE IMMERSIVE MASTERCLASS -->
  <div class="search-overlay" id="searchOverlay">
    <div class="search-immersive">
      <div class="search-immersive-box">
        <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" placeholder="Rechercher un jeu..." id="immersiveSearchInput" autocomplete="off" style="background: transparent !important; background-color: transparent !important; border: none !important; box-shadow: none !important;" />
        <button class="search-immersive-close" id="closeSearchOverlay">‚úï</button>
      </div>
    </div>
    
    <div class="search-results" id="searchResults">
      <!-- Les r√©sultats seront inject√©s ici -->
    </div>
    
    <div class="search-shortcuts">
      <span><kbd>‚Üë‚Üì</kbd> naviguer</span>
      <span><kbd>Entr√©e</kbd> ouvrir</span>
      <span><kbd>√âchap</kbd> fermer</span>
    </div>
  </div>

  <!-- MODAL SAGA -->
  <div class="saga-modal" id="sagaModal">
    <div class="saga-modal-box">
      <div class="saga-modal-header">
        <h2 id="sagaModalTitle">Saga</h2>
        <button class="saga-modal-close" id="closeSagaModal">‚úï</button>
      </div>
      <div class="saga-modal-content">
        <div class="saga-games-grid" id="sagaGamesGrid">
          <!-- Les jeux de la saga seront inject√©s ici -->
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL SIMPLIFI√â -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="adminBox">
      <button class="closeBtn" id="closeAdmin" aria-label="Fermer">‚úï</button>
      
      <div class="adminSidebar">
        <h1>üîß Admin</h1>
        <p class="subtitle">Gestion du site</p>
        
        <div class="adminNav">
          <button class="adminNavBtn active" data-section="add">
            <span class="icon">‚ûï</span>
            Ajouter un jeu
          </button>
          <button class="adminNavBtn" data-section="list">
            <span class="icon">üìã</span>
            Liste des jeux
          </button>
          <button class="adminNavBtn" data-section="categories">
            <span class="icon">üè∑Ô∏è</span>
            Cat√©gories
          </button>
          <button class="adminNavBtn" data-section="sagas">
            <span class="icon">‚ú¶</span>
            Sagas
          </button>
          <button class="adminNavBtn" data-section="batch">
            <span class="icon">‚ö°</span>
            Import Batch
          </button>
          <button class="adminNavBtn upload-btn" id="uploadToGitHubBtn">
            <span class="icon">üöÄ</span>
            Upload to GitHub
          </button>
        </div>
      </div>

      <div class="adminContent">
        <!-- SECTION: Ajouter un jeu - AM√âLIOR√âE SELON VOTRE DESIGN -->
        <div class="adminSection active" id="sectionAdd">
          <h2>‚ûï Ajouter / Modifier un jeu</h2>
          
          <div style="display: grid; grid-template-columns: 1fr 55px; gap: 16px; margin-bottom: 16px;">
            <div style="min-width: 0;">
              <label>Nom du jeu</label>
              <input type="text" id="gameName" placeholder="Ex: Nioh 3" style="width: 100%; box-sizing: border-box;" />
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button type="button" class="primary" id="searchIGDBBtn" style="white-space: nowrap; height: 44px; width: 55px; padding: 0 2px; font-size: 9px;">
                üîç IGDB
              </button>
            </div>
          </div>

          <div class="selectedGamePreview" id="selectedGamePreview">
            <div class="inner">
              <img id="selectedGameCover" src="" alt="Cover" />
              <div class="info">
                <div class="gameName" id="selectedGameName"></div>
                <div class="gameMeta" id="selectedGameMeta"></div>
                <div class="categories" id="selectedGameCategories"></div>
              </div>
            </div>
          </div>

          <!-- NOUVELLE SECTION CAT√âGORIES LISTE -->
          <div class="categories-list-container" style="margin-right: 0;">
            <h4>üéÆ Cat√©gories (modifiables)</h4>
            <div class="categories-list" id="categoriesList">
              <!-- Les cat√©gories seront g√©n√©r√©es ici dynamiquement -->
            </div>
            
            <div class="add-category-form">
              <input type="text" id="addCustomCat" placeholder="Ajouter une cat√©gorie..." />
              <button type="button" id="addCatManualBtn" class="primary" style="padding: 8px 12px; font-size: 12px;">
                Ajouter
              </button>
            </div>
          </div>

          <label style="display: block; margin-top: 16px; margin-bottom: 6px; font-size: clamp(12px, 1.05vw, 14px); letter-spacing: .5px; color: rgba(255,255,255,.75); font-weight: 500;">Lien Magnet</label>

          <!-- ZONE TORRENT + MAGNET EN GRID -->
          <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- ZONE DE D√âP√îT TORRENT -->
            <div class="torrent-drop-zone" id="torrentDropZone" style="padding: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border-radius: 12px; border: 2px dashed rgba(255,255,255,0.2); background: rgba(255,255,255,0.05);">
              <div style="font-size: 24px; margin-bottom: 6px;">üìé</div>
              <p style="font-size: 11px; margin: 0; line-height: 1.3;"><strong>.torrent</strong></p>
            </div>
            <input type="file" id="torrentFileInput" accept=".torrent" style="display:none;" />
            
            <!-- CHAMP MAGNET -->
            <div style="display: flex; flex-direction: column;">
              <textarea id="gameMagnet" placeholder="magnet:?xt=urn:btih:..." rows="4" style="flex: 1; min-height: 80px; resize: none; width: 100%; box-sizing: border-box;"></textarea>
            </div>
          </div>

          <!-- RECHERCHE 1337x -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-size: clamp(12px, 1.05vw, 14px); letter-spacing: .5px; color: rgba(255,255,255,.75); font-weight: 500;">üîç Rechercher le magnet auto</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="search1337xInput" placeholder="Nom du jeu..." style="flex: 1;" />
              <button type="button" id="search1337xBtn" class="btn-primary" style="padding: 8px 16px; white-space: nowrap;">Chercher</button>
            </div>
            <div id="search1337xResults" style="margin-top: 8px; max-height: 200px; overflow-y: auto;"></div>
          </div>

          <!-- CHAMP LIEN DIRECT (OPTIONNEL) -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-size: clamp(12px, 1.05vw, 14px); letter-spacing: .5px; color: rgba(255,255,255,.75); font-weight: 500;">‚¨áÔ∏è Lien de t√©l√©chargement direct (optionnel)</label>
            <input type="text" id="gameDirectLink" placeholder="https://exemple.com/telechargement/jeu.zip" style="width: 100%; box-sizing: border-box;" />
            <small style="color: rgba(255,255,255,.5); font-size: 11px; display: block; margin-top: 4px;">Lien qui lance directement le t√©l√©chargement du fichier</small>
          </div>

          <!-- CHAMP TRAILER YOUTUBE -->
          <div style="margin-bottom: 16px;">
            <label>üé¨ Trailer YouTube (optionnel)</label>
            <input type="text" id="trailerUrl" placeholder="https://youtube.com/watch?v=... ou https://youtu.be/..." style="width: 100%; box-sizing: border-box;" />
            <small style="color: rgba(255,255,255,.5); font-size: 11px; display: block; margin-top: 4px;">Laisse vide pour utiliser le trailer IGDB automatique</small>
          </div>

          <!-- PREVIEW COVER FIXE 3:4 + CHAMP URL √Ä DROITE - ALIGN√â -->
          <div style="display: grid; grid-template-columns: 140px 1fr; gap: 16px; margin-bottom: 16px; align-items: stretch;">
            <!-- CADRE PREVIEW 3:4 FIXE -->
            <div class="previewBox" id="coverPreviewBox" style="aspect-ratio: 3/4; position: relative; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.15); border-radius: 12px; overflow: hidden; box-sizing: border-box;">
              <img id="coverPreviewImg" src="" alt="Cover Preview" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; border: none; outline: none; box-shadow: none;" />
              <div id="coverPlaceholder" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,.4); font-size: 13px; text-align: center; box-sizing: border-box;">
                üì∏<br>Ctrl+V pour coller
              </div>
            </div>
            
            <!-- CHAMP URL √Ä DROITE -->
            <div style="display: flex; flex-direction: column; gap: 8px; min-width: 0;">
              <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                <label>URL de la Cover</label>
                <input type="text" id="gameCover" placeholder="https://images.igdb.com/..." style="width: 100%; box-sizing: border-box;" />
              </div>
              <button type="button" class="primary paste-image-btn" id="pasteImageBtn" style="width: 100%; height: 44px; box-sizing: border-box;">
                üìã Coller Image (Ctrl+V)
              </button>
            </div>
          </div>

          <div class="btnGroup">
            <button id="addGameBtn" class="primary">‚ûï Ajouter le jeu</button>
            <button id="saveEditBtn" class="primary" style="display:none;">üíæ Sauvegarder modif</button>
            <button id="cancelEditBtn" style="display:none;">‚ùå Annuler</button>
          </div>
        </div>

        <!-- SECTION: Liste des jeux -->
        <div class="adminSection" id="sectionList">
          <h2>üìã Liste des jeux</h2>
          <div class="gameSearchBox">
            <input type="text" id="gameSearchInput" placeholder="Rechercher un jeu..." />
          </div>
          <div class="gameListContainer" id="gameListAdminContainer">
            <div id="gameListAdmin"></div>
          </div>
        </div>

        <!-- SECTION: Cat√©gories -->
        <div class="adminSection" id="sectionCategories">
          <h2>üè∑Ô∏è G√©rer les cat√©gories</h2>
          <div class="formRow">
            <div>
              <input type="text" id="catName" placeholder="Nom de la cat√©gorie (ex: HORROR)" />
            </div>
            <div style="flex:0;">
              <button id="addCatBtn" class="primary">Ajouter</button>
            </div>
          </div>
          <div class="gameListContainer">
            <div id="catListAdmin"></div>
          </div>
        </div>

        <!-- SECTION: Sagas -->
        <div class="adminSection" id="sectionSagas">
          <h2>‚ú¶ G√©rer les Sagas</h2>
          
          <div style="background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.8);">
              ‚ú® Une saga regroupe plusieurs jeux li√©s (ex: Resident Evil 1, 2, 3...).<br>
              Les jeux d'une saga apparaissent comme une seule carte dor√©e sur le site.
            </p>
          </div>

          <!-- Cr√©er/Modifier une saga -->
          <div style="border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 24px; background: rgba(255,255,255,0.03);">
            <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 500; color: rgba(255,215,0,0.9);">Cr√©er / Modifier une Saga</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label>Nom de la saga</label>
                <input type="text" id="sagaName" placeholder="ex: Resident Evil" style="width: 100%;" />
              </div>
              <div>
                <label>ID unique (sans espaces)</label>
                <input type="text" id="sagaId" placeholder="ex: resident-evil" style="width: 100%;" />
              </div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label>S√©lectionner les jeux (dans l'ordre)</label>
              <input type="text" id="sagaGameSearch" placeholder="üîç Rechercher des jeux..." style="width: 100%; margin-top: 8px; margin-bottom: 8px;" />
              <div class="gameListContainer" id="sagaGameSelector" style="max-height: 200px; margin-top: 8px;">
                <p style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Chargement des jeux...</p>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button id="createSagaBtn" class="primary" style="background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,140,0,0.2)); border-color: rgba(255,215,0,0.4);">
                ‚ú® Cr√©er la Saga
              </button>
              <button id="updateSagaBtn" class="primary" style="display: none; background: linear-gradient(135deg, rgba(100,140,255,0.3), rgba(80,120,240,0.2));">
                üíæ Modifier la Saga
              </button>
              <button id="cancelSagaEditBtn" style="display: none;">‚ùå Annuler</button>
            </div>
          </div>

          <!-- Liste des sagas existantes -->
          <h3 style="margin: 0 0 12px; font-size: 16px; font-weight: 500;">Sagas existantes</h3>
          <div class="gameListContainer" id="sagaListAdmin">
            <p style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">Aucune saga cr√©√©e</p>
          </div>
        </div>

        <!-- SECTION: Import Batch - AJOUT MASSIF AUTOMATIQUE -->
        <div class="adminSection" id="sectionBatch">
          <h2>‚ö° Import Batch (Automatique)</h2>
          <p style="color: rgba(255,255,255,0.6); margin-bottom: 16px; font-size: 13px;">
            Collez plusieurs noms de jeux s√©par√©s par <strong>;</strong>. Le syst√®me cherchera automatiquement sur IGDB et les sources magnet.
          </p>

          <div style="margin-bottom: 16px;">
            <label>Noms des jeux (s√©par√©s par ;)</label>
            <textarea id="batchGamesInput" placeholder="Resident Evil 4; Silent Hill 2; God of War Ragnarok; Elden Ring..." rows="6" style="width: 100%; box-sizing: border-box; font-family: monospace; font-size: 13px;"></textarea>
            <small style="color: rgba(255,255,255,0.4); font-size: 11px;">Exemple: "Resident Evil HD Remaster; Silent Hill 2 Remake; God of War"</small>
          </div>

          <!-- Options -->
          <div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
              <input type="checkbox" id="batchSkipExisting" checked style="accent-color: #6366f1;" />
              <span>Ignorer les jeux existants</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
              <input type="checkbox" id="batchSkipNoMagnet" checked style="accent-color: #6366f1;" />
              <span>Ignorer si pas de magnet</span>
            </label>
          </div>

          <!-- Bouton Start -->
          <div style="margin-bottom: 20px;">
            <button type="button" id="startBatchImportBtn" class="primary" style="background: linear-gradient(135deg, rgba(100,140,255,0.3), rgba(80,120,240,0.2)); border-color: rgba(100,140,255,0.4); padding: 12px 24px; font-size: 14px;">
              üöÄ Lancer l'import batch
            </button>
            <button type="button" id="stopBatchImportBtn" class="danger" style="display: none; padding: 12px 24px; font-size: 14px;">
              ‚èπÔ∏è Arr√™ter
            </button>
          </div>

          <!-- Progress -->
          <div id="batchProgress" style="display: none; margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
              <span id="batchProgressText">Pr√©paration...</span>
              <span id="batchProgressPercent">0%</span>
            </div>
            <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
              <div id="batchProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #6366f1, #8b5cf6); transition: width 0.3s ease;"></div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: rgba(255,255,255,0.5);">
              <span id="batchStatsSuccess" style="color: #4ade80;">‚úì 0 ajout√©s</span> &nbsp;|&nbsp;
              <span id="batchStatsSkipped" style="color: #fbbf24;">‚è≠ 0 ignor√©s</span> &nbsp;|&nbsp;
              <span id="batchStatsFailed" style="color: #f87171;">‚úó 0 √©chou√©s</span>
            </div>
          </div>

          <!-- Log en temps r√©el -->
          <div style="margin-bottom: 16px;">
            <label style="display: flex; justify-content: space-between; align-items: center;">
              <span>Journal d'import</span>
              <button type="button" id="clearBatchLogBtn" style="padding: 4px 10px; font-size: 11px; opacity: 0.7;">Effacer</button>
            </label>
            <div id="batchLog" style="height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 12px; color: rgba(255,255,255,0.8);">
              <div style="color: rgba(255,255,255,0.4);">Pr√™t pour l'import batch...</div>
            </div>
          </div>

          <!-- R√©sultat final -->
          <div id="batchResult" style="display: none; padding: 16px; background: rgba(99,102,241,0.1); border-radius: 12px; border: 1px solid rgba(99,102,241,0.3);">
            <h4 style="margin: 0 0 12px; color: #a5b4fc;">‚úÖ Import termin√© !</h4>
            <div id="batchResultContent" style="font-size: 13px; line-height: 1.6;"></div>
          </div>
        </div>

        <!-- SECTION: Export/Import (remplace Upload) -->
        <div class="adminSection" id="sectionExport">
          <h2>üìÅ Export / Import</h2>
          
          <div class="stateMsg" id="exportStateMsg" style="display:none;"></div>
          
          <div class="previewBox">
            <h3>üìä Statistiques</h3>
            <div style="color: rgba(255,255,255,.7);">
              <p><strong>üéÆ Total jeux:</strong> <span id="statGames">0</span></p>
              <p><strong>üè∑Ô∏è Cat√©gories:</strong> <span id="statCategories">0</span></p>
              <p><strong>üìÅ Derni√®re modif:</strong> <span id="statLastModified">Jamais</span></p>
            </div>
          </div>
          
          <div class="btnGroup" style="margin-top: 20px;">
            <button id="exportBtn" class="primary">üíæ Exporter JSON</button>
            <button id="importBtn" class="primary">üì• Importer JSON</button>
            <button id="resetBtn" class="danger">üîÑ Reset local</button>
          </div>

          <input type="file" id="filePick" accept=".json" style="display:none;" />
        </div>
      </div>
    </div>
  </div>

  <!-- MENU S√âLECTION IGDB -->
  <div class="game-selector-modal" id="gameSelectorModal" aria-hidden="true">
    <div class="game-selector-box">
      <div class="game-selector-header">
        <h2>S√©lectionnez le jeu</h2>
        <button class="game-selector-close" id="gameSelectorClose" aria-label="Fermer">‚úï</button>
      </div>
      <div class="game-selector-content" id="gameSelectorContent">
        <div class="game-selector-loading">
          <div class="spinner"></div>
          <p>Recherche en cours...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Configuration
    const ADMIN_PASSWORD = "141592";
    const LOCAL_KEY = "crackuzu_draft_v3";
    const CLOUDINARY_CLOUD_NAME = "dkcui82mx";
    const CLOUDINARY_UPLOAD_PRESET = "crackuzu";

    const DEFAULT_DATA = {
      categories: ["ACTION", "RPG", "STRATEGY", "SIMULATION", "SPORT"],
      games: [],
      sagas: []
    };

    let state = {
      data: structuredClone(DEFAULT_DATA),
      activeCat: "ALL",
      query: "",
      adminUnlocked: false,
      selectedCategories: [],
      adminSearchQuery: "",
      lastModified: null,
      selectedSagaGames: []
    };

    let editIndex = null;
    let selectedGameData = null;

    // √âl√©ments DOM
    const catList = document.getElementById("catList");
    const gameGrid = document.getElementById("gameGrid");
    const noGames = document.getElementById("noGames");
    const stateMsg = document.getElementById("stateMsg");
    const toast = document.getElementById("toast");

    const adminEntry = document.getElementById("adminEntry");
    const adminPill = document.getElementById("adminPill");
    const adminModal = document.getElementById("adminModal");
    const closeAdmin = document.getElementById("closeAdmin");

    const uploadToGitHubBtn = document.getElementById("uploadToGitHubBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const resetBtn = document.getElementById("resetBtn");
    const filePick = document.getElementById("filePick");
    const exportStateMsg = document.getElementById("exportStateMsg");

    const gameName = document.getElementById("gameName");
    const gameMagnet = document.getElementById("gameMagnet");
    const gameDirectLink = document.getElementById("gameDirectLink");
    const gameCover = document.getElementById("gameCover");
    const trailerUrl = document.getElementById("trailerUrl");
    const searchIGDBBtn = document.getElementById("searchIGDBBtn");
    const pasteImageBtn = document.getElementById("pasteImageBtn");
    const addGameBtn = document.getElementById("addGameBtn");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    const selectedGamePreview = document.getElementById("selectedGamePreview");
    const gameListAdmin = document.getElementById("gameListAdmin");
    const gameSearchInput = document.getElementById("gameSearchInput");
    const catListAdmin = document.getElementById("catListAdmin");
    const catName = document.getElementById("catName");
    const addCatBtn = document.getElementById("addCatBtn");

    const torrentDropZone = document.getElementById("torrentDropZone");
    const torrentFileInput = document.getElementById("torrentFileInput");

    // √âl√©ments 1337x search
    const search1337xInput = document.getElementById("search1337xInput");
    const search1337xBtn = document.getElementById("search1337xBtn");
    const search1337xResults = document.getElementById("search1337xResults");

    const gameSelectorModal = document.getElementById("gameSelectorModal");
    const gameSelectorClose = document.getElementById("gameSelectorClose");
    const gameSelectorContent = document.getElementById("gameSelectorContent");

    // Nouveaux √©l√©ments pour les cat√©gories liste
    const categoriesList = document.getElementById("categoriesList");
    const addCustomCat = document.getElementById("addCustomCat");
    const addCatManualBtn = document.getElementById("addCatManualBtn");

    // Statistiques
    const statGames = document.getElementById("statGames");
    const statCategories = document.getElementById("statCategories");
    const statLastModified = document.getElementById("statLastModified");

    // Utilitaires
    function norm(s){ return (s || "").trim(); }
    function upper(s){ return norm(s).toUpperCase(); }

    // Extraire l'ID YouTube d'une URL
    function extractYouTubeId(url) {
      if (!url) return null;
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /v=([a-zA-Z0-9_-]{11})/,
        /\/embed\/([a-zA-Z0-9_-]{11})/,
        /\/shorts\/([a-zA-Z0-9_-]{11})/
      ];
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      return null;
    }

    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    function setStateMessage(msg, element = stateMsg){
      if(!msg){
        element.style.display = "none";
        element.textContent = "";
      }else{
        element.style.display = "block";
        element.textContent = msg;
      }
    }

    function saveLocalDraft(){ 
      state.lastModified = new Date().toISOString();
      localStorage.setItem(LOCAL_KEY, JSON.stringify(state.data));
      localStorage.setItem(LOCAL_KEY + "_lastModified", state.lastModified);
    }
    
    function loadLocalDraft(){
      const raw = localStorage.getItem(LOCAL_KEY);
      state.lastModified = localStorage.getItem(LOCAL_KEY + "_lastModified");
      
      if(!raw) return null;
      try{
        return sanitizeData(JSON.parse(raw));
      }catch{
        return null;
      }
    }

    function sanitizeData(obj){
      if(!obj.categories || !Array.isArray(obj.categories)) obj.categories = [];
      if(!obj.games || !Array.isArray(obj.games)) obj.games = [];
      if(!obj.sagas || !Array.isArray(obj.sagas)) obj.sagas = [];
      
      obj.games = obj.games.map(g => {
        if(Array.isArray(g.categories)){
          return g;
        }
        const migrated = {...g};
        if(g.cat){
          migrated.categories = [g.cat.toUpperCase()];
        }else{
          migrated.categories = ['ACTION'];
        }
        return migrated;
      });
      
      return obj;
    }

    // FONCTION CORRIG√âE pour charger les donn√©es
    async function loadDataFromRepo(){
      console.log("üîç Tentative de chargement depuis data.json...");
      
      try {
        const res = await fetch('data.json?v=' + Date.now());
        console.log("üìÑ Statut de la requ√™te data.json:", res.status);
        
        if(res.ok){
          const json = await res.json();
          console.log("‚úÖ data.json charg√© avec succ√®s !");
          console.log("üéÆ Nombre de jeux trouv√©s:", json.games?.length || 0);
          
          if (!json.games || json.games.length === 0) {
            console.warn("‚ö†Ô∏è data.json contient 0 jeux");
          }
          
          return sanitizeData(json);
        } else {
          console.error("‚ùå data.json non trouv√©, statut:", res.status);
          return null;
        }
      } catch(e){
        console.error("‚ùå Erreur lors du chargement de data.json:", e);
        return null;
      }
    }

    // Fonction pour rendre les cat√©gories en liste (selon votre design)
    function renderCategoriesList() {
      if (!categoriesList) return;
      
      categoriesList.innerHTML = '';
      
      // Afficher les cat√©gories existantes
      state.data.categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.textContent = cat;
        
        // Si la cat√©gorie est d√©j√† s√©lectionn√©e
        if (state.selectedCategories.includes(cat)) {
          item.classList.add('selected');
        }
        
        item.addEventListener('click', () => {
          item.classList.toggle('selected');
          
          if (item.classList.contains('selected')) {
            if (!state.selectedCategories.includes(cat)) {
              state.selectedCategories.push(cat);
            }
          } else {
            state.selectedCategories = state.selectedCategories.filter(c => c !== cat);
          }
          
          updateSelectedCategoriesDisplay();
        });
        
        categoriesList.appendChild(item);
      });
    }

    // Fonction pour mettre √† jour l'affichage des cat√©gories s√©lectionn√©es
    function updateSelectedCategoriesDisplay() {
      const previewEl = document.getElementById('selectedGameCategories');
      if (previewEl) {
        const categoriesHTML = state.selectedCategories.map(cat => 
          `<span class="catBadge selected" style="font-size: 10px; padding: 3px 8px;">${cat}</span>`
        ).join('');
        previewEl.innerHTML = categoriesHTML;
      }
    }

    // Navigation admin
    document.querySelectorAll('.adminNavBtn:not(.upload-btn)').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.adminNavBtn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.adminSection').forEach(s => s.classList.remove('active'));
        
        btn.classList.add('active');
        const section = btn.getAttribute('data-section');
        document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');
        
        updateStats();
      });
    });

    // Mettre √† jour les statistiques
    function updateStats() {
      const totalGames = state.data.games.length;
      const totalCategories = state.data.categories.length;
      
      let formattedDate = "Jamais";
      if (state.lastModified) {
        const date = new Date(state.lastModified);
        formattedDate = date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      }
      
      statGames.textContent = totalGames;
      statCategories.textContent = totalCategories;
      statLastModified.textContent = formattedDate;
    }

    // Upload to GitHub direct
    uploadToGitHubBtn.addEventListener("click", async () => {
      const ok = confirm("Publier sur GitHub ? Cette action √©crasera le fichier data.json sur le d√©p√¥t.");
      if(!ok) return;

      // D√©sactiver le bouton pendant l'upload
      uploadToGitHubBtn.disabled = true;
      uploadToGitHubBtn.innerHTML = '<span class="icon">‚è≥</span> Publication en cours...';
      
      toastMsg("üöÄ Publication en cours...");

      try{
        const response = await fetch('https://crackuzu-api.crackuzu.workers.dev/api/github-save', {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(state.data)
        });

        if(!response.ok){
          const errData = await response.json();
          throw new Error(errData.error || "Erreur de publication");
        }

        const result = await response.json();
        
        if(result.success){
          localStorage.removeItem(LOCAL_KEY);
          localStorage.removeItem(LOCAL_KEY + "_lastModified");
          state.lastModified = null;
          
          toastMsg("‚úÖ Publi√© sur GitHub avec succ√®s !");
          updateStats();
        }else{
          throw new Error("√âchec de la publication");
        }
      }catch(err){
        console.error("Upload error:", err);
        toastMsg("‚ùå Erreur: " + err.message);
      } finally {
        // R√©activer le bouton
        setTimeout(() => {
          uploadToGitHubBtn.disabled = false;
          uploadToGitHubBtn.innerHTML = '<span class="icon">üöÄ</span> Upload to GitHub';
        }, 2000);
      }
    });

    // Render functions
    function renderCategories(){
      const all = ["ALL", ...state.data.categories];
      catList.innerHTML = "";
      
      all.forEach((cat, index) => {
        const btn = document.createElement("div");
        btn.className = "catbtn";
        btn.style.animationDelay = `${0.05 + (index * 0.08)}s`;
        if(cat === state.activeCat) btn.classList.add("active");
        btn.textContent = cat;
        btn.addEventListener("click", () => {
          state.activeCat = cat;
          renderCategories();
          renderGames();
        });
        catList.appendChild(btn);
      });
    }

    // ===== FONCTIONS SAGA =====
    
    // Trouver dans quelle saga un jeu appartient
    function findSagaForGame(gameName) {
      if (!state.data.sagas) return null;
      return state.data.sagas.find(saga => 
        saga.games && saga.games.includes(gameName)
      );
    }
    
    // Ouvrir le modal d'une saga
    function openSagaModal(saga) {
      const modal = document.getElementById('sagaModal');
      const title = document.getElementById('sagaModalTitle');
      const grid = document.getElementById('sagaGamesGrid');
      
      title.textContent = saga.name;
      grid.innerHTML = '';
      
      // R√©cup√©rer les jeux de la saga dans l'ordre
      const sagaGames = saga.games.map((gameName, index) => {
        const game = state.data.games.find(g => g.name === gameName);
        return { ...game, order: index + 1 };
      }).filter(g => g.name); // Filtrer les jeux non trouv√©s
      
      // Cr√©er les cartes pour chaque jeu
      sagaGames.forEach((game, index) => {
        const card = document.createElement('div');
        card.className = 'saga-game-card';
        card.style.animationDelay = `${index * 0.1}s`;
        
        const orderBadge = document.createElement('div');
        orderBadge.className = 'game-order';
        orderBadge.textContent = game.order;
        
        const img = document.createElement('img');
        img.src = game.cover || '';
        img.alt = game.name;
        img.loading = 'lazy';
        img.onerror = function() {
          this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='533' viewBox='0 0 400 533'%3E%3Crect width='400' height='533' fill='%23222'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='20' fill='white' text-anchor='middle' dominant-baseline='middle'%3E" + game.name.substring(0, 20) + "%3C/text%3E%3C/svg%3E";
        };
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'game-title';
        titleDiv.textContent = game.name;
        
        card.appendChild(orderBadge);
        card.appendChild(img);
        card.appendChild(titleDiv);
        
        card.addEventListener('click', () => {
          // Animation de transition vers game.html
          const transition = document.createElement('div');
          transition.style.cssText = `
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #0a0a12;
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: all;
          `;
          document.body.appendChild(transition);
          
          transition.offsetHeight;
          transition.style.opacity = '1';
          
          setTimeout(() => {
            window.location.href = `game.html?name=${encodeURIComponent(game.name)}`;
          }, 400);
        });
        
        grid.appendChild(card);
      });
      
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    // Fermer le modal saga
    function closeSagaModal() {
      const modal = document.getElementById('sagaModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Fermer le modal saga au clic sur le bouton
    document.getElementById('closeSagaModal').addEventListener('click', closeSagaModal);
    document.getElementById('sagaModal').addEventListener('click', (e) => {
      if (e.target.id === 'sagaModal') closeSagaModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSagaModal();
    });

    function renderGames(){
      let filtered = state.data.games;

      if(state.activeCat !== "ALL"){
        filtered = filtered.filter(g => {
          const cats = Array.isArray(g.categories) ? g.categories : [];
          return cats.includes(state.activeCat);
        });
      }

      if(state.query){
        const lq = state.query.toLowerCase();
        filtered = filtered.filter(g => g.name.toLowerCase().includes(lq));
      }
      
      // Regrouper les jeux par saga
      const gamesInSagas = new Set();
      state.data.sagas.forEach(saga => {
        if (saga.games) {
          saga.games.forEach(gameName => gamesInSagas.add(gameName));
        }
      });
      
      // S√©parer les jeux qui sont dans des sagas de ceux qui ne le sont pas
      const standaloneGames = filtered.filter(g => !gamesInSagas.has(g.name));
      
      // Trouver les sagas qui ont au moins un jeu visible dans le filtre actuel
      const visibleSagas = state.data.sagas.filter(saga => {
        if (!saga.games) return false;
        return saga.games.some(gameName => {
          const game = state.data.games.find(g => g.name === gameName);
          if (!game) return false;
          
          // V√©rifier si ce jeu est dans le filtre actuel
          if (state.activeCat !== "ALL") {
            const cats = Array.isArray(game.categories) ? game.categories : [];
            if (!cats.includes(state.activeCat)) return false;
          }
          
          if (state.query) {
            if (!game.name.toLowerCase().includes(state.query.toLowerCase())) return false;
          }
          
          return true;
        });
      });
      
      // Mettre √† jour le compteur (sagas + jeux standalone)
      const totalItems = visibleSagas.length + standaloneGames.length;
      const gameCountDisplay = document.getElementById("gameCountDisplay");
      if (gameCountDisplay) {
        gameCountDisplay.textContent = totalItems + (totalItems > 1 ? " √©l√©ments" : " √©l√©ment");
      }

      gameGrid.innerHTML = "";
      
      if(totalItems === 0){
        noGames.style.display = "block";
        noGames.textContent = state.data.games.length === 0 ? 
          "Aucun jeu dans la biblioth√®que. Ajoutez-en via le panneau admin." : 
          "Aucun jeu trouv√© pour les filtres s√©lectionn√©s.";
        return;
      }

      noGames.style.display = "none";
      
      // Afficher d'abord les sagas
      visibleSagas.forEach((saga, index) => {
        const card = document.createElement("div");
        card.className = "saga-card";
        card.style.animationDelay = `${index === 0 ? 0.5 : 0.5 + (index * 0.066)}s`;

        // Badge "SAGA"
        const badge = document.createElement("div");
        badge.className = "saga-badge";
        badge.textContent = "SAGA";
        
        // Badge compteur
        const countBadge = document.createElement("div");
        countBadge.className = "saga-count";
        countBadge.textContent = `${saga.games.length} jeux`;

        // Grille de covers (max 4)
        const coverGrid = document.createElement("div");
        coverGrid.className = "saga-cover-grid";
        
        const gamesToShow = saga.games.slice(0, 4);
        gamesToShow.forEach(gameName => {
          const game = state.data.games.find(g => g.name === gameName);
          if (game && game.cover) {
            const img = document.createElement("img");
            img.src = game.cover;
            img.alt = gameName;
            img.loading = "lazy";
            img.onerror = function() {
              this.style.display = 'none';
            };
            coverGrid.appendChild(img);
          }
        });

        // Titre de la saga
        const title = document.createElement("div");
        title.className = "saga-title";
        title.textContent = saga.name;

        card.appendChild(badge);
        card.appendChild(countBadge);
        card.appendChild(coverGrid);
        card.appendChild(title);

        card.addEventListener("click", () => {
          openSagaModal(saga);
        });

        gameGrid.appendChild(card);
      });
      
      // Puis afficher les jeux standalone
      standaloneGames.forEach((g, index) => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.animationDelay = `${index === 0 ? 0.5 : 0.5 + (index * 0.066)}s`;

        const bg = document.createElement("div");
        bg.className = "card-bg";
        const img = document.createElement("img");
        img.src = g.cover || "";
        img.alt = g.name;
        img.loading = "lazy";
        img.onerror = function() {
          this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='533' viewBox='0 0 400 533'%3E%3Crect width='400' height='533' fill='%23222'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='20' fill='white' text-anchor='middle' dominant-baseline='middle'%3E" + g.name.substring(0, 20) + "%3C/text%3E%3C/svg%3E";
        };
        bg.appendChild(img);

        const overlay = document.createElement("div");
        overlay.className = "card-overlay";

        const title = document.createElement("h3");
        title.className = "card-title";
        title.textContent = g.name;

        const downloadLink = document.createElement("a");
        // Si lien direct disponible, on l'utilise, sinon magnet
        const hasDirectLink = g.directLink && g.directLink.trim() !== '';
        downloadLink.className = "card-download";
        downloadLink.href = hasDirectLink ? g.directLink : g.magnet;
        downloadLink.target = "_blank";
        downloadLink.innerHTML = `
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
          </svg>
          T√©l√©charger
        `;
        downloadLink.addEventListener("click", (e) => e.stopPropagation());

        overlay.appendChild(title);
        overlay.appendChild(downloadLink);

        card.appendChild(bg);
        card.appendChild(overlay);

        card.addEventListener("click", () => {
          // Animation de transition vers game.html
          const transition = document.createElement('div');
          transition.style.cssText = `
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #0a0a12;
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: all;
          `;
          document.body.appendChild(transition);
          
          transition.offsetHeight;
          transition.style.opacity = '1';
          
          setTimeout(() => {
            window.location.href = `game.html?name=${encodeURIComponent(g.name)}`;
          }, 400);
        });

        gameGrid.appendChild(card);
      });
    }

    function renderAdminLists(){
      // Cat√©gories
      catListAdmin.innerHTML = "";
      state.data.categories.forEach((cat, idx) => {
        const row = document.createElement("div");
        row.className = "catRow";

        const name = document.createElement("span");
        name.className = "name";
        name.textContent = cat;

        const del = document.createElement("button");
        del.className = "iconBtn danger";
        del.textContent = "Suppr";
        del.addEventListener("click", () => {
          const ok = confirm(`Supprimer la cat√©gorie "${cat}" ?`);
          if(!ok) return;

          state.data.categories.splice(idx, 1);
          
          state.data.games.forEach(g => {
            if(Array.isArray(g.categories)){
              g.categories = g.categories.filter(c => c !== cat);
            }
          });

          saveLocalDraft();
          renderCategories();
          renderGames();
          renderAdminLists();
          renderCategoriesList();
          toastMsg("Cat√©gorie supprim√©e");
        });

        row.appendChild(name);
        row.appendChild(del);
        catListAdmin.appendChild(row);
      });

      // Jeux avec recherche
      renderAdminGamesList();
    }

    function renderAdminGamesList() {
      gameListAdmin.innerHTML = "";
      
      let filteredGames = state.data.games;
      
      if (state.adminSearchQuery) {
        const searchTerm = state.adminSearchQuery.toLowerCase();
        filteredGames = filteredGames.filter(g => 
          g.name.toLowerCase().includes(searchTerm)
        );
      }
      
      if (filteredGames.length === 0) {
        const emptyMsg = document.createElement("div");
        emptyMsg.style.textAlign = "center";
        emptyMsg.style.padding = "40px 20px";
        emptyMsg.style.color = "rgba(255,255,255,.5)";
        emptyMsg.textContent = state.adminSearchQuery ? 
          `Aucun jeu trouv√© pour "${state.adminSearchQuery}"` : 
          "Aucun jeu dans la biblioth√®que";
        gameListAdmin.appendChild(emptyMsg);
        return;
      }
      
      filteredGames.forEach((g, idx) => {
        const originalIndex = state.data.games.findIndex(game => game.name === g.name);
        const row = document.createElement("div");
        row.className = "gameRow";

        const left = document.createElement("div");
        left.className = "left";

        const thumb = document.createElement("img");
        thumb.className = "thumb";
        thumb.src = g.cover || "";
        thumb.alt = g.name;

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = g.name;

        const categories = Array.isArray(g.categories) ? g.categories : [];
        const catSpan = document.createElement("span");
        catSpan.className = "cat";
        catSpan.textContent = categories.join(", ") || "AUCUNE";

        left.appendChild(thumb);
        left.appendChild(nameSpan);
        left.appendChild(catSpan);

        const edit = document.createElement("button");
        edit.className = "iconBtn primary";
        edit.type = "button";
        edit.textContent = "Modif";
        edit.addEventListener("click", () => {
          editIndex = originalIndex;
          addGameBtn.style.display = "none";
          saveEditBtn.style.display = "";
          cancelEditBtn.style.display = "";

          gameName.value = g.name;
          gameMagnet.value = g.magnet;
          gameDirectLink.value = g.directLink || "";
          gameCover.value = g.cover || "";

          // Populate trailerUrl from videoId if it exists
          if (g.videoId) {
            trailerUrl.value = `https://youtube.com/watch?v=${g.videoId}`;
          } else {
            trailerUrl.value = "";
          }

          const gameCategories = Array.isArray(g.categories) ? g.categories : [];
          state.selectedCategories = [...gameCategories];
          
          gameCategories.forEach(cat => {
            if(!state.data.categories.includes(cat)){
              state.data.categories.push(cat);
            }
          });
          
          // Rendre les cat√©gories liste
          renderCategoriesList();
          updateSelectedCategoriesDisplay();
          
          renderCategories();
          toastMsg("Mode modification");
          
          document.querySelectorAll('.adminNavBtn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.adminSection').forEach(s => s.classList.remove('active'));
          document.querySelector('[data-section="add"]').classList.add('active');
          document.getElementById('sectionAdd').classList.add('active');
        });

        const del = document.createElement("button");
        del.className = "iconBtn danger";
        del.type = "button";
        del.textContent = "Suppr";
        del.addEventListener("click", () => {
          const ok = confirm(`Supprimer "${g.name}" ?`);
          if(!ok) return;
          state.data.games.splice(originalIndex, 1);
          saveLocalDraft();
          renderGames();
          renderAdminLists();
          if(editIndex === originalIndex) exitEditMode();
          toastMsg("Jeu supprim√©");
        });

        row.appendChild(left);
        row.appendChild(edit);
        row.appendChild(del);
        gameListAdmin.appendChild(row);
      });
    }

    // ===== FONCTIONS ADMIN SAGAS =====
    
    let editingSagaId = null;
    
    function renderAdminSagasList() {
      const sagaListAdmin = document.getElementById('sagaListAdmin');
      if (!sagaListAdmin) return;
      
      sagaListAdmin.innerHTML = '';
      
      if (!state.data.sagas || state.data.sagas.length === 0) {
        sagaListAdmin.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">Aucune saga cr√©√©e</p>';
        return;
      }
      
      state.data.sagas.forEach((saga, idx) => {
        const row = document.createElement('div');
        row.className = 'gameRow';
        
        const left = document.createElement('div');
        left.className = 'left';
        
        // Mini covers
        const coversHtml = saga.games.slice(0, 3).map(gameName => {
          const game = state.data.games.find(g => g.name === gameName);
          return game && game.cover ? `<img src="${game.cover}" style="width:30px;height:40px;object-fit:cover;border-radius:4px;margin-right:4px;" />` : '';
        }).join('');
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.innerHTML = `‚ú¶ ${saga.name} <span style="color:rgba(255,215,0,0.7);">(${saga.games.length} jeux)</span>`;
        
        left.innerHTML = coversHtml;
        left.appendChild(nameSpan);
        
        const edit = document.createElement('button');
        edit.className = 'iconBtn primary';
        edit.type = 'button';
        edit.textContent = 'Modif';
        edit.addEventListener('click', () => {
          startEditSaga(saga);
        });
        
        const del = document.createElement('button');
        del.className = 'iconBtn danger';
        del.type = 'button';
        del.textContent = 'Suppr';
        del.addEventListener('click', () => {
          const ok = confirm(`Supprimer la saga "${saga.name}" ? Les jeux ne seront pas supprim√©s.`);
          if (!ok) return;
          state.data.sagas.splice(idx, 1);
          saveLocalDraft();
          renderAdminSagasList();
          renderGames();
          toastMsg('Saga supprim√©e');
        });
        
        row.appendChild(left);
        row.appendChild(edit);
        row.appendChild(del);
        sagaListAdmin.appendChild(row);
      });
    }
    
    let sagaGameSearchQuery = '';
    
    function renderSagaGameSelector(searchQuery = '') {
      const selector = document.getElementById('sagaGameSelector');
      if (!selector) return;
      
      selector.innerHTML = '';
      
      if (state.data.games.length === 0) {
        selector.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Aucun jeu disponible</p>';
        return;
      }
      
      // Jeux d√©j√† dans une saga (pour les d√©sactiver)
      const gamesInSagas = new Set();
      state.data.sagas.forEach(saga => {
        if (saga.games) {
          saga.games.forEach(gameName => {
            // Si on est en mode √©dition, ne pas d√©sactiver les jeux de la saga qu'on √©dite
            if (!editingSagaId || saga.id !== editingSagaId) {
              gamesInSagas.add(gameName);
            }
          });
        }
      });
      
      // Filtrer et scorer les jeux avec fuzzy search si une recherche est active
      let gamesToShow = state.data.games;
      
      if (searchQuery.trim()) {
        const query = searchQuery.toLowerCase().trim();
        
        // Scorer chaque jeu avec fuzzy
        const scoredGames = state.data.games.map(game => {
          const score = fuzzyScore(query, game.name);
          return { game, score };
        }).filter(item => item.score > 0);
        
        // Trier par score d√©croissant
        scoredGames.sort((a, b) => b.score - a.score);
        
        // Prendre les jeux avec un score > 100 (correspondance moyenne ou meilleure)
        gamesToShow = scoredGames.filter(item => item.score >= 100).map(item => item.game);
        
        // Si aucun r√©sultat avec score >= 100, prendre les 5 meilleurs
        if (gamesToShow.length === 0 && scoredGames.length > 0) {
          gamesToShow = scoredGames.slice(0, 5).map(item => item.game);
        }
      }
      
      // Trier: jeux s√©lectionn√©s d'abord, PUIS par score de correspondance (si recherche active), PUIS alphab√©tique
      gamesToShow.sort((a, b) => {
        const aSelected = state.selectedSagaGames && state.selectedSagaGames.includes(a.name);
        const bSelected = state.selectedSagaGames && state.selectedSagaGames.includes(b.name);
        
        // Priorit√© 1: Jeux s√©lectionn√©s en premier
        if (aSelected && !bSelected) return -1;
        if (!aSelected && bSelected) return 1;
        
        // Si les deux sont s√©lectionn√©s, ordre de s√©lection
        if (aSelected && bSelected) {
          const aOrder = state.selectedSagaGames.indexOf(a.name);
          const bOrder = state.selectedSagaGames.indexOf(b.name);
          return aOrder - bOrder;
        }
        
        // Priorit√© 2: Score de correspondance (si recherche active)
        if (searchQuery.trim()) {
          const scoreA = fuzzyScore(searchQuery.toLowerCase(), a.name);
          const scoreB = fuzzyScore(searchQuery.toLowerCase(), b.name);
          if (scoreB !== scoreA) {
            return scoreB - scoreA; // Score d√©croissant
          }
        }
        
        // Priorit√© 3: Ordre alphab√©tique
        return a.name.localeCompare(b.name);
      });
      
      if (gamesToShow.length === 0) {
        selector.innerHTML = `<p style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Aucun jeu trouv√© pour "${searchQuery}"</p>`;
        return;
      }
      
      gamesToShow.forEach(game => {
        const item = document.createElement('div');
        item.className = 'game-selector-item';
        item.style.cssText = 'padding: 8px 12px; cursor: pointer; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; gap: 10px;';
        
        const isSelected = state.selectedSagaGames && state.selectedSagaGames.includes(game.name);
        const isInOtherSaga = gamesInSagas.has(game.name);
        
        if (isSelected) {
          item.style.background = 'rgba(255,215,0,0.2)';
          item.style.border = '1px solid rgba(255,215,0,0.4)';
        } else if (isInOtherSaga) {
          item.style.background = 'rgba(255,255,255,0.03)';
          item.style.opacity = '0.5';
          item.style.cursor = 'not-allowed';
        } else {
          item.style.background = 'rgba(255,255,255,0.05)';
          item.style.border = '1px solid rgba(255,255,255,0.1)';
        }
        
        // Num√©ro d'ordre si s√©lectionn√©
        let orderBadge = '';
        if (isSelected) {
          const order = state.selectedSagaGames.indexOf(game.name) + 1;
          orderBadge = `<span style="background: rgba(255,215,0,0.9); color: #000; padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 700;">${order}</span>`;
        }
        
        // Badge "Meilleure correspondance" si recherche active
        let matchBadge = '';
        if (searchQuery.trim() && !isSelected && !isInOtherSaga) {
          const score = fuzzyScore(searchQuery.toLowerCase(), game.name);
          if (score >= 900) {
            matchBadge = `<span style="background: rgba(100,255,100,0.3); color: #90EE90; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">‚≠ê Exact</span>`;
          } else if (score >= 700) {
            matchBadge = `<span style="background: rgba(100,200,255,0.2); color: #87CEEB; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">‚úì Correspond</span>`;
          }
        }
        
        item.innerHTML = `
          <img src="${game.cover || ''}" style="width: 40px; height: 54px; object-fit: cover; border-radius: 4px;" />
          <div style="flex: 1;">
            <div style="font-weight: 500; color: rgba(255,255,255,0.9);">${game.name}${matchBadge}</div>
            ${isInOtherSaga ? '<div style="font-size: 11px; color: rgba(255,100,100,0.8);">D√©j√† dans une saga</div>' : ''}
          </div>
          ${orderBadge}
        `;
        
        if (!isInOtherSaga) {
          item.addEventListener('click', () => {
            if (!state.selectedSagaGames) state.selectedSagaGames = [];
            
            if (isSelected) {
              state.selectedSagaGames = state.selectedSagaGames.filter(name => name !== game.name);
            } else {
              state.selectedSagaGames.push(game.name);
            }
            renderSagaGameSelector(sagaGameSearchQuery);
          });
        }
        
        selector.appendChild(item);
      });
      
      // Message indiquant combien de jeux sont affich√©s vs total
      if (searchQuery.trim()) {
        const infoDiv = document.createElement('div');
        infoDiv.style.cssText = 'text-align: center; padding: 8px; font-size: 12px; color: rgba(255,255,255,0.5); border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px;';
        infoDiv.textContent = `${gamesToShow.length} jeu(x) trouv√©(s) sur ${state.data.games.length} total`;
        selector.appendChild(infoDiv);
      }
    }
    
    function startEditSaga(saga) {
      editingSagaId = saga.id;
      document.getElementById('sagaName').value = saga.name;
      document.getElementById('sagaId').value = saga.id;
      document.getElementById('sagaId').disabled = true;
      state.selectedSagaGames = [...saga.games];
      
      document.getElementById('createSagaBtn').style.display = 'none';
      document.getElementById('updateSagaBtn').style.display = '';
      document.getElementById('cancelSagaEditBtn').style.display = '';
      
      renderSagaGameSelector();
      
      // Scroll vers le formulaire
      document.getElementById('sectionSagas').scrollIntoView({ behavior: 'smooth' });
    }
    
    function resetSagaForm() {
      editingSagaId = null;
      document.getElementById('sagaName').value = '';
      document.getElementById('sagaId').value = '';
      document.getElementById('sagaId').disabled = false;
      state.selectedSagaGames = [];
      
      document.getElementById('createSagaBtn').style.display = '';
      document.getElementById('updateSagaBtn').style.display = 'none';
      document.getElementById('cancelSagaEditBtn').style.display = 'none';
      
      renderSagaGameSelector();
    }
    
    // Event listeners pour les sagas
    document.getElementById('createSagaBtn')?.addEventListener('click', () => {
      const name = document.getElementById('sagaName').value.trim();
      const id = document.getElementById('sagaId').value.trim().toLowerCase().replace(/\s+/g, '-');
      
      if (!name) return toastMsg('Nom de la saga requis');
      if (!id) return toastMsg('ID de la saga requis');
      if (!state.selectedSagaGames || state.selectedSagaGames.length < 2) {
        return toastMsg('S√©lectionnez au moins 2 jeux');
      }
      
      // V√©rifier si l'ID existe d√©j√†
      if (state.data.sagas.find(s => s.id === id)) {
        return toastMsg('Cet ID existe d√©j√†');
      }
      
      state.data.sagas.push({
        id,
        name,
        games: [...state.selectedSagaGames]
      });
      
      saveLocalDraft();
      renderAdminSagasList();
      renderGames();
      resetSagaForm();
      toastMsg('Saga cr√©√©e !');
    });
    
    document.getElementById('updateSagaBtn')?.addEventListener('click', () => {
      if (!editingSagaId) return;
      
      const name = document.getElementById('sagaName').value.trim();
      
      if (!name) return toastMsg('Nom de la saga requis');
      if (!state.selectedSagaGames || state.selectedSagaGames.length < 2) {
        return toastMsg('S√©lectionnez au moins 2 jeux');
      }
      
      const saga = state.data.sagas.find(s => s.id === editingSagaId);
      if (saga) {
        saga.name = name;
        saga.games = [...state.selectedSagaGames];
      }
      
      saveLocalDraft();
      renderAdminSagasList();
      renderGames();
      resetSagaForm();
      toastMsg('Saga modifi√©e !');
    });
    
    document.getElementById('cancelSagaEditBtn')?.addEventListener('click', resetSagaForm);
    
    // Rendre le s√©lecteur quand on ouvre la section sagas
    document.querySelector('[data-section="sagas"]')?.addEventListener('click', () => {
      state.selectedSagaGames = [];
      sagaGameSearchQuery = '';
      document.getElementById('sagaGameSearch').value = '';
      renderSagaGameSelector();
      renderAdminSagasList();
    });
    
    // Recherche fuzzy dans le s√©lecteur de jeux saga
    document.getElementById('sagaGameSearch')?.addEventListener('input', (e) => {
      sagaGameSearchQuery = e.target.value;
      renderSagaGameSelector(sagaGameSearchQuery);
    });

    function exitEditMode(){
      editIndex = null;
      addGameBtn.style.display = "";
      saveEditBtn.style.display = "none";
      cancelEditBtn.style.display = "none";
      gameName.value = "";
      gameMagnet.value = "";
      gameDirectLink.value = "";
      gameCover.value = "";
      trailerUrl.value = "";
      state.selectedCategories = [];
      selectedGameData = null;
      selectedGamePreview.classList.remove('show');
      
      // R√©initialiser les cat√©gories
      if (addCustomCat) addCustomCat.value = '';
      renderCategoriesList();
      
      renderCategories();
    }

    // Recherche dans l'admin
    gameSearchInput.addEventListener("input", () => {
      state.adminSearchQuery = gameSearchInput.value;
      renderAdminGamesList();
    });

    // Event Enter sur gameName pour lancer la recherche IGDB
    gameName.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchIGDBBtn.click();
      }
    });

    // SYST√àME IGDB
    searchIGDBBtn.addEventListener('click', async () => {
      const name = norm(gameName.value);
      
      if (!name) {
        toastMsg("‚ö†Ô∏è Entre d'abord un nom de jeu");
        return;
      }

      gameSelectorModal.classList.add('open');
      gameSelectorModal.setAttribute('aria-hidden', 'false');
      
      gameSelectorContent.innerHTML = `
        <div class="game-selector-loading">
          <div class="spinner"></div>
          <p>Recherche de "${name}" sur IGDB...</p>
        </div>
      `;

      try {
        const response = await fetch(`https://crackuzu-api.crackuzu.workers.dev/api/search-games?query=${encodeURIComponent(name)}`);
        
        if (!response.ok) {
          throw new Error('Erreur de recherche');
        }

        const data = await response.json();
        
        if (!data.games || data.games.length === 0) {
          gameSelectorContent.innerHTML = `
            <div class="game-selector-empty">
              <p style="font-size: 16px; margin-bottom: 8px;">üòï Aucun jeu trouv√©</p>
              <p style="font-size: 13px; opacity: 0.7;">Essayez avec un autre nom</p>
            </div>
          `;
          return;
        }

        renderGameSelector(data.games);

      } catch (error) {
        console.error('Search error:', error);
        gameSelectorContent.innerHTML = `
          <div class="game-selector-error">
            <p style="font-size: 16px; margin-bottom: 8px;">‚ùå Erreur de recherche</p>
            <p style="font-size: 13px;">${error.message}</p>
          </div>
        `;
      }
    });

    function renderGameSelector(games) {
      const listHTML = games.map(game => `
        <div class="game-selector-item" data-game-id="${game.id}" data-game-json='${JSON.stringify(game).replace(/'/g, "&apos;")}'>
          <div class="game-selector-cover">
            ${game.coverUrl ? `<img src="${game.coverUrl}" alt="${game.name}" />` : ''}
          </div>
          <div class="game-selector-info">
            <div class="game-selector-name">${game.name}</div>
            <div class="game-selector-meta">
              ${game.year ? `<span class="game-selector-year">${game.year}</span>` : ''}
              <span class="game-selector-type">${game.type}</span>
            </div>
          </div>
          <div class="game-selector-arrow">‚Üí</div>
        </div>
      `).join('');

      gameSelectorContent.innerHTML = `
        <div class="game-selector-list">
          ${listHTML}
        </div>
      `;

      document.querySelectorAll('.game-selector-item').forEach(item => {
        item.addEventListener('click', async () => {
          const gameData = JSON.parse(item.getAttribute('data-game-json'));
          await selectGame(gameData);
        });
      });
    }

    async function selectGame(gameData) {
      toastMsg("üì• R√©cup√©ration des d√©tails...");
      
      try {
        const response = await fetch(`https://crackuzu-api.crackuzu.workers.dev/api/game-details?id=${gameData.id}`);
        
        if (!response.ok) {
          throw new Error('Erreur de r√©cup√©ration');
        }

        const details = await response.json();
        
        selectedGameData = {
          name: details.name,
          cover34: details.cover34,
          categories: details.categories,
          igdbId: gameData.id,
          videoId: details.videoId
        };

        gameName.value = details.name;
        gameCover.value = details.cover34;
        
        // Auto-remplir le champ de recherche torrent et lancer la recherche auto avec IGDB ID
        search1337xInput.value = details.name;
        search1337x(details.name, gameData.id); // Lancer la recherche automatiquement avec IGDB ID
        
        state.selectedCategories = details.categories;
        
        // D√©clencher le preview manuellement apr√®s s√©lection IGDB
        const coverPreviewImgFix = document.getElementById('coverPreviewImg');
        const coverPlaceholderFix = document.getElementById('coverPlaceholder');
        if (coverPreviewImgFix && coverPlaceholderFix && details.cover34) {
          coverPreviewImgFix.src = details.cover34;
          coverPreviewImgFix.style.display = 'block';
          coverPlaceholderFix.style.display = 'none';
          coverPreviewImgFix.onload = function() {
            coverPreviewImgFix.style.display = 'block';
            coverPlaceholderFix.style.display = 'none';
          };
        }
        
        selectedGamePreview.classList.add('show');
        document.getElementById('selectedGameCover').src = details.cover34 || '';
        document.getElementById('selectedGameName').textContent = details.name;
        document.getElementById('selectedGameMeta').textContent = `${gameData.year ? gameData.year + ' ‚Ä¢ ' : ''}${gameData.type}`;
        
        // Rendre les cat√©gories liste
        renderCategoriesList();
        updateSelectedCategoriesDisplay();

        gameSelectorModal.classList.remove('open');
        gameSelectorModal.setAttribute('aria-hidden', 'true');
        
        toastMsg(`‚úÖ ${details.name} s√©lectionn√©`);

      } catch (error) {
        console.error('Select game error:', error);
        toastMsg("‚ùå Erreur lors de la s√©lection");
      }
    }

    gameSelectorClose.addEventListener('click', () => {
      gameSelectorModal.classList.remove('open');
      gameSelectorModal.setAttribute('aria-hidden', 'true');
    });

    gameSelectorModal.addEventListener('click', (e) => {
      if (e.target === gameSelectorModal) {
        gameSelectorModal.classList.remove('open');
        gameSelectorModal.setAttribute('aria-hidden', 'true');
      }
    });

    // Drag & Drop torrent - FIX: meilleure gestion des √©v√©nements
    torrentDropZone.addEventListener("click", (e) => {
      e.preventDefault();
      torrentFileInput.click();
    });

    // Emp√™cher le comportement par d√©faut du navigateur pour le drag & drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      torrentDropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    torrentDropZone.addEventListener("dragenter", (e) => {
      e.preventDefault();
      torrentDropZone.classList.add("dragover");
    });

    torrentDropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      torrentDropZone.classList.add("dragover");
    });

    torrentDropZone.addEventListener("dragleave", (e) => {
      e.preventDefault();
      // V√©rifier qu'on quitte vraiment la zone et pas un enfant
      if (!torrentDropZone.contains(e.relatedTarget)) {
        torrentDropZone.classList.remove("dragover");
      }
    });

    torrentDropZone.addEventListener("drop", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      torrentDropZone.classList.remove("dragover");
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.name.endsWith('.torrent')) {
          await handleTorrentFile(file);
        } else {
          toastMsg("‚ùå Veuillez d√©poser un fichier .torrent");
        }
      }
    });

    torrentFileInput.addEventListener("change", async (e) => {
      if (e.target.files.length > 0) {
        await handleTorrentFile(e.target.files[0]);
      }
    });

    // Event listeners pour 1337x search
    search1337xBtn.addEventListener("click", () => {
      search1337x(search1337xInput.value);
    });

    search1337xInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        search1337x(search1337xInput.value);
      }
    });

    async function handleTorrentFile(file) {
      try {
        toastMsg("üìÅ Analyse du torrent...");
        
        const arrayBuffer = await file.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        
        // Parser le torrent et extraire l'info hash
        const result = await parseTorrentAndExtractInfoHash(data);
        
        if (result && result.infoHash) {
          const name = result.name || "Unknown";
          const magnetLink = `magnet:?xt=urn:btih:${result.infoHash}&dn=${encodeURIComponent(name)}`;
          gameMagnet.value = magnetLink;
          toastMsg("‚úÖ Magnet extrait !");
          console.log("Magnet link:", magnetLink);
        } else {
          toastMsg("‚ùå Format torrent invalide");
          console.error("Parse result:", result);
        }
      } catch (error) {
        console.error("Torrent parse error:", error);
        toastMsg("‚ùå Erreur lecture torrent");
      }
    }

    // Parser Bencode avanc√© avec extraction de l'info hash
    async function parseTorrentAndExtractInfoHash(data) {
      let pos = 0;
      
      // Fonction pour lire un entier jusqu'√† un d√©limiteur
      function readInt(delimiter) {
        let start = pos;
        while (pos < data.length && data[pos] !== delimiter) {
          pos++;
        }
        const str = new TextDecoder().decode(data.slice(start, pos));
        pos++; // Skip delimiter
        return parseInt(str);
      }
      
      // Fonction pour parser r√©cursivement avec tracking des positions
      function parseValue() {
        if (pos >= data.length) return null;
        
        const byte = data[pos];
        
        if (byte === 0x69) { // 'i' - integer
          pos++;
          const value = readInt(0x65); // 'e'
          return { type: 'int', value };
        } 
        else if (byte === 0x6C) { // 'l' - list
          pos++;
          const items = [];
          while (pos < data.length && data[pos] !== 0x65) {
            items.push(parseValue());
          }
          pos++; // Skip 'e'
          return { type: 'list', items };
        }
        else if (byte === 0x64) { // 'd' - dictionary
          const startPos = pos;
          pos++;
          const dict = {};
          while (pos < data.length && data[pos] !== 0x65) {
            const keyObj = parseValue();
            if (keyObj && keyObj.type === 'string') {
              const key = keyObj.value;
              if (key === 'info') {
                // Capturer la position de d√©but de l'info dict
                const infoStart = pos;
                const value = parseValue();
                const infoEnd = pos;
                dict[key] = value;
                dict._infoStart = infoStart;
                dict._infoEnd = infoEnd;
              } else {
                dict[key] = parseValue();
              }
            }
          }
          pos++; // Skip 'e'
          return { type: 'dict', value: dict, start: startPos, end: pos };
        }
        else if (byte >= 0x30 && byte <= 0x39) { // digit - string
          const len = readInt(0x3A); // ':'
          const strData = data.slice(pos, pos + len);
          pos += len;
          
          // Essayer de d√©coder comme UTF-8, sinon garder comme bytes
          try {
            const str = new TextDecoder('utf-8', { fatal: false }).decode(strData);
            return { type: 'string', value: str, raw: strData };
          } catch {
            return { type: 'string', value: null, raw: strData };
          }
        }
        
        return null;
      }
      
      try {
        const root = parseValue();
        
        if (!root || root.type !== 'dict' || !root.value.info) {
          return null;
        }
        
        // Extraire les bytes bruts de l'info dictionary
        const infoStart = root.value._infoStart;
        const infoEnd = root.value._infoEnd;
        
        if (!infoStart || !infoEnd) {
          return null;
        }
        
        // Recalculer: on doit re-serialiser l'info dict pour avoir les bytes exacts
        // ou trouver la section info dans le fichier original
        const infoBytes = extractInfoSection(data, infoStart);
        
        if (!infoBytes) {
          return null;
        }
        
        // Calculer SHA-1
        const hashBuffer = await crypto.subtle.digest('SHA-1', infoBytes);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const infoHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        // Extraire le nom
        const info = root.value.info;
        let name = "Unknown";
        if (info && info.type === 'dict' && info.value.name) {
          name = info.value.name.value || "Unknown";
        }
        
        return { infoHash, name };
        
      } catch (e) {
        console.error("Parse error:", e);
        return null;
      }
    }
    
    // Extraire la section info du fichier torrent
    function extractInfoSection(data, startPos) {
      // L'info section commence avec 'd' et on doit trouver le 'e' correspondant
      if (data[startPos] !== 0x64) { // 'd'
        return null;
      }
      
      let pos = startPos + 1;
      let depth = 1;
      
      while (pos < data.length && depth > 0) {
        const byte = data[pos];
        
        if (byte === 0x64) { // 'd' - nouveau dict
          depth++;
          pos++;
        }
        else if (byte === 0x6C) { // 'l' - nouvelle liste
          depth++;
          pos++;
        }
        else if (byte === 0x65) { // 'e' - fin
          depth--;
          if (depth === 0) {
            pos++; // Include the 'e'
            break;
          }
          pos++;
        }
        else if (byte === 0x69) { // 'i' - integer
          pos++;
          while (pos < data.length && data[pos] !== 0x65) pos++;
          pos++; // Skip 'e'
        }
        else if (byte >= 0x30 && byte <= 0x39) { // string
          // Read length
          let lenStart = pos;
          while (pos < data.length && data[pos] !== 0x3A) pos++;
          const len = parseInt(new TextDecoder().decode(data.slice(lenStart, pos)));
          pos++; // Skip ':'
          pos += len; // Skip string content
        }
        else {
          pos++;
        }
      }
      
      return data.slice(startPos, pos);
    }

    // Fonction de recherche 1337x - AM√âLIOR√âE avec recherche par IGDB ID
    // Fonction de recherche 1337x - OPTIMIS√âE: 1 seule requ√™te pour auto-magnet
    async function search1337x(query, igdbId = null, retryCount = 0) {
      if (!query.trim() && !igdbId) {
        toastMsg("Veuillez entrer un nom de jeu");
        return;
      }
      
      const workerUrl = localStorage.getItem("worker_url") || "https://crackuzu-api.crackuzu.workers.dev";
      
      try {
        // ‚úÖ SI IGDB ID: 1 SEULE REQU√äTE AU LIEU DE 2
        if (igdbId) {
          toastMsg("üîç Recherche auto optimale...");
          search1337xResults.innerHTML = '<div style="padding: 12px; color: rgba(255,255,255,0.6);">Recherche en cours...</div>';
          
          const response = await fetch(`${workerUrl}/api/auto-magnet?id=${encodeURIComponent(igdbId)}`);
          
          if (response.status === 503) {
            throw new Error('RATE_LIMIT');
          }
          
          if (!response.ok) {
            throw new Error(`Erreur ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          if (!data.results || data.results.length === 0) {
            search1337xResults.innerHTML = `<div style="padding: 12px; color: rgba(255,255,255,0.6);">Aucun r√©sultat trouv√©</div>`;
            toastMsg("‚ùå Aucun r√©sultat");
            return;
          }
          
          // Afficher les r√©sultats
          let html = `<div style="padding: 8px 12px; margin-bottom: 12px; background: rgba(99, 102, 241, 0.2); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.4); font-size: 12px; color: rgba(255,255,255,0.8);">
            <strong>üéÆ ${escapeHtml(data.gameName)}</strong><br>
            <span style="font-size: 11px; opacity: 0.7;">Query: "${escapeHtml(data.searchQuery)}" (1 requ√™te)</span>
          </div>`;
          
          data.results.forEach((result, index) => {
            html += `
            <div style="padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
              <div style="font-weight: 600; margin-bottom: 6px; color: #fff; font-size: 13px;">${escapeHtml(result.name)}</div>
              <div style="display: flex; gap: 12px; font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 8px; flex-wrap: wrap; align-items: center;">
                <span>üì¶ ${result.size}</span>
                <span style="background: rgba(99, 102, 241, 0.3); color: #a5b4fc; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 500;">${escapeHtml(result.source || 'Unknown')}</span>
              </div>
              <button type="button" class="btn-primary use-magnet-btn" data-magnet="${escapeHtml(result.magnet)}" style="padding: 6px 12px; font-size: 12px; width: 100%;">
                üìã Utiliser ce magnet
              </button>
            </div>
            `;
          });
          
          search1337xResults.innerHTML = html;
          toastMsg(`‚úÖ ${data.count} r√©sultat(s) - 1 requ√™te seulement!`);
          
        } else {
          // Recherche manuelle normale
          toastMsg("üîç Recherche manuelle...");
          search1337xResults.innerHTML = '<div style="padding: 12px; color: rgba(255,255,255,0.6);">Recherche en cours...</div>';
          
          const response = await fetch(`${workerUrl}/api/search1337x?q=${encodeURIComponent(query)}`);
          
          if (response.status === 503) {
            throw new Error('RATE_LIMIT');
          }
          
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          if (!data.results || data.results.length === 0) {
            search1337xResults.innerHTML = `<div style="padding: 12px; color: rgba(255,255,255,0.6);">Aucun r√©sultat trouv√© pour "${query}"</div>`;
            toastMsg("‚ùå Aucun r√©sultat");
            return;
          }
          
          // Afficher les r√©sultats
          let html = `<div style="padding: 8px 12px; margin-bottom: 12px; background: rgba(99, 102, 241, 0.2); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.4); font-size: 12px; color: rgba(255,255,255,0.8);">
            <strong>üîç Recherche: Manuel</strong><br>
            <span style="font-size: 11px; opacity: 0.7;">Query: "${escapeHtml(query)}"</span>
          </div>`;
          
          data.results.forEach((result, index) => {
            html += `
            <div style="padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
              <div style="font-weight: 600; margin-bottom: 6px; color: #fff; font-size: 13px;">${escapeHtml(result.name)}</div>
              <div style="display: flex; gap: 12px; font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 8px; flex-wrap: wrap; align-items: center;">
                <span>üì¶ ${result.size}</span>
                <span style="background: rgba(99, 102, 241, 0.3); color: #a5b4fc; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 500;">${escapeHtml(result.source || 'Unknown')}</span>
              </div>
              <button type="button" class="btn-primary use-magnet-btn" data-magnet="${escapeHtml(result.magnet)}" style="padding: 6px 12px; font-size: 12px; width: 100%;">
                üìã Utiliser ce magnet
              </button>
            </div>
            `;
          });
          
          search1337xResults.innerHTML = html;
          toastMsg(`‚úÖ ${data.count} r√©sultat(s)`);
        }
        
        // Ajouter les event listeners sur les boutons
        document.querySelectorAll('.use-magnet-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const magnet = e.target.dataset.magnet;
            gameMagnet.value = magnet;
            toastMsg("‚úÖ Magnet copi√© dans le champ");
            search1337xResults.innerHTML = '';
            search1337xInput.value = '';
          });
        });
        
      } catch (error) {
        console.error("Search error:", error);
        
        if (error.message === 'RATE_LIMIT' && retryCount < 3) {
          const waitTime = 5000 * Math.pow(2, retryCount);
          toastMsg(`‚è≥ Rate limit, retry dans ${waitTime/1000}s...`);
          search1337xResults.innerHTML = `<div style="padding: 12px; color: #fbbf24;">‚è≥ Pause ${waitTime/1000}s...</div>`;
          
          await new Promise(resolve => setTimeout(resolve, waitTime));
          return search1337x(query, igdbId, retryCount + 1);
        }
        
        search1337xResults.innerHTML = `<div style="padding: 12px; color: #ff6b6b;">Erreur: ${escapeHtml(error.message)}</div>`;
        toastMsg("‚ùå Erreur recherche");
      }
    }

    // Helper pour √©chapper le HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Cloudinary upload
    async function uploadImageToCloudinary(file) {
      try {
        toastMsg("üì§ Upload image...");
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
          {
            method: 'POST',
            body: formData
          }
        );

        if (!response.ok) {
          throw new Error('Upload failed');
        }

        const result = await response.json();
        return result.secure_url || null;
      } catch (error) {
        console.error('Cloudinary error:', error);
        toastMsg("‚ùå Erreur upload");
        return null;
      }
    }

    // Paste image functionality
    pasteImageBtn.addEventListener("click", async () => {
      await pasteImageFromClipboard();
    });
    
    // Support Ctrl+V global pour coller des images
    document.addEventListener('keydown', async (e) => {
      // V√©rifier si Ctrl+V est press√© et que le modal admin est ouvert
      if ((e.ctrlKey || e.metaKey) && e.key === 'v' && adminModal.classList.contains('open')) {
        // Ne pas interf√©rer si on est dans un champ de texte (sauf gameCover)
        const activeElement = document.activeElement;
        const isInTextField = activeElement && (
          activeElement.tagName === 'INPUT' || 
          activeElement.tagName === 'TEXTAREA'
        );
        
        // Si on est dans un champ texte qui n'est pas gameCover, laisser le comportement par d√©faut
        if (isInTextField && activeElement.id !== 'gameCover') {
          return;
        }
        
        e.preventDefault();
        await pasteImageFromClipboard();
      }
    });
    
    // Fonction pour coller l'image depuis le presse-papier
    async function pasteImageFromClipboard() {
      if (!navigator.clipboard) {
        toastMsg("‚ùå Clipboard API non support√©e");
        return;
      }
      
      try {
        const clipboardItems = await navigator.clipboard.read();
        
        for (const item of clipboardItems) {
          for (const type of item.types) {
            if (type.startsWith('image/')) {
              const blob = await item.getType(type);
              const file = new File([blob], "pasted-image.png", { type: blob.type });
              
              toastMsg("üì§ Upload en cours...");
              const imageUrl = await uploadImageToCloudinary(file);
              
              if (imageUrl) {
                gameCover.value = imageUrl;
                // D√©clencher l'√©v√©nement input pour mettre √† jour le preview
                gameCover.dispatchEvent(new Event('input'));
                toastMsg("‚úÖ Image coll√©e et upload√©e!");
              } else {
                toastMsg("‚ùå √âchec de l'upload");
              }
              return;
            }
          }
        }
        
        toastMsg("‚ùå Pas d'image dans le presse-papier");
      } catch (error) {
        console.error("Paste error:", error);
        toastMsg("‚ùå Impossible de lire le presse-papier");
      }
    }

    // Ajouter une cat√©gorie manuellement
    addCatManualBtn.addEventListener("click", () => {
      const catNameValue = upper(addCustomCat.value);
      
      if (!catNameValue) {
        toastMsg("Nom de cat√©gorie vide");
        return;
      }
      
      // Ajouter √† la liste globale si elle n'existe pas
      if (!state.data.categories.includes(catNameValue)) {
        state.data.categories.push(catNameValue);
        state.data.categories.sort();
        saveLocalDraft();
        renderCategories();
        renderAdminLists();
      }
      
      // Ajouter aux cat√©gories s√©lectionn√©es si pas d√©j√†
      if (!state.selectedCategories.includes(catNameValue)) {
        state.selectedCategories.push(catNameValue);
      }
      
      // Vider l'input
      addCustomCat.value = '';
      
      // Re-rendre la liste
      renderCategoriesList();
      updateSelectedCategoriesDisplay();
      toastMsg(`Cat√©gorie "${catNameValue}" ajout√©e`);
    });

    // Permettre l'ajout avec la touche Entr√©e
    addCustomCat.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        addCatManualBtn.click();
      }
    });

    // Event listeners de l'ancien input de recherche supprim√©s - remplac√©s par l'overlay immersif

    addCatBtn.addEventListener("click", () => {
      const name = upper(catName.value);
      if(!name) return toastMsg("Cat√©gorie vide");
      if(name === "ALL") return toastMsg("ALL est r√©serv√©");
      if(state.data.categories.includes(name)) return toastMsg("D√©j√† existe");

      state.data.categories.push(name);
      catName.value = "";
      saveLocalDraft();
      renderCategories();
      renderAdminLists();
      renderCategoriesList();
      updateStats();
      toastMsg("Cat√©gorie ajout√©e");
    });

    addGameBtn.addEventListener("click", () => {
      if(editIndex !== null) return toastMsg("Mode modif actif");

      const name = norm(gameName.value);
      const magnet = norm(gameMagnet.value).replaceAll("&amp;", "&");
      const directLink = norm(gameDirectLink.value);
      const cover = norm(gameCover.value);
      const trailerUrlValue = norm(trailerUrl.value);
      const manualVideoId = extractYouTubeId(trailerUrlValue);

      if(!name) return toastMsg("Nom manquant");
      if(!magnet && !directLink) return toastMsg("Magnet ou lien direct requis");
      if(magnet && !magnet.startsWith("magnet:")) return toastMsg("Magnet invalide");
      if(!cover) return toastMsg("Cover manquante");
      if(state.selectedCategories.length === 0) return toastMsg("Pas de cat√©gories");

      state.selectedCategories.forEach(cat => {
        if(!state.data.categories.includes(cat)){
          state.data.categories.push(cat);
        }
      });

      state.data.games.unshift({ 
        name, 
        categories: [...state.selectedCategories], 
        magnet, 
        directLink,
        cover,
        igdbId: selectedGameData?.igdbId || null,
        videoId: manualVideoId || selectedGameData?.videoId || null
      });

      gameName.value = "";
      gameMagnet.value = "";
      gameDirectLink.value = "";
      gameCover.value = "";
      trailerUrl.value = "";
      state.selectedCategories = [];
      selectedGameData = null;
      selectedGamePreview.classList.remove('show');
      if (addCustomCat) addCustomCat.value = '';

      saveLocalDraft();
      renderGames();
      renderCategories();
      renderAdminLists();
      renderCategoriesList();
      updateStats();
      toastMsg("Jeu ajout√©");
    });

    saveEditBtn.addEventListener("click", () => {
      if(editIndex === null) return;

      const name = norm(gameName.value);
      const magnet = norm(gameMagnet.value).replaceAll("&amp;", "&");
      const directLink = norm(gameDirectLink.value);
      const cover = norm(gameCover.value);
      const trailerUrlValue = norm(trailerUrl.value);
      const manualVideoId = extractYouTubeId(trailerUrlValue);

      if(!name) return toastMsg("Nom manquant");
      if(!magnet && !directLink) return toastMsg("Magnet ou lien direct requis");
      if(magnet && !magnet.startsWith("magnet:")) return toastMsg("Magnet invalide");
      if(!cover) return toastMsg("Cover manquante");
      if(state.selectedCategories.length === 0) return toastMsg("Pas de cat√©gories");

      state.selectedCategories.forEach(cat => {
        if(!state.data.categories.includes(cat)){
          state.data.categories.push(cat);
        }
      });

      state.data.games[editIndex] = { 
        name, 
        categories: [...state.selectedCategories], 
        magnet, 
        directLink,
        cover,
        igdbId: selectedGameData?.igdbId || state.data.games[editIndex]?.igdbId || null,
        videoId: manualVideoId || state.data.games[editIndex]?.videoId || null
      };

      saveLocalDraft();
      renderGames();
      renderCategories();
      renderAdminLists();
      renderCategoriesList();
      updateStats();
      exitEditMode();
      toastMsg("Modif sauvegard√©e");
    });

    cancelEditBtn.addEventListener("click", exitEditMode);

    // Export/Import
    exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "data.json";
      a.click();
      toastMsg("Export r√©ussi");
    });

    importBtn.addEventListener("click", () => filePick.click());
    
    filePick.addEventListener("change", async () => {
      const f = filePick.files?.[0];
      filePick.value = "";
      if(!f) return;
      try{
        const text = await f.text();
        const json = sanitizeData(JSON.parse(text));
        state.data = json;
        saveLocalDraft();
        renderCategories();
        renderGames();
        renderAdminLists();
        renderCategoriesList();
        updateStats();
        exitEditMode();
        toastMsg("Import OK");
      }catch{
        toastMsg("Import invalide");
      }
    });

    resetBtn.addEventListener("click", () => {
      const ok = confirm("Reset local ? Toutes les modifications non publi√©es seront perdues.");
      if(!ok) return;
      localStorage.removeItem(LOCAL_KEY);
      localStorage.removeItem(LOCAL_KEY + "_lastModified");
      toastMsg("Draft supprim√©");
      init();
      closeAdminModal();
    });

    adminEntry.addEventListener("click", () => {
      const pwd = prompt("Admin password:");
      if(pwd === ADMIN_PASSWORD){
        state.adminUnlocked = true;
        adminPill.style.display = "inline-flex";
        toastMsg("Admin unlocked");
        openAdmin();
      }else{
        toastMsg("Wrong password");
      }
    });

    function openAdmin(){
      adminModal.classList.add("open");
      adminModal.setAttribute("aria-hidden", "false");
      renderAdminLists();
      renderCategoriesList();
      updateStats();
    }
    
    function closeAdminModal(){
      adminModal.classList.remove("open");
      adminModal.setAttribute("aria-hidden", "true");
      state.adminSearchQuery = "";
      gameSearchInput.value = "";
    }

    closeAdmin.addEventListener("click", closeAdminModal);
    adminModal.addEventListener("click", (e) => { if(e.target === adminModal) closeAdminModal(); });
    window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeAdminModal(); });

    // FONCTION INIT
    async function init(){
      console.log("üéÆ CRACKUZU - Initialisation...");
      setStateMessage("Chargement des jeux...");

      try {
        const data = await loadDataFromRepo();
        
        if (data && data.games && data.games.length > 0) {
          console.log(`‚úÖ ${data.games.length} jeux charg√©s depuis data.json`);
          state.data = data;
          setStateMessage(`‚úÖ ${data.games.length} jeux charg√©s`);
          setTimeout(() => setStateMessage(""), 2000);
        } else {
          const localDraft = loadLocalDraft();
          if (localDraft && localDraft.games && localDraft.games.length > 0) {
            console.log(`üì¶ ${localDraft.games.length} jeux charg√©s depuis le draft local`);
            state.data = localDraft;
            setStateMessage(`üì¶ ${localDraft.games.length} jeux (draft local)`);
            setTimeout(() => setStateMessage(""), 2000);
          } else {
            console.warn("‚ö†Ô∏è Aucun jeu trouv√©. La biblioth√®que est vide.");
            setStateMessage("üì≠ Aucun jeu trouv√©. Ajoutez-en via le panneau admin.");
          }
        }
      } catch (error) {
        console.error("‚ùå Erreur lors du chargement:", error);
        setStateMessage("‚ùå Erreur de chargement. V√©rifiez la console.");
      }

      state.activeCat = "ALL";
      state.query = "";
      // L'ancien input de recherche a √©t√© remplac√© par l'overlay immersif

      editIndex = null;
      exitEditMode();

      renderCategories();
      renderGames();
      renderAdminLists();
      renderCategoriesList();
      updateStats();
      
      // INITIALISER LE PREVIEW DE LA COVER
      setupCoverPreview();
      
      console.log("‚úÖ Initialisation termin√©e");
    }

    // FONCTION POUR LE PREVIEW DE LA COVER - CORRIG√â
    function setupCoverPreview() {
      const gameCoverInput = document.getElementById('gameCover');
      const coverPreviewImg = document.getElementById('coverPreviewImg');
      const coverPlaceholder = document.getElementById('coverPlaceholder');
      
      if (!gameCoverInput || !coverPreviewImg || !coverPlaceholder) return;
      
      function updatePreview() {
        const url = gameCoverInput.value.trim();
        
        if (url) {
          // R√©initialiser l'image avant de changer la source
          coverPreviewImg.style.display = 'none';
          coverPlaceholder.style.display = 'block';
          
          // Petit d√©lai pour forcer le re-render
          setTimeout(() => {
            coverPreviewImg.src = url;
            coverPreviewImg.onload = function() {
              coverPreviewImg.style.display = 'block';
              coverPlaceholder.style.display = 'none';
            };
            coverPreviewImg.onerror = function() {
              coverPreviewImg.style.display = 'none';
              coverPlaceholder.style.display = 'block';
            };
          }, 10);
        } else {
          coverPreviewImg.style.display = 'none';
          coverPlaceholder.style.display = 'block';
        }
      }
      
      // Event input pour changements manuels
      gameCoverInput.addEventListener('input', updatePreview);
      
      // Event paste pour mise √† jour imm√©diate apr√®s collage
      gameCoverInput.addEventListener('paste', function(e) {
        setTimeout(updatePreview, 10);
      });
      
      // D√©clencher une premi√®re fois au cas o√π il y a d√©j√† une valeur
      updatePreview();
    }

    // D√©marrer l'application
    init();

    // ===== EFFET SCROLL HEADER GLASS =====
    const header = document.querySelector('header');
    let lastScrollY = 0;
    
    window.addEventListener('scroll', () => {
      const scrollY = window.scrollY;
      if (scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
      lastScrollY = scrollY;
    }, { passive: true });

    // ===== EFFET PARALLAX SOURIS MULTI-COUCHES =====
    const parallaxBg = document.getElementById('parallaxBg');
    let mouseX = 0;
    let mouseY = 0;
    let currentX = 0;
    let currentY = 0;
    
    document.addEventListener('mousemove', (e) => {
      mouseX = (e.clientX / window.innerWidth - 0.5) * -120;
      mouseY = (e.clientY / window.innerHeight - 0.5) * -80;
    });
    
    function updateParallax() {
      currentX += (mouseX - currentX) * 0.08;
      currentY += (mouseY - currentY) * 0.08;
      
      // Fond principal
      parallaxBg.style.transform = `translate(${currentX}px, ${currentY}px) scale(1.1)`;
      
      // Parallax sur les sections de jeux (inverse plus subtil)
      const gameSections = document.querySelectorAll('.category-section');
      gameSections.forEach((section, i) => {
        const offset = (i % 2 === 0 ? 1 : -1) * 5;
        section.style.transform = `translate(${currentX * 0.3 + offset}px, ${currentY * 0.2}px)`;
      });
      
      // Parallax sur les cartes individuelles
      const cards = document.querySelectorAll('.game-card');
      cards.forEach((card, i) => {
        const delay = i * 0.01;
        const x = currentX * 0.5 * (1 + delay);
        const y = currentY * 0.3 * (1 + delay);
        card.style.transform = `translate(${x}px, ${y}px)`;
      });
      
      // Parallax sur la sidebar
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) {
        sidebar.style.transform = `translate(${currentX * 0.15}px, ${currentY * 0.1}px)`;
      }
      
      requestAnimationFrame(updateParallax);
    }
    updateParallax();

    // ===== RECHERCHE IMMERSIVE MASTERCLASS =====
    const searchOverlay = document.getElementById('searchOverlay');
    const searchTrigger = document.getElementById('searchTrigger');
    const immersiveSearchInput = document.getElementById('immersiveSearchInput');
    const closeSearchOverlay = document.getElementById('closeSearchOverlay');
    const searchResults = document.getElementById('searchResults');

    let searchSelectedIndex = -1;
    let currentSearchResults = [];

    // Ouvrir l'overlay de recherche
    searchTrigger.addEventListener('click', () => {
      searchOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      setTimeout(() => {
        immersiveSearchInput.focus();
      }, 100);
    });

    // Fermer l'overlay
    function closeSearch() {
      searchOverlay.classList.remove('active');
      document.body.style.overflow = '';
      immersiveSearchInput.value = '';
      searchResults.innerHTML = '';
      searchSelectedIndex = -1;
    }

    closeSearchOverlay.addEventListener('click', closeSearch);

    // Fermer avec √âchap
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && searchOverlay.classList.contains('active')) {
        closeSearch();
      }
      // Ouvrir avec Ctrl+K ou Cmd+K
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        searchOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
          immersiveSearchInput.focus();
        }, 100);
      }
    });

    // Fermer en cliquant sur le fond
    searchOverlay.addEventListener('click', (e) => {
      if (e.target === searchOverlay) {
        closeSearch();
      }
    });

    // ===== ALGORITHME FUZZY SEARCH AVEC TOL√âRANCE AUX FAUTES =====
    
    // Calcul de la distance de Levenshtein (√©dition)
    function levenshteinDistance(str1, str2) {
      const m = str1.length;
      const n = str2.length;
      const d = [];
      
      if (m === 0) return n;
      if (n === 0) return m;
      
      for (let i = 0; i <= m; i++) {
        d[i] = [];
        d[i][0] = i;
      }
      
      for (let j = 0; j <= n; j++) {
        d[0][j] = j;
      }
      
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
          d[i][j] = Math.min(
            d[i - 1][j] + 1,      // suppression
            d[i][j - 1] + 1,      // insertion
            d[i - 1][j - 1] + cost // substitution
          );
        }
      }
      
      return d[m][n];
    }

    // Normaliser une cha√Æne (enlever accents, espaces, etc.)
    function normalizeString(str) {
      return str
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // enlever accents
        .replace(/[^a-z0-9]/g, '')        // garder uniquement lettres et chiffres
        .trim();
    }

    // Calculer le score de similarit√© fuzzy
    function fuzzyScore(query, target) {
      const normalizedQuery = normalizeString(query);
      const normalizedTarget = normalizeString(target);
      
      if (normalizedQuery === normalizedTarget) return 1000; // match exact
      
      // V√©rifier si query est contenu dans target
      if (normalizedTarget.includes(normalizedQuery)) {
        return 900 + (normalizedQuery.length / normalizedTarget.length) * 100;
      }
      
      // V√©rifier les sous-s√©quences (abr√©viations)
      let subsequenceMatch = true;
      let queryIndex = 0;
      for (let i = 0; i < normalizedTarget.length && queryIndex < normalizedQuery.length; i++) {
        if (normalizedTarget[i] === normalizedQuery[queryIndex]) {
          queryIndex++;
        }
      }
      if (queryIndex === normalizedQuery.length) {
        return 700 + (normalizedQuery.length / normalizedTarget.length) * 100;
      }
      
      // Distance de Levenshtein normalis√©e
      const distance = levenshteinDistance(normalizedQuery, normalizedTarget);
      const maxLen = Math.max(normalizedQuery.length, normalizedTarget.length);
      const similarity = 1 - (distance / maxLen);
      
      // Score bas√© sur la similarit√©
      if (similarity > 0.7) return 500 + similarity * 100;
      if (similarity > 0.5) return 300 + similarity * 100;
      if (similarity > 0.3) return 100 + similarity * 100;
      
      // V√©rifier les mots individuellement
      const queryWords = query.toLowerCase().split(/\s+/);
      const targetWords = target.toLowerCase().split(/\s+/);
      let wordMatchScore = 0;
      
      for (const qWord of queryWords) {
        for (const tWord of targetWords) {
          if (tWord.includes(qWord)) {
            wordMatchScore += 50;
          } else {
            const wordDist = levenshteinDistance(qWord, tWord);
            const wordMaxLen = Math.max(qWord.length, tWord.length);
            const wordSim = 1 - (wordDist / wordMaxLen);
            if (wordSim > 0.6) {
              wordMatchScore += wordSim * 30;
            }
          }
        }
      }
      
      return Math.max(0, wordMatchScore);
    }

    // Recherche fuzzy dans les jeux ET les sagas
    // Les jeux d√©j√† dans des sagas ne sont PAS affich√©s individuellement
    function fuzzySearch(query, games, sagas = []) {
      if (!query || query.trim() === '') return [];
      
      const results = [];
      
      // Collecter tous les jeux qui sont d√©j√† dans des sagas
      const gamesInSagas = new Set();
      sagas.forEach(saga => {
        if (saga.games) {
          saga.games.forEach(gameName => gamesInSagas.add(gameName));
        }
      });
      
      // Recherche dans les jeux (SEULEMENT ceux qui ne sont pas dans une saga)
      for (const game of games) {
        // SKIP si le jeu est d√©j√† dans une saga
        if (gamesInSagas.has(game.name)) continue;
        
        const nameScore = fuzzyScore(query, game.name);
        
        // Bonus pour les cat√©gories
        let categoryScore = 0;
        if (game.categories && Array.isArray(game.categories)) {
          for (const cat of game.categories) {
            const catScore = fuzzyScore(query, cat);
            categoryScore = Math.max(categoryScore, catScore * 0.5);
          }
        }
        
        const totalScore = Math.max(nameScore, categoryScore);
        
        if (totalScore > 0) {
          results.push({
            game,
            score: totalScore,
            matchType: nameScore >= categoryScore ? 'name' : 'category',
            type: 'game'
          });
        }
      }
      
      // Recherche dans les sagas
      for (const saga of sagas) {
        const sagaNameScore = fuzzyScore(query, saga.name);
        
        // V√©rifier aussi dans les jeux de la saga
        let sagaGameScore = 0;
        if (saga.games) {
          for (const gameName of saga.games) {
            const game = games.find(g => g.name === gameName);
            if (game) {
              const gameNameScore = fuzzyScore(query, game.name);
              sagaGameScore = Math.max(sagaGameScore, gameNameScore * 0.8);
            }
          }
        }
        
        const sagaTotalScore = Math.max(sagaNameScore, sagaGameScore);
        
        if (sagaTotalScore > 0) {
          results.push({
            saga,
            score: sagaTotalScore,
            matchType: sagaNameScore >= sagaGameScore ? 'saga_name' : 'saga_game',
            type: 'saga'
          });
        }
      }
      
      // Trier par score d√©croissant
      results.sort((a, b) => b.score - a.score);
      
      return results;
    }

    // Formater la date de sortie
    function formatReleaseDate(dateStr) {
      if (!dateStr) return null;
      
      // Si c'est juste une ann√©e
      if (/^\d{4}$/.test(dateStr)) {
        return dateStr;
      }
      
      // Essayer de parser la date
      try {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString('fr-FR', { 
            year: 'numeric', 
            month: 'short',
            day: 'numeric'
          });
        }
      } catch (e) {
        // ignore
      }
      
      return dateStr;
    }

    // Afficher les r√©sultats de recherche
    function renderSearchResults(results) {
      if (results.length === 0) {
        searchResults.innerHTML = `
          <div class="search-empty">
            <div class="search-empty-icon">üîç</div>
            <p>Aucun jeu trouv√©</p>
            <p style="font-size: 13px; opacity: 0.6; margin-top: 8px;">Essayez avec une autre orthographe</p>
          </div>
        `;
        return;
      }
      
      const maxScore = results[0].score;
      
      const html = results.map((result, index) => {
        const { score, type } = result;
        const isTopMatch = score >= maxScore * 0.9;
        const animationDelay = 0.05 + (index * 0.06);
        
        if (type === 'saga') {
          // Affichage pour une saga
          const { saga } = result;
          const firstGame = state.data.games.find(g => g.name === saga.games[0]);
          const cover = firstGame ? firstGame.cover : '';
          
          return `
            <div class="search-result-item ${index === searchSelectedIndex ? 'selected' : ''} saga-search-result" 
                 data-index="${index}" 
                 data-saga="${encodeURIComponent(JSON.stringify(saga))}"
                 style="animation-delay: ${animationDelay}s; border-left: 3px solid #FFD700;">
              <div class="search-result-cover" style="position: relative;">
                <img src="${cover || ''}" alt="${saga.name}" 
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22533%22 viewBox=%220 0 400 533%22%3E%3Crect width=%22400%22 height=%22533%22 fill=%22%23222%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22white%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3E${saga.name.substring(0, 20)}%3C/text%3E%3C/svg%3E'" />
                <span style="position: absolute; top: 5px; right: 5px; background: linear-gradient(135deg, #FFD700, #FF8C00); color: #000; font-size: 10px; padding: 2px 6px; border-radius: 999px; font-weight: 700;">SAGA</span>
              </div>
              <div class="search-result-info">
                <div class="search-result-name" style="color: #FFD700;">‚ú¶ ${saga.name}</div>
                <div class="search-result-meta">
                  <span class="search-result-year">${saga.games.length} jeux</span>
                  <div class="search-result-categories">
                    <span class="search-result-cat" style="background: rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.4); color: #FFD700;">Saga</span>
                  </div>
                </div>
              </div>
              ${isTopMatch ? '<span class="search-result-match">Meilleure correspondance</span>' : ''}
            </div>
          `;
        } else {
          // Affichage pour un jeu
          const { game } = result;
          const matchPercent = Math.round((score / 1000) * 100);
          
          // Extraire la date de sortie
          let releaseYear = null;
          if (game.igdbId) {
            releaseYear = game.releaseDate || game.year || null;
          }
          
          const categories = (game.categories || []).slice(0, 3);
          
          return `
            <div class="search-result-item ${index === searchSelectedIndex ? 'selected' : ''}" 
                 data-index="${index}" 
                 data-game="${encodeURIComponent(JSON.stringify(game))}"
                 style="animation-delay: ${animationDelay}s">
              <div class="search-result-cover">
                <img src="${game.cover || ''}" alt="${game.name}" 
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22533%22 viewBox=%220 0 400 533%22%3E%3Crect width=%22400%22 height=%22533%22 fill=%22%23222%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22white%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3E${game.name.substring(0, 20)}%3C/text%3E%3C/svg%3E'" />
              </div>
              <div class="search-result-info">
                <div class="search-result-name">${game.name}</div>
                <div class="search-result-meta">
                  ${releaseYear ? `<span class="search-result-year">${formatReleaseDate(releaseYear)}</span>` : ''}
                  <div class="search-result-categories">
                    ${categories.map(cat => `<span class="search-result-cat">${cat}</span>`).join('')}
                  </div>
                </div>
              </div>
              ${isTopMatch ? '<span class="search-result-match">Meilleure correspondance</span>' : ''}
            </div>
          `;
        }
      }).join('');
      
      searchResults.innerHTML = html;
      
      // Ajouter les √©v√©nements de clic
      document.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          if (item.dataset.saga) {
            // C'est une saga
            const sagaData = JSON.parse(decodeURIComponent(item.dataset.saga));
            closeSearch();
            openSagaModal(sagaData);
          } else if (item.dataset.game) {
            // C'est un jeu
            const gameData = JSON.parse(decodeURIComponent(item.dataset.game));
            window.location.href = `game.html?name=${encodeURIComponent(gameData.name)}`;
          }
        });
      });
    }

    // Gestion de la recherche en temps r√©el
    let searchDebounceTimer;
    immersiveSearchInput.addEventListener('input', () => {
      clearTimeout(searchDebounceTimer);
      const query = immersiveSearchInput.value.trim();
      
      if (query === '') {
        searchResults.innerHTML = '';
        searchSelectedIndex = -1;
        return;
      }
      
      searchDebounceTimer = setTimeout(() => {
        const games = state.data?.games || [];
        const sagas = state.data?.sagas || [];
        currentSearchResults = fuzzySearch(query, games, sagas);
        renderSearchResults(currentSearchResults);
        searchSelectedIndex = -1;
      }, 150);
    });

    // Navigation clavier dans les r√©sultats
    immersiveSearchInput.addEventListener('keydown', (e) => {
      const items = document.querySelectorAll('.search-result-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (searchSelectedIndex < items.length - 1) {
          searchSelectedIndex++;
          updateSelection(items);
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (searchSelectedIndex > 0) {
          searchSelectedIndex--;
          updateSelection(items);
        }
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (searchSelectedIndex >= 0 && items[searchSelectedIndex]) {
          items[searchSelectedIndex].click();
        } else if (items.length > 0) {
          items[0].click();
        }
      }
    });

    function updateSelection(items) {
      items.forEach((item, index) => {
        if (index === searchSelectedIndex) {
          item.style.background = 'linear-gradient(90deg, rgba(100, 140, 255, 0.2) 0%, rgba(100, 140, 255, 0.1) 50%, transparent 100%)';
          item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          item.style.background = '';
        }
      });
    }

    // ===== FONCTIONS IMPORT BATCH =====
    let batchImportRunning = false;
    let batchImportCancelled = false;

    const batchGamesInput = document.getElementById('batchGamesInput');
    const startBatchImportBtn = document.getElementById('startBatchImportBtn');
    const stopBatchImportBtn = document.getElementById('stopBatchImportBtn');
    const batchProgress = document.getElementById('batchProgress');
    const batchProgressBar = document.getElementById('batchProgressBar');
    const batchProgressText = document.getElementById('batchProgressText');
    const batchProgressPercent = document.getElementById('batchProgressPercent');
    const batchStatsSuccess = document.getElementById('batchStatsSuccess');
    const batchStatsSkipped = document.getElementById('batchStatsSkipped');
    const batchStatsFailed = document.getElementById('batchStatsFailed');
    const batchLog = document.getElementById('batchLog');
    const batchResult = document.getElementById('batchResult');
    const batchResultContent = document.getElementById('batchResultContent');
    const clearBatchLogBtn = document.getElementById('clearBatchLogBtn');
    const batchSkipExisting = document.getElementById('batchSkipExisting');
    const batchSkipNoMagnet = document.getElementById('batchSkipNoMagnet');

    // Effacer le log
    clearBatchLogBtn.addEventListener('click', () => {
      batchLog.innerHTML = '<div style="color: rgba(255,255,255,0.4);">Log effac√©...</div>';
    });

    // Arr√™ter l'import
    stopBatchImportBtn.addEventListener('click', () => {
      batchImportCancelled = true;
      logBatch('‚èπÔ∏è Arr√™t demand√© par l\'utilisateur...', 'warning');
    });

    // D√©marrer l'import batch
    startBatchImportBtn.addEventListener('click', async () => {
      const input = batchGamesInput.value.trim();
      if (!input) {
        toastMsg('‚ö†Ô∏è Veuillez entrer des noms de jeux');
        return;
      }

      // Parser les noms de jeux
      const gameNames = input.split(';').map(n => n.trim()).filter(n => n.length > 0);
      if (gameNames.length === 0) {
        toastMsg('‚ö†Ô∏è Aucun nom de jeu valide trouv√©');
        return;
      }

      // Initialiser l'√©tat
      batchImportRunning = true;
      batchImportCancelled = false;
      startBatchImportBtn.style.display = 'none';
      stopBatchImportBtn.style.display = '';
      batchProgress.style.display = 'block';
      batchResult.style.display = 'none';
      batchLog.innerHTML = '';

      let successCount = 0;
      let skippedCount = 0;
      let failedCount = 0;
      const addedGames = [];
      const skippedGames = [];
      const failedGames = [];

      logBatch(`üöÄ D√©marrage de l'import de ${gameNames.length} jeux...`, 'info');
      logBatch('');

      const workerUrl = localStorage.getItem("worker_url") || "https://crackuzu-api.crackuzu.workers.dev";

      for (let i = 0; i < gameNames.length; i++) {
        if (batchImportCancelled) {
          logBatch('‚èπÔ∏è Import annul√©.', 'warning');
          break;
        }

        const gameName = gameNames[i];
        const progress = Math.round(((i + 1) / gameNames.length) * 100);
        
        updateBatchProgress(progress, `Traitement: ${gameName} (${i + 1}/${gameNames.length})`);
        logBatch(`[${i + 1}/${gameNames.length}] üîç ${gameName}`, 'info');

        try {
          logBatch('   ‚Üí Recherche IGDB...', 'muted');
          const searchResponse = await fetch(`${workerUrl}/api/search-games?query=${encodeURIComponent(gameName)}`);
          
          if (!searchResponse.ok) {
            throw new Error('Erreur recherche IGDB');
          }

          const searchData = await searchResponse.json();
          
          if (!searchData.games || searchData.games.length === 0) {
            logBatch('   ‚ùå Pas trouv√© sur IGDB', 'error');
            failedCount++;
            failedGames.push({ name: gameName, reason: 'Non trouv√© sur IGDB' });
            continue;
          }

          // Prendre le premier r√©sultat
          const firstGame = searchData.games[0];
          logBatch(`   ‚úì Trouv√©: ${firstGame.name}`, 'success');

          // V√©rifier si le jeu existe d√©j√†
          const existingGame = state.data.games.find(g => 
            g.name.toLowerCase() === firstGame.name.toLowerCase() ||
            (g.igdbId && g.igdbId === firstGame.id)
          );

          if (existingGame) {
            logBatch('   ‚è≠ Jeu d√©j√† existant', 'warning');
            if (batchSkipExisting.checked) {
              skippedCount++;
              skippedGames.push({ name: firstGame.name, reason: 'D√©j√† existant' });
              continue;
            }
          }

          // √âtape 2: R√©cup√©rer les d√©tails du jeu
          logBatch('   ‚Üí R√©cup√©ration des d√©tails...', 'muted');
          const detailsResponse = await fetch(`${workerUrl}/api/game-details?id=${firstGame.id}`);
          
          if (!detailsResponse.ok) {
            throw new Error('Erreur d√©tails IGDB');
          }

          const details = await detailsResponse.json();
          logBatch(`   ‚úì Cover et cat√©gories r√©cup√©r√©es`, 'success');

          // √âtape 3: Recherche magnet - NOUVEAU FLOW 1 requ√™te via /api/auto-magnet
          let magnet = null;
          let magnetFound = false;
          let magnetRetries = 0;
          const maxMagnetRetries = 3;
          
          while (magnetRetries < maxMagnetRetries && !magnetFound) {
            try {
              logBatch(`   ‚Üí Recherche magnet optimis√©e (tentative ${magnetRetries + 1}/${maxMagnetRetries})...`, 'muted');
              
              // 1 SEULE requ√™te qui fait tout : IGDB + recherche magnet
              const response = await fetch(`${workerUrl}/api/auto-magnet?id=${firstGame.id}`);
              
              if (response.status === 503) {
                logBatch('   ‚ö†Ô∏è Erreur 503 d√©tect√©e (rate limiting)', 'warning');
                logBatch('   ‚è≥ Pause de 1 minute...', 'warning');
                await new Promise(resolve => setTimeout(resolve, 60000));
                magnetRetries++;
                continue;
              }
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
              }
              
              const data = await response.json();
              
              if (data.error) {
                throw new Error(data.error);
              }
              
              if (data.results && data.results.length > 0) {
                magnet = data.results[0].magnet;
                magnetFound = true;
                logBatch(`   ‚úì Magnet trouv√© (${data.results[0].source})`, 'success');
              } else {
                logBatch(`   ‚ö†Ô∏è Pas de r√©sultat pour "${data.searchQuery}"`, 'warning');
              }
              
              if (!magnetFound && magnetRetries < maxMagnetRetries - 1) {
                const backoffMs = 3000 * Math.pow(2, magnetRetries);
                logBatch(`   ‚ö†Ô∏è Retry dans ${backoffMs/1000}s...`, 'warning');
                await new Promise(resolve => setTimeout(resolve, backoffMs));
              }
            } catch (magnetError) {
              logBatch(`   ‚ùå Erreur: ${magnetError.message}`, 'warning');
              
              if (magnetError.message.includes('fetch') || 
                  magnetError.message.includes('network') ||
                  magnetError.message.includes('Failed') ||
                  magnetRetries >= 1) {
                logBatch('   ‚è≥ Pause de 1 minute (erreur r√©seau)...', 'warning');
                await new Promise(resolve => setTimeout(resolve, 60000));
              } else if (magnetRetries < maxMagnetRetries - 1) {
                const backoffMs = 3000 * Math.pow(2, magnetRetries);
                logBatch(`   ‚ö†Ô∏è Retry dans ${backoffMs/1000}s...`, 'warning');
                await new Promise(resolve => setTimeout(resolve, backoffMs));
              }
            }
            magnetRetries++;
          }

          if (!magnetFound) {
            logBatch('   ‚ùå Pas de magnet trouv√©', 'error');
            if (batchSkipNoMagnet.checked) {
              skippedCount++;
              skippedGames.push({ name: firstGame.name, reason: 'Pas de magnet' });
              continue;
            }
          }

          // √âtape 4: Ajouter le jeu
          const categories = details.categories || ['ACTION'];
          
          // S'assurer que les cat√©gories existent dans la liste globale
          categories.forEach(cat => {
            if (!state.data.categories.includes(cat)) {
              state.data.categories.push(cat);
            }
          });

          const newGame = {
            name: details.name,
            categories: categories,
            magnet: magnet || '',
            cover: details.cover34 || '',
            igdbId: firstGame.id,
            videoId: details.videoId || null
          };

          state.data.games.unshift(newGame);
          successCount++;
          addedGames.push(details.name);
          logBatch(`   ‚úÖ AJOUT√â: ${details.name}`, 'success');

          // Sauvegarder apr√®s chaque jeu ajout√©
          saveLocalDraft();
          updateStats();

        } catch (error) {
          logBatch(`   ‚ùå Erreur: ${error.message}`, 'error');
          failedCount++;
          failedGames.push({ name: gameName, reason: error.message });
        }

        logBatch('');
        
        // Pause longue tous les 7 jeux pour √©viter le rate limiting Cloudflare (503)
        if ((i + 1) % 7 === 0 && i < gameNames.length - 1) {
          logBatch('   ‚è≥ Pause longue (30s) pour √©viter le rate limiting...', 'warning');
          await new Promise(resolve => setTimeout(resolve, 30000));
        }
        // Pause normale de 12s entre chaque jeu
        else if (i < gameNames.length - 1) {
          logBatch('   ‚è≥ Pause de 12s...', 'muted');
          await new Promise(resolve => setTimeout(resolve, 12000));
        }
      }

      // Terminer
      batchImportRunning = false;
      startBatchImportBtn.style.display = '';
      stopBatchImportBtn.style.display = 'none';
      
      updateBatchStats(successCount, skippedCount, failedCount);
      
      // Afficher le r√©sum√©
      batchResult.style.display = 'block';
      batchResultContent.innerHTML = `
        <strong>üéÆ ${successCount} jeu(x) ajout√©(s)</strong><br>
        ${addedGames.map(g => `‚úì ${g}`).join('<br>')}
        ${skippedCount > 0 ? `<br><br><strong>‚è≠ ${skippedCount} ignor√©(s)</strong><br>${skippedGames.map(g => `‚Ä¢ ${g.name} (${g.reason})`).join('<br>')}` : ''}
        ${failedCount > 0 ? `<br><br><strong>‚úó ${failedCount} √©chou√©(s)</strong><br>${failedGames.map(g => `‚Ä¢ ${g.name} (${g.reason})`).join('<br>')}` : ''}
      `;

      logBatch('', 'info');
      logBatch(`‚úÖ Import termin√©: ${successCount} ajout√©s, ${skippedCount} ignor√©s, ${failedCount} √©chou√©s`, 'info');

      // Rafra√Æchir l'affichage
      renderCategories();
      renderGames();
      renderAdminLists();
      renderCategoriesList();

      toastMsg(`‚úÖ Import termin√©: ${successCount} ajout√©s`);
    });

    function logBatch(message, type = 'muted') {
      const div = document.createElement('div');
      div.textContent = message;
      
      const colors = {
        muted: 'rgba(255,255,255,0.4)',
        info: 'rgba(255,255,255,0.8)',
        success: '#4ade80',
        warning: '#fbbf24',
        error: '#f87171'
      };
      
      div.style.color = colors[type] || colors.muted;
      div.style.marginBottom = '2px';
      
      batchLog.appendChild(div);
      batchLog.scrollTop = batchLog.scrollHeight;
    }

    function updateBatchProgress(percent, text) {
      batchProgressBar.style.width = percent + '%';
      batchProgressPercent.textContent = percent + '%';
      batchProgressText.textContent = text;
    }

    function updateBatchStats(success, skipped, failed) {
      batchStatsSuccess.textContent = `‚úì ${success} ajout√©s`;
      batchStatsSkipped.textContent = `‚è≠ ${skipped} ignor√©s`;
      batchStatsFailed.textContent = `‚úó ${failed} √©chou√©s`;
    }
  </script>
</body>
</html>
